<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ‰“ã¡æ‰‹æ¤œè¨ãƒ„ãƒ¼ãƒ«ï½œæ”¯å‡ºé¡ã‚’å£²ä¸Šæ›ç®— â†’ æ‰“ã¡æ‰‹ã‚’æ¤œè¨</title>
  <meta name="description" content="æ”¯å‡ºé¡ã‚’é™ç•Œåˆ©ç›Šç‡ã§å£²ä¸Šæ›ç®—ã—ã€å˜ä¾¡ãƒ»æ•°é‡ãƒ»è‡ªå‹•åŒ–ã®ã©ã“ã§å›åã™ã‚‹ã‹ã‚’åŒã˜ç”»é¢ã§æ•´ç†ã—ã¾ã™ã€‚" />

  <link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="favicon192192.png">

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --brand:#578899;
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#17323a;
      --muted:#56707a;
      --line:rgba(23,50,58,.12);
      --soft:rgba(87,136,153,.10);
      --shadow:0 10px 28px rgba(20,40,50,.10);
      --r:16px;

      --danger:#b42318;
      --dangerSoft:rgba(180,35,24,.08);
      --focus:rgba(87,136,153,.45);
      
      /* New Action Color (Strong Brand) */
      --actionStrong: #466e7c; /* å°‘ã—æ¿ƒã„ç›®ã®ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height:1.55;
    }
    a{color:inherit}

    .top{position:static; background:var(--bg); border-bottom:1px solid var(--line);}
    .topin{
      max-width:980px; margin:0 auto;
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0;}
    .logo{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(87,136,153,.35);
      background:#fff;
      object-fit:cover;
      display:block;
      flex:0 0 auto;
    }
    .btxt{min-width:0}
    .bttl{font-weight:900; font-size:24px; line-height:1.15; letter-spacing:.02em;}
    @media (max-width:480px){
      .bttl{font-size:22px;}
    }
    .bsub{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .btns{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:12px;
      padding:9px 12px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.02);
      transition:.12s transform,.12s box-shadow,.12s border-color,.12s background;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 18px rgba(20,40,50,.08); border-color:rgba(87,136,153,.35)}
    .btn.primary{background:var(--soft); border-color:rgba(87,136,153,.35)}
    .btn.ghost{background:transparent}

    .btn.back{
      background:rgba(87,136,153,.14);
      border-color:rgba(87,136,153,.60);
      color:var(--text);
      font-weight:900;
      padding:10px 14px;
    }
    .btn.back:hover{
      background:rgba(87,136,153,.20);
      border-color:rgba(87,136,153,.75);
    }

    /* â˜…ä¿®æ­£ï¼šä¿å­˜ãƒœã‚¿ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (ãƒˆãƒ¼ãƒ³åˆã‚ã›) */
    .btn.save-card{
      background: var(--brand);
      border-color: var(--brand);
      color: #fff;
      box-shadow: 0 4px 12px rgba(87,136,153, 0.3);
    }
    .btn.save-card:hover{
      background: var(--actionStrong);
      border-color: var(--actionStrong);
      box-shadow: 0 8px 18px rgba(87,136,153, 0.45);
    }

    .btn:focus-visible,
    .avgBtn:focus-visible,
    summary:focus-visible{
      outline:3px solid var(--focus);
      outline-offset:2px;
      border-radius:12px;
    }

    .wrap{max-width:980px; margin:0 auto; padding:16px 14px 34px}
    .grid{display:grid; gap:12px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }
    h2{margin:0 0 6px; font-size:18px}
    .p{margin:6px 0 0; color:var(--muted)}

    .talk{
      margin:10px 0 0;
      border:1px solid rgba(87,136,153,.28);
      background:rgba(87,136,153,.06);
      border-radius:14px;
      padding:10px 12px;
      color:var(--muted);
      font-size:12px;
    }

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:760px){ .row{grid-template-columns:1fr} }

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px; font-weight:800}
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(23,50,58,.14);
      background:#fff;
      color:var(--text);
      font-size:16px;
      outline:none;
    }

    input::placeholder, textarea::placeholder{ color: rgba(86,112,122,.45); }
    input::-webkit-input-placeholder, textarea::-webkit-input-placeholder{ color: rgba(86,112,122,.45); }
    input::-moz-placeholder, textarea::-moz-placeholder{ color: rgba(86,112,122,.45); opacity:1; }
    input:-ms-input-placeholder, textarea:-ms-input-placeholder{ color: rgba(86,112,122,.45); }

    textarea{min-height:110px; resize:vertical}
    input:focus, textarea:focus{
      border-color:rgba(87,136,153,.55);
      box-shadow:0 0 0 4px rgba(87,136,153,.16);
    }
    .help{font-size:12px; color:var(--muted); margin-top:6px}
    .help a{ text-decoration:underline; text-underline-offset:2px; }

    .err{
      margin-top:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(180,35,24,.35);
      background:var(--dangerSoft);
      color:var(--danger);
      font-size:12px;
      font-weight:900;
      display:none;
    }
    .err.show{display:block;}

    .kpi{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px}
    @media (max-width:760px){ .kpi{grid-template-columns:1fr} }
    .k{
      border:1px solid rgba(23,50,58,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(87,136,153,.04);
    }
    .k .t{font-size:12px; color:var(--muted); font-weight:800}
    .k .v{font-size:18px; font-weight:900; margin-top:6px}
    .k .v.small{font-size:14px; font-weight:900; color:var(--muted)}

    .note{
      border:1px solid rgba(87,136,153,.28);
      background:rgba(87,136,153,.06);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }

    .avgWrap{margin-top:10px}
    .avgTitle{font-size:12px; color:var(--muted); font-weight:900; margin:0 0 8px}
    .avgGrid{display:flex; flex-wrap:wrap; gap:8px}
    .avgBtn{
      appearance:none;
      border:1px solid rgba(87,136,153,.22);
      background:rgba(87,136,153,.06);
      color:var(--text);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:.12s transform,.12s box-shadow,.12s border-color,.12s background;
      user-select:none;
      white-space:nowrap;
    }
    .avgBtn:hover{transform:translateY(-1px); box-shadow:0 10px 18px rgba(20,40,50,.08); border-color:rgba(87,136,153,.35)}
    .avgBtn.active{border-color:rgba(87,136,153,.65); background:rgba(87,136,153,.12)}
    .avgBtn[aria-pressed="true"]{border-color:rgba(87,136,153,.75); background:rgba(87,136,153,.14)}

    .chooser{
      margin-top:16px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:16px;
    }
    @media (max-width:900px){ .chooser{grid-template-columns:1fr} }
    .bigCard{
      border:2px solid rgba(87,136,153,.15);
      border-radius:20px;
      padding:20px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:180px;
      align-items:center;
      text-align:center;
      transition:all .2s ease;
      position:relative;
      cursor:pointer;
    }
    .bigCard:hover{
      border-color:var(--brand);
      background:rgba(87,136,153,.02);
      transform:translateY(-4px);
      box-shadow:0 12px 30px rgba(87,136,153,.15);
    }
    .bigCardIcon{
      font-size:38px;
      line-height:1;
      margin-bottom:4px;
    }
    .bigCard h3{margin:0; font-size:17px; font-weight:900}
    .bigCard p{margin:0; color:var(--muted); font-size:12px; line-height:1.5}
    .bigCard .grow{flex:1; width:100%}
    .bigCard .btn{width:100%; margin-top:8px;}

    .detail{
      margin-top:12px;
      border:1px solid rgba(23,50,58,.12);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }

    .detailHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;

      position:sticky;
      top:0;
      z-index:5;
      background:#fff;
      padding-top:2px;
      padding-bottom:8px;
      border-bottom:1px solid rgba(23,50,58,.10);
      margin-bottom:8px;
    }
    .detailHead h3{margin:0; font-size:16px}
    .detailHead .mini{margin:4px 0 0; color:var(--muted); font-size:12px}

    .kpi2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    @media (max-width:760px){ .kpi2{grid-template-columns:1fr} }
    .k2{
      border:1px solid rgba(23,50,58,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(87,136,153,.04);
    }
    .k2 .t{font-size:12px; color:var(--muted); font-weight:800}
    .k2 .v{font-size:16px; font-weight:900; margin-top:6px}
    .k2 .v.small{font-size:13px; font-weight:900; color:var(--muted)}
    .mutedLine{margin-top:8px; color:var(--muted); font-size:12px}

    details.fold{
      margin-top:10px;
      border:1px solid rgba(87,136,153,.22);
      background:rgba(87,136,153,.04);
      border-radius:14px;
      padding:8px 10px;
    }
    details.fold summary{
      cursor:pointer;
      font-weight:900;
      color:var(--text);
      font-size:13px;
      user-select:none;
      list-style:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    details.fold summary::-webkit-details-marker{ display:none; }
    details.fold summary:before{
      content:"â–¸";
      display:inline-block;
      transform:translateY(-1px);
      color:var(--muted);
    }
    details.fold[open] summary:before{
      content:"â–¾";
    }
    details.fold .inside{
      margin-top:8px;
    }

    .modalBack{
      position:fixed; inset:0; z-index:100;
      background:rgba(10,20,25,.35);
      display:none; align-items:center; justify-content:center;
      padding:14px;
    }
    .modal{
      width:min(1040px, 96vw);
      height:min(720px, 86vh);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(23,50,58,.14);
      box-shadow:0 18px 50px rgba(0,0,0,.18);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .modalTop{
      padding:10px 12px;
      border-bottom:1px solid rgba(23,50,58,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(246,248,251,.92);
    }
    .modalTitle{font-weight:900; font-size:13px; color:var(--text); min-width:0}
    .modalTitle span{color:var(--muted); font-weight:800; font-size:12px}
    .modalFrame{flex:1; background:#fff;}
    iframe{width:100%; height:100%; border:0; background:#fff;}
    .modalHint{
      padding:10px 12px;
      border-top:1px solid rgba(23,50,58,.10);
      color:var(--muted);
      font-size:12px;
      background:#fff;
    }

    .card-actions{padding-top:10px;}
    .action-row{display:flex; gap:10px; margin:6px 0; flex-wrap:wrap;}
    .action-row .btn{
      background:#eef7f9; color:#3f7c8e; border:1px solid #cfe3ea; box-shadow:none;
      padding:12px 14px; font-size:15px; border-radius:12px; flex:1 1 20%; white-space:nowrap;
    }
    .action-row .btn:hover{background:#e6f2f6;}
    
    /* â˜…ä¿®æ­£ï¼šä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼Solidï¼‰ */
    .action-row .btn.save-card{
       background: var(--brand); 
       color: white; 
       border-color: var(--brand);
       font-weight: 900;
    }
    .action-row .btn.save-card:hover{
       background: var(--actionStrong); 
       border-color: var(--actionStrong);
    }
    
    @media (max-width:760px){
      .action-row .btn{flex:1 1 45%;}
    }

    footer.mk-mini{
      margin:18px 4px 10px;
      text-align:center;
      color:#667;
      font-size:11px;
      line-height:1.6;
      white-space:normal;
      overflow-wrap:anywhere;
      text-overflow:clip;
    }
    footer.mk-mini a{
      color:inherit;
      text-decoration:underline;
      text-underline-offset:2px;
    }

    /* â˜…è»¢è¨˜ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast{
      position:fixed;
      left:50%;
      top:74px;
      transform:translateX(-50%) translateY(-8px);
      z-index:120;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(87,136,153,.35);
      background:#fff;
      box-shadow:0 12px 30px rgba(20,40,50,.12);
      font-size:13px;
      font-weight:900;
      color:var(--text);
      opacity:0;
      pointer-events:none;
      transition:.18s transform, .18s opacity;
      max-width:min(92vw, 560px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }

    @page { size: auto; margin: 12mm; }
    @media print{
      body{background:#fff}
      .btns, .modalBack, .toast, #btnSaveCard {display:none !important}
      .wrap{padding:0}
      .card{box-shadow:none; border:1px solid #ddd}
      .k, .k2{background:#fff}
      a{color:#000; text-decoration:none}
      textarea{min-height:140px}
      details.fold{border:1px solid #ddd; background:#fff;}
      details.fold summary:before{content:"";}
    }
  </style>
</head>

<body>
  <div class="top">
    <div class="topin">
      <div class="brand">
        <img class="logo" src="ãƒ­ã‚´.jpg" alt="ãƒ­ã‚´" />
        <div class="btxt">
          <div class="bttl">æ‰“ã¡æ‰‹æ¤œè¨ãƒ„ãƒ¼ãƒ«</div>
          <div class="bsub">æ”¯å‡ºé¡ã‚’å£²ä¸Šæ›ç®— â†’ æ‰“ã¡æ‰‹ã‚’æ¤œè¨</div>
        </div>
      </div>

      <div class="btns">
        <button class="btn primary" id="btnResetTop">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </div>

  <div class="toast" id="importToast" role="status" aria-live="polite">æ•°å­—ã‚’è»¢è¨˜ã—ã¾ã—ãŸ</div>

  <div class="wrap">
    <div class="grid">

      <section class="card">
        <h2>1. å£²ä¸Šæ›ç®—</h2>
        <div class="p">æ”¯å‡ºé¡ãŒã€Œå£²ä¸Šã«ç›´ã™ã¨ã©ã‚Œãã‚‰ã„ã‹ã€ã‚’ã€é™ç•Œåˆ©ç›Šç‡ã§æ•´ç†ã—ã¾ã™ã€‚</div>

        <div class="avgWrap">
          <div class="avgTitle">æ”¯å‡ºã®é »åº¦</div>
          <div class="avgGrid" id="spendModeGrid">
            <button type="button" class="avgBtn" id="modeMonthly">æ¯æœˆï¼ˆå›ºå®šè²»ï¼‰</button>
            <button type="button" class="avgBtn" id="modeYearly">å¹´é¡ï¼ˆå›ºå®šè²»ï¼‰</button>
            <button type="button" class="avgBtn" id="modeOnce">å˜ç™ºï¼ˆ1å›ï¼‰</button>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <div id="boxSpendMonthly">
              <label for="spendMonthly">æ”¯å‡ºé¡ï¼ˆå†† / æœˆï¼‰</label>
              <input id="spendMonthly" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š20,000" data-format="int" />
              <div class="help">ä¾‹ï¼šã‚µãƒ–ã‚¹ã‚¯ã€ä¿å®ˆæ–™ã€å›ºå®šè²»ã®å¢—åŠ ãªã©ã€‚</div>
              <div class="err" id="spendMonthlyErr" aria-live="polite"></div>
            </div>

            <div id="boxSpendYearly" style="display:none;">
              <label for="spendYearly">æ”¯å‡ºé¡ï¼ˆå†† / å¹´ï¼‰</label>
              <input id="spendYearly" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š240,000" data-format="int" />
              <div class="help">ä¾‹ï¼šå¹´é¡ä¿å®ˆæ–™ã€å¹´é–“å¥‘ç´„è²»ãªã©ã€‚</div>
              <div class="err" id="spendYearlyErr" aria-live="polite"></div>
            </div>

            <div id="boxSpendOnce" style="display:none;">
              <label for="spendOnce">æ”¯å‡ºé¡ï¼ˆå†† / 1å›ï¼‰</label>
              <input id="spendOnce" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š600,000" data-format="int" />
              <div class="err" id="spendOnceErr" aria-live="polite"></div>

              <div class="row" style="margin-top:10px;">
                <div>
                  <label for="recoveryMonths">å›åæœŸé–“ï¼ˆãƒ¶æœˆï¼‰</label>

                  <div class="avgWrap" style="margin-top:6px;">
                    <div class="avgGrid" id="recoveryChipGrid" aria-label="å›åæœŸé–“ãƒ—ãƒªã‚»ãƒƒãƒˆ"></div>
                    <div class="help">ã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›ã§ãã¾ã™ã€‚è‡ªç”±å…¥åŠ›ã‚‚å¯èƒ½ã§ã™ã€‚</div>
                  </div>

                  <input id="recoveryMonths" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š12" data-format="int" />
                  <div class="help">å˜ç™ºæ”¯å‡ºã‚’ã€ã“ã®æœŸé–“ã§å›åã™ã‚‹ã¨ä»®å®šã—ã¦ã€Œæœˆã‚ãŸã‚Šã®å›åç›®æ¨™ã€ã‚’å‡ºã—ã¾ã™ã€‚</div>
                  <div class="err" id="recoveryErr" aria-live="polite"></div>
                </div>
                <div>
                  <label>æœˆå‰²ã‚Šæ”¯å‡ºï¼ˆè‡ªå‹•ï¼‰</label>
                  <input id="spendMonthlyEqAuto" readonly placeholder="â€”" />
                </div>
              </div>
            </div>
          </div>

          <div>
            <label for="cmr">é™ç•Œåˆ©ç›Šç‡ï¼ˆ%ï¼‰</label>
            <input id="cmr" inputmode="decimal" pattern="[0-9.]*" placeholder="ä¾‹ï¼š30" data-format="decimal" />
            <div class="help">
              é™ç•Œåˆ©ç›Šç‡ã¯ã€
              <a href="é™ç•Œåˆ©ç›Šç‡ã®ç¢ºèªæ–¹æ³•ï¼ˆFXCï¼‰.mp4" target="_blank" rel="noopener">å¤‰å‹•æç›Šè¨ˆç®—æ›¸</a>
              ã‚‚ã—ãã¯
              <a href="getsuji.png" target="_blank" rel="noopener">æœˆæ¬¡æ±ºç®—é€Ÿå ±ã‚µãƒ¼ãƒ“ã‚¹</a>
              ã«ã¦ã”ç¢ºèªãã ã•ã„ã€‚
            </div>
            <div class="err" id="cmrErr" aria-live="polite"></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label for="annualSales">å¹´å•†ï¼ˆä»»æ„ / å††ï¼‰</label>
            <input id="annualSales" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š120,000,000" data-format="int" />
          </div>
          <div>
            <label>æœˆå•†ï¼ˆè‡ªå‹• / å¹´å•†Ã·12ï¼‰</label>
            <input id="monthlySalesAuto" readonly placeholder="â€”" />
          </div>
        </div>

        <div class="kpi">
          <div class="k">
            <div class="t" id="kpiT1">â€”</div>
            <div class="v" id="salesEqM">â€”</div>
          </div>
          <div class="k">
            <div class="t" id="kpiT2">â€”</div>
            <div class="v" id="salesEqY">â€”</div>
          </div>
          <div class="k">
            <div class="t" id="kpiT3">å¹´å•†ã«å ã‚ã‚‹å‰²åˆï¼ˆ%ï¼‰</div>
            <div class="v" id="shareY">â€”</div>
          </div>
        </div>

        <div class="note">
          å…¥åŠ›å€¤ã¯ã“ã®ç«¯æœ«å†…ã§è¨ˆç®—ã•ã‚Œã€é€ä¿¡ã•ã‚Œã¾ã›ã‚“ï¼ˆã“ã®ãƒšãƒ¼ã‚¸å˜ä½“ã§å®Œçµã—ã¾ã™ï¼‰ã€‚
        </div>
      </section>

      <section class="card">
        <h2>2. æ‰“ã¡æ‰‹ã‚’æ¤œè¨</h2>
        <div class="p">å£²ä¸Šæ›ç®—é¡ã‚’ã€Œã©ã†ã‚„ã£ã¦ä½œã‚‹ã‹ã€ã‚’3ã¤ã®æ–¹å‘ã‹ã‚‰æ¤œè¨ã—ã¾ã™ã€‚</div>

        <details class="fold" id="foldTalk">
          <summary>è£œè¶³ï¼ˆè€ƒãˆæ–¹ï¼‰</summary>
          <div class="inside">
            <div class="talk" id="talkMemo">
              ã€Œå£²ä¸Šæ›ç®—ï¼ˆæ”¯å‡ºé¡ Ã· é™ç•Œåˆ©ç›Šç‡ï¼‰ã§â€œå¿…è¦ãªå£²ä¸Šâ€ã‚’æƒãˆã¾ã—ãŸã€‚æ¬¡ã«ã€ã“ã‚Œã‚’ <b>å˜ä¾¡</b>ãƒ»<b>æ•°é‡</b>ãƒ»<b>è‡ªå‹•åŒ–</b> ã®ã©ã®æ–¹å‘ã§å›åã™ã‚‹ã‹ã‚’ä¸€ç·’ã«æ±ºã‚ã¾ã—ã‚‡ã†ã€‚ã€
            </div>
          </div>
        </details>

        <div id="routeChooser" class="chooser" aria-label="æ‰“ã¡æ‰‹ã®é¸æŠ">
          <div class="bigCard" data-target="price">
            <div class="bigCardIcon">ğŸ’</div>
            <div class="grow">
              <h3>å˜ä¾¡ã‚’ä¸Šã’ã‚‹</h3>
              <p>ä¾¡æ ¼ãƒ»å€¤ä»˜ã‘ãƒ»å®¢å±¤ãƒ»æä¾›ä¾¡å€¤ã®è¦‹ç›´ã—ã§ã€åŒã˜åŠ´åŠ›ã§åˆ©ç›Šã‚’å¢—ã‚„ã™æ–¹å‘ã§ã™ã€‚</p>
            </div>
            <button class="btn primary" data-pick="price">ã“ã®æ–¹å‘ã§æ·±æ˜ã‚Š</button>
          </div>

          <div class="bigCard" data-target="volume">
            <div class="bigCardIcon">ğŸ“¦</div>
            <div class="grow">
              <h3>æ•°é‡ã‚’ä¸Šã’ã‚‹</h3>
              <p>ã€Œå–å¼•å˜ä¾¡Ã—å–å¼•æ•°ã€ã®æ•´ç†ã§ã€å¿…è¦ãªè¿½åŠ ä»¶æ•°ã¨å…¥å£æ•°ã‚’æ•°å­—ã§è¦‹ãˆã‚‹åŒ–ã—ã¾ã™ã€‚</p>
            </div>
            <button class="btn primary" data-pick="volume">ã“ã®æ–¹å‘ã§æ·±æ˜ã‚Š</button>
          </div>

          <div class="bigCard" data-target="auto">
            <div class="bigCardIcon">âš™ï¸</div>
            <div class="grow">
              <h3>æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–</h3>
              <p>æ™‚é–“ã‚’ä½œã‚Šã€ãã®æ™‚é–“ã§ä»˜åŠ ä¾¡å€¤æ´»å‹•ã¸ç§»ã™æ–¹å‘ã§ã™ï¼ˆå›åã«å¿…è¦ãªå‰Šæ¸›æ™‚é–“ã®ç›®å®‰ãŒå‡ºã¾ã™ï¼‰ã€‚</p>
            </div>
            <button class="btn primary" data-pick="auto">ã“ã®æ–¹å‘ã§æ·±æ˜ã‚Š</button>
          </div>
        </div>

        <div id="routeDetail" class="detail" style="display:none;">
          <div class="detailHead">
            <div>
              <h3 id="detailTitle">â€”</h3>
              <div class="mini" id="detailSub">â€”</div>
            </div>
            <div class="btns">
              <button class="btn back" id="btnBack">3ã¤ã®æ‰“ã¡æ‰‹ã«æˆ»ã‚‹</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div id="detailInputA"></div>
            <div id="detailInputB"></div>
          </div>

          <div class="kpi2" id="detailKpi"></div>

          <div class="btns" style="margin-top:10px; justify-content:flex-start;">
            <button class="btn primary" id="btnOpenTool">é–¢é€£ãƒ„ãƒ¼ãƒ«ã§ç¢ºèªï¼ˆåŒä¸€ç”»é¢ï¼‰</button>
            <button class="btn" id="btnOpenToolNewTab">åˆ¥ã‚¿ãƒ–ã§é–‹ã</button>
          </div>

          <div class="mutedLine" id="detailHint"></div>
        </div>
      </section>

      <section class="card">
        <h2>3. æ¬¡ã®ä¸€æ‰‹</h2>
        <div class="p">ã€Œå®Ÿè¡Œï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã€ã¸è½ã¨ã—è¾¼ã‚€ãŸã‚ã®æ•´ç†ã§ã™ã€‚</div>

        <div class="row" style="margin-top:12px;">
          <div>
            <label>ä»Šå›ã®æ‰“ã¡æ‰‹ï¼ˆé¸æŠçµæœï¼‰</label>
            <input id="selectedRouteLabel" readonly value="ï¼ˆæœªé¸æŠï¼‰" />
          </div>
          <div>
            <label>å¯¾è±¡ï¼ˆå•†å“ / å®¢å±¤ / æ¥­å‹™ãªã©ï¼‰</label>
            <input id="targetScope" placeholder="ä¾‹ï¼šAå•†å“ã€æ—¢å­˜é¡§å®¢ã®æ›´æ–°å˜ä¾¡ã€è«‹æ±‚æ¥­å‹™ ãªã©" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>ç›®æ¨™ã¨ã™ã‚‹æˆæœï¼ˆæ•°å€¤ï¼‰</label>
            <input id="targetGoal" placeholder="ä¾‹ï¼šå£²ä¸Š+30ä¸‡å††ã€æ™‚é–“-10h ãªã©" />
            <div class="help">Step1-2ã§è©¦ç®—ã—ãŸæ•°å­—ã‚’ç›®æ¨™ã¨ã—ã¦è¨­å®šã—ã¾ã™ã€‚</div>
          </div>
          <div>
            <label>ç¢ºèªã™ã‚‹æŒ‡æ¨™ï¼ˆæœˆæ¬¡ã§è¦‹ã‚‹ã‚‚ã®ï¼‰</label>
            <input id="checkKpi" placeholder="ä¾‹ï¼šå¹³å‡å˜ä¾¡ã€ç²—åˆ©ç‡ã€ä»¶æ•°ã€æœˆæ¬¡ç¢ºå®šæ—¥ ãªã©" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>æœ€åˆã®ä¸€æ­©ï¼ˆæ˜æ—¥ã‚„ã‚‹ã“ã¨ï¼‰</label>
            <input id="firstAction" placeholder="ä¾‹ï¼šã€‡ã€‡ã•ã‚“ã«é›»è©±ã™ã‚‹ã€è³‡æ–™ã‚’å–ã‚Šå¯„ã›ã‚‹" />
            <div class="help">ã€Œ24æ™‚é–“ä»¥å†…ã«ã§ãã‚‹å…·ä½“çš„ãªè¡Œå‹•ã€ã‚’æ›¸ãã¾ã™ã€‚</div>
          </div>
          <div>
            <label>ãã®ãŸã‚ã«ã‚„ã‚ã‚‹ã“ã¨ï¼ˆåŠ£å¾Œé †ä½ï¼‰</label>
            <input id="stopDoing" placeholder="ä¾‹ï¼šå®šä¾‹ä¼šè­°ã€ç§»å‹•æ™‚é–“ã®ã‚¹ãƒãƒ›ã€ä¸è¦ãªå ±å‘Šæ›¸" />
            <div class="help">æ–°ã—ã„æ™‚é–“ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã€Œæ¨ã¦ã‚‹ã‚‚ã®ã€ã‚’æ±ºã‚ã¾ã™ã€‚</div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>æ¬¡å›ç¢ºèªæ—¥ / å ±å‘Šç›¸æ‰‹</label>
          <input id="nextCheck" placeholder="ä¾‹ï¼šæ¬¡å›å·¡å›ç›£æŸ»æ—¥ã€å¹¹éƒ¨MTGãªã©" />
          <div class="help">ã€Œã„ã¤ã€ã€Œèª°ã¨ã€æŒ¯ã‚Šè¿”ã‚‹ã‹ã‚’æ±ºã‚ã‚‹ã¨ã€å®Ÿè¡ŒåŠ›ãŒé«˜ã¾ã‚Šã¾ã™ã€‚</div>
        </div>

        <div style="margin-top:10px;">
          <label>è‡ªç”±è¨˜å…¥ï¼ˆãƒ¡ãƒ¢ï¼‰</label>
          <textarea id="freeMemo" placeholder="ä¾‹ï¼šå®Ÿæ–½æ‰‹é †ã€æ‹…å½“ã€æœŸé™ã€æƒ³å®šãƒªã‚¹ã‚¯ã¨å¯¾ç­–ãªã©"></textarea>
        </div>
      </section>

      <section class="card card-actions" aria-label="æ“ä½œ">
        <div class="action-row">
          <button id="btnSaveCard" class="btn save-card" type="button">ğŸ“¸ å®£è¨€ã‚·ãƒ¼ãƒˆã‚’ä¿å­˜</button>
          
          <button id="btnCopy" class="btn" type="button">è¦ç‚¹ã‚’ã‚³ãƒ”ãƒ¼</button>
          <button id="btnPrint" class="btn" type="button">å°åˆ· / PDFä¿å­˜</button>
          <button id="btnReset" class="btn" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </section>

      <footer class="mk-mini">
        Â© <span id="cpy-year">2025</span>
        <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">ç¨ç†å£«æ³•äººæ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€</a> ï½œ 
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ï½œ 
        <a href="/tool-portal/terms.html" target="_blank" rel="noopener">åˆ©ç”¨æ¡ä»¶</a> ï½œ 
        <span id="build-rev">r20</span>ï¼ˆ<span id="last-updated-date"></span>ï¼‰
      </footer>

    </div>

    <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="ãƒ„ãƒ¼ãƒ«è¡¨ç¤º">
      <div class="modal" role="document" aria-label="ãƒ„ãƒ¼ãƒ«æœ¬ä½“">
        <div class="modalTop">
          <div class="modalTitle" id="modalTitle">ãƒ„ãƒ¼ãƒ«ã‚’è¡¨ç¤º <span>ï¼ˆåŒä¸€ç”»é¢ï¼‰</span></div>
          <div class="btns">
            <button class="btn" id="btnOpenNewTab2">åˆ¥ã‚¿ãƒ–ã§é–‹ã</button>
            <button class="btn primary" id="btnClose">é–‰ã˜ã‚‹</button>
          </div>
        </div>
        <div class="modalFrame">
          <iframe id="toolFrame" title="tool"></iframe>
        </div>
        <div class="modalHint">
          ã‚‚ã—è¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€Œåˆ¥ã‚¿ãƒ–ã§é–‹ãã€ã‚’ã”åˆ©ç”¨ãã ã•ã„ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å´/ãƒ„ãƒ¼ãƒ«å´ã®åˆ¶é™ã§åŸ‹ã‚è¾¼ã¿è¡¨ç¤ºãŒã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>

  <div id="capture-area" style="position:fixed; left:-9999px; top:0; width:800px; height:800px; background-color:#fff; font-family:'Hiragino Sans', 'Noto Sans JP', sans-serif; color:#17323a; box-sizing:border-box;">
    <div style="width:100%; height:100%; padding:50px; display:flex; flex-direction:column; border:30px solid #2c3e50;">
       
       <div style="text-align:center; border-bottom:4px solid #578899; padding-bottom:20px; margin-bottom:30px;">
          <h2 style="font-size:48px; font-weight:900; color:#17323a; letter-spacing:0.05em; margin:0;">é»’å­—çµŒå–¶ã¸ã®è¡Œå‹•å®£è¨€</h2>
          <p style="font-size:16px; color:#578899; font-weight:bold; letter-spacing:0.2em; margin:5px 0 0;">ACTION DECLARATION</p>
       </div>
       
       <div style="flex:1; display:flex; flex-direction:column; gap:20px;">
          
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
             <div style="background:#f0f4f6; padding:15px; border-radius:12px;">
                <div style="font-size:14px; color:#56707a; font-weight:bold;">å¯¾è±¡ãƒ»ç¯„å›²</div>
                <div id="card-scope" style="font-size:20px; font-weight:bold; color:#17323a; margin-top:5px; line-height:1.3;">-</div>
             </div>
             <div style="background:#f0f4f6; padding:15px; border-radius:12px;">
                <div style="font-size:14px; color:#56707a; font-weight:bold;">ç›®æ¨™æˆæœ</div>
                <div id="card-goal" style="font-size:20px; font-weight:bold; color:#17323a; margin-top:5px; line-height:1.3;">-</div>
             </div>
          </div>
   
          <div style="background:#fff; border:4px solid #578899; border-radius:20px; padding:30px; text-align:center; flex-grow:1; display:flex; flex-direction:column; justify-content:center;">
             <div style="font-size:18px; color:#578899; font-weight:bold; margin-bottom:15px;">â–¼ ç§ã®æœ€åˆã®ä¸€æ­©ï¼ˆæ˜æ—¥ã‚„ã‚‹ã“ã¨ï¼‰</div>
             <div id="card-action" style="font-size:42px; font-weight:900; color:#17323a; line-height:1.4; max-height:240px; overflow:hidden;">æœªå…¥åŠ›</div>
          </div>
   
          <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;">
             <div style="background:#f9f9f9; padding:15px; border-radius:12px; border:1px solid #eee;">
                <div style="font-size:12px; color:#888; font-weight:bold;">ã‚„ã‚ã‚‹ã“ã¨</div>
                <div id="card-stop" style="font-size:16px; font-weight:bold; color:#555; margin-top:4px; line-height:1.3;">-</div>
             </div>
             <div style="background:#f9f9f9; padding:15px; border-radius:12px; border:1px solid #eee;">
                <div style="font-size:12px; color:#888; font-weight:bold;">ç¢ºèªæŒ‡æ¨™</div>
                <div id="card-kpi" style="font-size:16px; font-weight:bold; color:#555; margin-top:4px; line-height:1.3;">-</div>
             </div>
             <div style="background:#f9f9f9; padding:15px; border-radius:12px; border:1px solid #eee;">
                <div style="font-size:12px; color:#888; font-weight:bold;">æ¬¡å›ç¢ºèª</div>
                <div id="card-next" style="font-size:16px; font-weight:bold; color:#555; margin-top:4px; line-height:1.3;">-</div>
             </div>
          </div>
       </div>
       
       <div style="margin-top:30px; text-align:right; border-top:1px solid #ddd; padding-top:15px;">
           <div style="font-size:14px; color:#aaa;">Generated by <span style="font-weight:bold; color:#56707a;">æ¾æœ¬ä¼šè¨ˆ æ‰“ã¡æ‰‹æ¤œè¨ãƒ„ãƒ¼ãƒ«</span></div>
           <div id="card-date" style="font-size:12px; color:#ccc;"></div>
       </div>
    </div>
  </div>

  <script>
    const TOOL_URLS = {
      price:  "https://takatrp.github.io/price-up-down/",
      volume: "https://takatrp.github.io/hendou_PL_LP/",
      auto:   "https://takatrp.github.io/jidouka-kouka-LP/"
    };
    const TIME_UNIT_COST_URL = "https://takatrp.github.io/time-unit-cost/";

    const VOLUME_LABEL_SETS = {
      generic: {
        key:"generic",
        label:"æ±ç”¨ï¼ˆãŠã™ã™ã‚ï¼‰",
        txName:"å–å¼•",
        unitPriceLabel:"å–å¼•å˜ä¾¡ï¼ˆ1ä»¶ã‚ãŸã‚Šå£²ä¸Šï¼‰",
        unitShort:"ä»¶",
        entryLabel:"å…¥å£æ•°ï¼ˆå•ã„åˆã‚ã›/æ¥åº—/è¦‹ç© ç­‰ï¼‰",
        entryShort:"å…¥å£",
        convLabel:"æˆç´„ç‡ï¼ˆå…¥å£â†’å–å¼•ï¼‰",
        daysLabel:"ç¨¼åƒæ—¥æ•°ï¼ˆæœˆï¼‰",
        unitHelp:"ã€Œ1ä»¶ã‚ãŸã‚Šã®å£²ä¸Šã€ã§OKã§ã™ï¼ˆå®¢å˜ä¾¡/å—æ³¨å˜ä¾¡/å¥‘ç´„å˜ä¾¡/å‡ºè·å˜ä¾¡ãªã©ï¼‰ã€‚",
        entryHelp:"å…¥å£ã¯ã€å–å¼•ãŒç”Ÿã¾ã‚Œã‚‹å‰æ®µã®æ•°ã§ã™ï¼ˆå•ã„åˆã‚ã›ã€è¦‹ç©ã€å•†è«‡ã€æ¥åº—ãªã©ï¼‰ã€‚",
        convHelp:"å…¥å£ã®ã†ã¡ã€å–å¼•ã«ã¤ãªãŒã‚‹å‰²åˆï¼ˆæ¦‚ç®—ã§OKï¼‰ã€‚"
      },
      visit: {
        key:"visit",
        label:"æ¥åº—/å®¢æ•°å‹",
        txName:"è³¼å…¥",
        unitPriceLabel:"å®¢å˜ä¾¡ï¼ˆå††/äººï¼‰",
        unitShort:"äºº",
        entryLabel:"æ¥åº—æ•°ï¼ˆå…¥å£ï¼‰",
        entryShort:"æ¥åº—",
        convLabel:"è³¼å…¥ç‡ï¼ˆæ¥åº—â†’è³¼å…¥ï¼‰",
        daysLabel:"å–¶æ¥­æ—¥æ•°ï¼ˆæœˆï¼‰",
        unitHelp:"ã€Œ1äººã‚ãŸã‚Šã®å£²ä¸Šï¼ˆå®¢å˜ä¾¡ï¼‰ã€ã®ç›®å®‰ã§OKã§ã™ã€‚",
        entryHelp:"æ¥åº—æ•°ã‚’å…¥å£ã¨ã—ã¦æ‰±ã„ã¾ã™ï¼ˆå¿…è¦ãªã‚‰äºˆç´„/å•ã„åˆã‚ã›æ•°ã§ã‚‚OKï¼‰ã€‚",
        convHelp:"æ¥åº—ã®ã†ã¡è³¼å…¥ã«è‡³ã‚‹å‰²åˆï¼ˆæ¦‚ç®—ã§OKï¼‰ã€‚"
      },
      order: {
        key:"order",
        label:"å—æ³¨/æ¡ˆä»¶æ•°å‹",
        txName:"å—æ³¨",
        unitPriceLabel:"å—æ³¨å˜ä¾¡ï¼ˆå††/ä»¶ï¼‰",
        unitShort:"ä»¶",
        entryLabel:"å•†è«‡/è¦‹ç©æ•°ï¼ˆå…¥å£ï¼‰",
        entryShort:"å•†è«‡",
        convLabel:"å—æ³¨ç‡ï¼ˆå•†è«‡â†’å—æ³¨ï¼‰",
        daysLabel:"ç¨¼åƒæ—¥æ•°ï¼ˆæœˆï¼‰",
        unitHelp:"ã€Œ1ä»¶ã‚ãŸã‚Šå£²ä¸Šï¼ˆå—æ³¨å˜ä¾¡ï¼‰ã€ã®ç›®å®‰ã§OKã§ã™ã€‚",
        entryHelp:"å•†è«‡ãƒ»è¦‹ç©ãªã©ã€å—æ³¨å‰æ®µã®æ•°ã‚’å…¥å£ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚",
        convHelp:"å•†è«‡ï¼ˆå…¥å£ï¼‰ã®ã†ã¡ã€å—æ³¨ã«è‡³ã‚‹å‰²åˆï¼ˆæ¦‚ç®—ã§OKï¼‰ã€‚"
      },
      contract: {
        key:"contract",
        label:"å¥‘ç´„å‹",
        txName:"å¥‘ç´„",
        unitPriceLabel:"å¥‘ç´„å˜ä¾¡ï¼ˆå††/ä»¶ï¼‰",
        unitShort:"ä»¶",
        entryLabel:"ææ¡ˆ/ç›¸è«‡æ•°ï¼ˆå…¥å£ï¼‰",
        entryShort:"ææ¡ˆ",
        convLabel:"å¥‘ç´„ç‡ï¼ˆææ¡ˆâ†’å¥‘ç´„ï¼‰",
        daysLabel:"ç¨¼åƒæ—¥æ•°ï¼ˆæœˆï¼‰",
        unitHelp:"ã€Œ1å¥‘ç´„ã‚ãŸã‚Šã®å£²ä¸Šï¼ˆå˜ä¾¡ï¼‰ã€ã®ç›®å®‰ã§OKã§ã™ã€‚",
        entryHelp:"ææ¡ˆãƒ»ç›¸è«‡ãªã©ã€å¥‘ç´„å‰æ®µã®æ•°ã‚’å…¥å£ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚",
        convHelp:"å…¥å£ã®ã†ã¡å¥‘ç´„ã«è‡³ã‚‹å‰²åˆï¼ˆæ¦‚ç®—ã§OKï¼‰ã€‚"
      },
      shipment: {
        key:"shipment",
        label:"å‡ºè·/æ•°é‡å‹",
        txName:"å‡ºè·",
        unitPriceLabel:"å‡ºè·å˜ä¾¡ï¼ˆå††/å€‹ï¼‰",
        unitShort:"å€‹",
        entryLabel:"å¼•åˆã„æ•°ï¼ˆå…¥å£ï¼‰",
        entryShort:"å¼•åˆ",
        convLabel:"æˆç´„ç‡ï¼ˆå¼•åˆâ†’å‡ºè·ï¼‰",
        daysLabel:"ç¨¼åƒæ—¥æ•°ï¼ˆæœˆï¼‰",
        unitHelp:"ã€Œ1å€‹ã‚ãŸã‚Šã®å£²ä¸Šï¼ˆå˜ä¾¡ï¼‰ã€ã®ç›®å®‰ã§OKã§ã™ã€‚",
        entryHelp:"å¼•åˆã„ãªã©ã€å‡ºè·ã«è‡³ã‚‹å‰æ®µã®æ•°ã‚’å…¥å£ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚",
        convHelp:"å…¥å£ã®ã†ã¡ã€æˆç´„ã—ã¦å‡ºè·ã«è‡³ã‚‹å‰²åˆï¼ˆæ¦‚ç®—ã§OKï¼‰ã€‚"
      }
    };

    const RECOVERY_PRESETS = [3, 6, 12, 24];

    const KEY = "mk_action_tool_v4";
    const $ = (id)=>document.getElementById(id);

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã—ãŸå˜ä¾¡ã‚’ä¿æŒã™ã‚‹å¤‰æ•°ï¼ˆæ•°å€¤ or nullï¼‰
    let importedUnitPrice = null;
    // â˜…æœˆé–“è²©å£²æ•°é‡ï¼ˆå¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã‹ã‚‰å—ä¿¡ã—ãŸå ´åˆã«ä¿æŒï¼šæ•°å€¤ or nullï¼‰
    let importedMonthlyQty = null;

    // å¾©å…ƒä¸­ãƒ•ãƒ©ã‚°ï¼ˆå¾©å…ƒä¸­ã« persist ä¹±ç™ºã—ãªã„ï¼‰
    let IS_RESTORING = false;

    // modal
    let currentUrl = "";

    (function(){
      const yEl = $("cpy-year");
      const dEl = $("last-updated-date");
      const now = new Date();
      if (yEl) yEl.textContent = String(now.getFullYear());
      if (dEl) {
        const lm = new Date(document.lastModified);
        const pad = n => String(n).padStart(2,'0');
        dEl.textContent = `${lm.getFullYear()}-${pad(lm.getMonth()+1)}-${pad(lm.getDate())}`;
      }
    })();

    // =========================
    // æ­£è¦åŒ–ï¼ˆè¨˜å·æ··å…¥ã‚’å¼·ãå¸åï¼‰
    // =========================
    function normalizeDecimalText(s){
      let t = String(s ?? "").trim();
      t = t.replace(/[,ï¼Œ\s]/g,'').replace(/[ãƒ»]/g,'.').replace(/[ï¼…%]/g,'');
      t = t.replace(/[^0-9.]/g,'');
      const parts = t.split(".");
      if(parts.length > 2){
        t = parts[0] + "." + parts.slice(1).join("");
      }
      return t;
    }
    function stripNumberText(s){
      return String(s ?? "").trim().replace(/[,ï¼Œ\s]/g,'').replace(/[^\d]/g,'');
    }
    function num(v){
      const s = normalizeDecimalText(v);
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function yen(n){
      if(!Number.isFinite(n)) return "â€”";
      const r = Math.round(n);
      return "Â¥" + r.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function pct1(n){
      if(!Number.isFinite(n)) return "â€”";
      return (Math.round(n*10)/10).toString() + "%";
    }
    function ceil1(n){
      if(!Number.isFinite(n)) return "â€”";
      return (Math.ceil(n*10)/10).toString();
    }

    function showErr(id, msg){
      const el = $(id);
      if(!el) return;
      if(msg){
        el.textContent = msg;
        el.classList.add("show");
      }else{
        el.textContent = "";
        el.classList.remove("show");
      }
    }

    function formatInt(val){
      if(val === null || val === undefined) return "";
      if(typeof val === "number" && Number.isFinite(val)){
        const r = Math.round(val);
        return r.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }
      const s = String(val).replace(/[^\d]/g, "");
      if(!s) return "";
      return s.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function formatIntInput(el){
      if(!el) return;
      const raw = String(el.value ?? "");
      const caret = (el.selectionStart ?? raw.length);
      const digitsBefore = raw.slice(0, caret).replace(/[^\d]/g, "").length;
      const digits = raw.replace(/[^\d]/g, "");
      if(digits === ""){
        el.value = "";
        return;
      }
      const formatted = digits.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      el.value = formatted;

      try{
        let newCaret = 0;
        let count = 0;
        while(newCaret < formatted.length && count < digitsBefore){
          if(/\d/.test(formatted[newCaret])) count++;
          newCaret++;
        }
        el.setSelectionRange(newCaret, newCaret);
      }catch(e){}
    }

    function formatDecimalInput(el){
      if(!el) return;
      const raw = String(el.value ?? "");
      const caret = (el.selectionStart ?? raw.length);
      let normalized = raw.replace(/[,ï¼Œ\s]/g,'').replace(/[ãƒ»]/g,'.');
      normalized = normalized.replace(/[ï¼…%]/g,'');
      normalized = normalized.replace(/[^\d.]/g, "");
      const parts = normalized.split(".");
      if(parts.length > 2){
        normalized = parts[0] + "." + parts.slice(1).join("");
      }
      el.value = normalized;
      try{
        const newPos = Math.min(caret, el.value.length);
        el.setSelectionRange(newPos, newPos);
      }catch(e){}
    }

    function bindLiveFormatting(root=document){
      root.querySelectorAll('input[data-format="int"]').forEach(el=>{
        if(el.dataset.boundInt === "1") return;
        el.dataset.boundInt = "1";
        el.addEventListener("input", ()=>formatIntInput(el));
        el.addEventListener("blur",  ()=>formatIntInput(el));
      });
      root.querySelectorAll('input[data-format="decimal"]').forEach(el=>{
        if(el.dataset.boundDec === "1") return;
        el.dataset.boundDec = "1";
        el.addEventListener("input", ()=>formatDecimalInput(el));
        el.addEventListener("blur",  ()=>formatDecimalInput(el));
      });
    }

    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : {};
      }catch(e){ return {}; }
    }
    function save(state){
      try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){}
    }

    function persist(){
      if(IS_RESTORING) return;
      const state = {
        spendMode,
        selectedRoute,
        detailBuiltFor,
        volumeLabelKey,
        importedUnitPrice,
        importedMonthlyQty,
        fields: {
          spendMonthly: $("spendMonthly")?.value ?? "",
          spendYearly: $("spendYearly")?.value ?? "",
          spendOnce: $("spendOnce")?.value ?? "",
          recoveryMonths: $("recoveryMonths")?.value ?? "",
          cmr: $("cmr")?.value ?? "",
          annualSales: $("annualSales")?.value ?? "",

          // route detail inputsï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
          volumeUnitPrice: $("volumeUnitPrice")?.value ?? "",
          volumeConvRate: $("volumeConvRate")?.value ?? "",
          volumeDays: $("volumeDays")?.value ?? "",
          hourCostInput: $("hourCostInput")?.value ?? "",

          // Step3
          targetScope: $("targetScope")?.value ?? "",
          targetGoal: $("targetGoal")?.value ?? "",
          checkKpi: $("checkKpi")?.value ?? "",
          firstAction: $("firstAction")?.value ?? "",
          stopDoing: $("stopDoing")?.value ?? "",
          nextCheck: $("nextCheck")?.value ?? "",
          freeMemo: $("freeMemo")?.value ?? ""
        }
      };
      save(state);
    }

    function restore(st){
      if(!st || typeof st !== "object") return;

      IS_RESTORING = true;

      // 1) globals
      if(st.volumeLabelKey && VOLUME_LABEL_SETS[st.volumeLabelKey]) volumeLabelKey = st.volumeLabelKey;
      if(st.importedUnitPrice !== undefined) importedUnitPrice = st.importedUnitPrice;
      if(st.importedMonthlyQty !== undefined) importedMonthlyQty = st.importedMonthlyQty;

      // 2) spend mode firstï¼ˆUIåˆ‡æ›¿ãŒã‚ã‚‹ã®ã§å…ˆã«ï¼‰
      if(st.spendMode && ["monthly","yearly","once"].includes(st.spendMode)){
        setSpendMode(st.spendMode);
      }else{
        setSpendMode("monthly");
      }

      // 3) inputs
      const f = st.fields || {};
      if($("spendMonthly")) $("spendMonthly").value = f.spendMonthly ?? "";
      if($("spendYearly"))  $("spendYearly").value  = f.spendYearly ?? "";
      if($("spendOnce"))    $("spendOnce").value    = f.spendOnce ?? "";
      if($("recoveryMonths")) $("recoveryMonths").value = f.recoveryMonths ?? "";
      if($("cmr")) $("cmr").value = f.cmr ?? "";
      if($("annualSales")) $("annualSales").value = f.annualSales ?? "";

      if($("targetScope")) $("targetScope").value = f.targetScope ?? "";
      if($("targetGoal"))  $("targetGoal").value  = f.targetGoal ?? "";
      if($("checkKpi"))    $("checkKpi").value    = f.checkKpi ?? "";
      if($("firstAction")) $("firstAction").value = f.firstAction ?? "";
      if($("stopDoing"))   $("stopDoing").value   = f.stopDoing ?? "";
      if($("nextCheck"))   $("nextCheck").value   = f.nextCheck ?? "";
      if($("freeMemo"))    $("freeMemo").value    = f.freeMemo ?? "";

      // formatting
      bindLiveFormatting(document);
      document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
      document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);
      syncRecoveryChipsFromInput();

      // 4) routeï¼ˆæœ€å¾Œã«ï¼‰
      if(st.selectedRoute && ["price","volume","auto"].includes(st.selectedRoute)){
        setRoute(st.selectedRoute);
        // route inputs restore
        setTimeout(()=>{
          if($("volumeUnitPrice") && (f.volumeUnitPrice ?? "") !== "") $("volumeUnitPrice").value = f.volumeUnitPrice;
          if($("volumeConvRate")  && (f.volumeConvRate ?? "") !== "")  $("volumeConvRate").value  = f.volumeConvRate;
          if($("volumeDays")      && (f.volumeDays ?? "") !== "")      $("volumeDays").value      = f.volumeDays;

          if($("hourCostInput") && (f.hourCostInput ?? "") !== "") $("hourCostInput").value = f.hourCostInput;

          bindLiveFormatting(document);
          document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
          document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);

          updateRouteDetailKPIs();
        }, 0);
      }else{
        setRoute("");
      }

      IS_RESTORING = false;
    }

    let selectedRoute = "";
    let detailBuiltFor = "";
    let volumeLabelKey = "generic";
    let spendMode = "monthly";

    function volLabels(){
      return VOLUME_LABEL_SETS[volumeLabelKey] || VOLUME_LABEL_SETS.generic;
    }

    function setPressed(el, pressed){
      if(!el) return;
      el.setAttribute("aria-pressed", pressed ? "true" : "false");
    }

    function setSpendMode(mode){
      spendMode = mode;

      const ids = ["modeMonthly","modeYearly","modeOnce"];
      ids.forEach(id=>{
        const b = $(id);
        b.classList.remove("active");
        setPressed(b, false);
      });

      if(mode==="monthly"){ $("modeMonthly").classList.add("active"); setPressed($("modeMonthly"), true); }
      if(mode==="yearly"){  $("modeYearly").classList.add("active");  setPressed($("modeYearly"), true); }
      if(mode==="once"){    $("modeOnce").classList.add("active");    setPressed($("modeOnce"), true); }

      $("boxSpendMonthly").style.display = (mode==="monthly") ? "" : "none";
      $("boxSpendYearly").style.display  = (mode==="yearly")  ? "" : "none";
      $("boxSpendOnce").style.display    = (mode==="once")    ? "" : "none";

      if(mode==="once"){
        const raw = String($("recoveryMonths").value ?? "").trim();
        if(raw === ""){
          $("recoveryMonths").value = "12";
          formatIntInput($("recoveryMonths"));
        }
        syncRecoveryChipsFromInput();
      }

      render();
      persist();
    }

    function parseCmr(){
      const raw = String($("cmr").value ?? "").trim();
      if(raw === "") return { valid:false, cmrPct:NaN, cmr:NaN, raw };
      const cmrPct = num(raw);
      const valid = Number.isFinite(cmrPct) && cmrPct > 0 && cmrPct <= 100;
      return { valid, cmrPct, cmr: valid ? cmrPct/100 : NaN, raw };
    }

    function parseRecoveryMonths(){
      const raw = String($("recoveryMonths").value ?? "").trim();
      if(raw === "") return { valid:false, months:NaN, raw, reason:"æœªå…¥åŠ›" };
      const m = num(raw);
      const isInt = Number.isFinite(m) && Math.floor(m) === m;
      if(!isInt) return { valid:false, months:NaN, raw, reason:"æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„" };
      if(m < 1 || m > 120) return { valid:false, months:NaN, raw, reason:"1ã€œ120ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„" };
      return { valid:true, months:m, raw, reason:"" };
    }

    function compute(){
      const cmrInfo = parseCmr();

      const spendM = num($("spendMonthly").value);
      const spendY = num($("spendYearly").value);
      const spendO = num($("spendOnce").value);

      const annualSales = num($("annualSales").value);
      const monthlySalesAuto = (annualSales>0) ? (annualSales/12) : 0;

      let spendPerMonth = NaN;
      let recoveryInfo = { valid:true, months:NaN, raw:"", reason:"" };

      if(spendMode==="monthly"){
        spendPerMonth = (spendM>0) ? spendM : NaN;
      }else if(spendMode==="yearly"){
        spendPerMonth = (spendY>0) ? (spendY/12) : NaN;
      }else{
        recoveryInfo = parseRecoveryMonths();
        if(spendO>0 && recoveryInfo.valid){
          spendPerMonth = spendO / recoveryInfo.months;
        }else{
          spendPerMonth = NaN;
        }
      }

      const salesEqTargetM = (cmrInfo.valid && Number.isFinite(spendPerMonth)) ? (spendPerMonth / cmrInfo.cmr) : NaN;

      const salesEqAnnual = (cmrInfo.valid)
        ? (spendMode==="monthly" ? (Number.isFinite(salesEqTargetM)? salesEqTargetM*12 : NaN)
          : spendMode==="yearly" ? (spendY>0 ? (spendY / cmrInfo.cmr) : NaN)
          : NaN)
        : NaN;

      const salesEqTotal = (cmrInfo.valid && spendMode==="once" && spendO>0) ? (spendO / cmrInfo.cmr) : NaN;

      const shareY = (annualSales>0)
        ? (spendMode==="once"
            ? (Number.isFinite(salesEqTotal) ? (salesEqTotal/annualSales*100) : NaN)
            : (Number.isFinite(salesEqAnnual) ? (salesEqAnnual/annualSales*100) : NaN))
        : NaN;

      const needPricePct = (monthlySalesAuto>0 && Number.isFinite(salesEqTargetM))
        ? (salesEqTargetM/monthlySalesAuto*100)
        : NaN;

      return {
        cmrInfo,
        spendM, spendY, spendO,
        recoveryInfo,
        spendPerMonth,
        annualSales, monthlySalesAuto,
        salesEqTargetM, salesEqAnnual, salesEqTotal,
        shareY, needPricePct
      };
    }

    function buildRecoveryChips(){
      const grid = $("recoveryChipGrid");
      if(!grid) return;
      grid.innerHTML = "";
      RECOVERY_PRESETS.forEach(m=>{
        const b = document.createElement("button");
        b.type = "button";
        b.className = "avgBtn";
        b.id = "rec_" + m;
        b.textContent = `${m}ãƒ¶æœˆ`;
        setPressed(b, false);
        b.addEventListener("click", ()=>{
          $("recoveryMonths").value = String(m);
          formatIntInput($("recoveryMonths"));
          syncRecoveryChipsFromInput();
          render();
          persist();
        });
        grid.appendChild(b);
      });
      syncRecoveryChipsFromInput();
    }

    function syncRecoveryChipsFromInput(){
      const raw = String($("recoveryMonths").value ?? "").trim().replace(/[,ï¼Œ\s]/g,'').replace(/[^\d]/g,'');
      const v = raw ? Number(raw) : NaN;
      RECOVERY_PRESETS.forEach(m=>{
        const b = document.getElementById("rec_" + m);
        if(!b) return;
        const active = (Number.isFinite(v) && v === m);
        b.classList.toggle("active", active);
        setPressed(b, active);
      });
    }

    function buildVolumeLabelChips(container){
      const grid = document.createElement("div");
      grid.className = "avgGrid";
      Object.keys(VOLUME_LABEL_SETS).forEach(k=>{
        const item = VOLUME_LABEL_SETS[k];
        const b = document.createElement("button");
        b.type="button";
        b.className="avgBtn";
        b.dataset.vkey = item.key;
        b.textContent = item.label;
        b.classList.toggle("active", item.key===volumeLabelKey);
        setPressed(b, item.key===volumeLabelKey);

        b.addEventListener("click", ()=>{
          const keep = {
            unitPrice: $("volumeUnitPrice") ? $("volumeUnitPrice").value : "",
            convRate: $("volumeConvRate") ? $("volumeConvRate").value : "",
            days: $("volumeDays") ? $("volumeDays").value : ""
          };
          volumeLabelKey = item.key;
          detailBuiltFor = "";
          buildRouteDetailUI();
          if($("volumeUnitPrice")) $("volumeUnitPrice").value = keep.unitPrice;
          if($("volumeConvRate")) $("volumeConvRate").value = keep.convRate;
          if($("volumeDays")) $("volumeDays").value = keep.days;

          bindLiveFormatting(document);
          document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
          document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);

          updateRouteDetailKPIs();
          persist();
        });
        grid.appendChild(b);
      });
      container.appendChild(grid);
    }

    function validateStep1Errors(c){
      if(c.cmrInfo.raw !== "" && !c.cmrInfo.valid){
        showErr("cmrErr", "é™ç•Œåˆ©ç›Šç‡ã¯ 0ã€œ100 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      }else{
        showErr("cmrErr", "");
      }

      showErr("spendMonthlyErr", "");
      showErr("spendYearlyErr", "");
      showErr("spendOnceErr", "");

      if(spendMode==="monthly"){
        const raw = String($("spendMonthly").value ?? "").trim();
        if(raw !== "" && c.spendM <= 0) showErr("spendMonthlyErr", "æ”¯å‡ºé¡ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      }
      if(spendMode==="yearly"){
        const raw = String($("spendYearly").value ?? "").trim();
        if(raw !== "" && c.spendY <= 0) showErr("spendYearlyErr", "æ”¯å‡ºé¡ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      }
      if(spendMode==="once"){
        const raw = String($("spendOnce").value ?? "").trim();
        if(raw !== "" && c.spendO <= 0) showErr("spendOnceErr", "æ”¯å‡ºé¡ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

        if(c.recoveryInfo.raw !== "" && !c.recoveryInfo.valid){
          showErr("recoveryErr", c.recoveryInfo.reason || "å›åæœŸé–“ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }else{
          showErr("recoveryErr", "");
        }
      }else{
        showErr("recoveryErr", "");
      }
    }

    function buildRouteDetailUI(){
      if(!selectedRoute) return;
      if(detailBuiltFor === selectedRoute) return;

      const inputA = $("detailInputA");
      const inputB = $("detailInputB");
      const kpi = $("detailKpi");

      inputA.innerHTML = "";
      inputB.innerHTML = "";
      kpi.innerHTML = "";
      $("detailHint").textContent = "";

      if(selectedRoute === "price"){
        $("detailTitle").textContent = "å˜ä¾¡ã‚’ä¸Šã’ã‚‹ï¼ˆæ·±æ˜ã‚Šï¼‰";
        $("detailSub").textContent   = "å¹´å•†ã‹ã‚‰æœˆå•†ï¼ˆå¹´å•†Ã·12ï¼‰ã‚’è‡ªå‹•è¨ˆç®—ã—ã€æœˆã‚ãŸã‚Šå›åç›®æ¨™ã«å¯¾ã™ã‚‹å¿…è¦ãªä¸Šä¹—ã›ç‡ã®ç›®å®‰ã‚’ç¢ºèªã—ã¾ã™ã€‚";

        inputA.innerHTML = `<label>å‰æ</label><div class="help">â€»å¹´å•†ã‚’å…¥åŠ›ã—ã¦ã„ã‚‹å ´åˆã€æœˆå•†ã¯è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ï¼ˆå¹´å•†Ã·12ï¼‰ã€‚</div>`;
        inputB.innerHTML = `<label>ãƒã‚¤ãƒ³ãƒˆ</label><div class="help">å€¤ä»˜ã‘ãƒ»æä¾›ä¾¡å€¤ãƒ»å®¢å±¤ã®è¦‹ç›´ã—ã§ã€åŒã˜ç¨¼åƒã§ã‚‚åˆ©ç›Šã‚’ä½œã‚Šã‚„ã™ã„æ–¹å‘ã§ã™ã€‚</div>`;

        kpi.innerHTML = `
          <div class="k2">
            <div class="t">æœˆã‚ãŸã‚Šå›åç›®æ¨™ï¼ˆå£²ä¸Šæ›ç®—ï¼‰</div>
            <div class="v" id="kpiSalesEqM">â€”</div>
          </div>
          <div class="k2">
            <div class="t">å¿…è¦ãªä¸Šä¹—ã›ç‡ï¼ˆ%ï¼‰â€»å¹´å•†å…¥åŠ›æ™‚</div>
            <div class="v" id="kpiNeedPricePct">â€”</div>
          </div>
        `;

        $("detailHint").textContent = "æ¬¡ã«ã€ã©ã®å•†å“/å®¢å±¤/å¥‘ç´„ãŒå¯¾è±¡ã‹ã€ã€ã„ã¤ã‹ã‚‰å®Ÿæ–½ã™ã‚‹ã‹ã€ã‚’æ±ºã‚ã‚‹ã¨ã€å®Ÿè¡Œã«è½ã¡ã¾ã™ã€‚";
      }

      if(selectedRoute === "volume"){
        const L = volLabels();

        $("detailTitle").textContent = "æ•°é‡ã‚’ä¸Šã’ã‚‹ï¼ˆæ·±æ˜ã‚Šï¼‰";
        $("detailSub").textContent   = "ã€Œå–å¼•å˜ä¾¡Ã—å–å¼•æ•°ã€ã§ã€æœˆã‚ãŸã‚Šå›åç›®æ¨™ã«å¿…è¦ãªè¿½åŠ ä»¶æ•°ã¨å…¥å£æ•°ã‚’æƒãˆã¾ã™ã€‚";

        const initUnitPrice = (importedUnitPrice !== null && importedUnitPrice !== undefined)
          ? formatInt(importedUnitPrice)
          : "";

        inputA.innerHTML = `
          <label>å…¥åŠ›</label>

          <div class="avgWrap" style="margin-top:6px;">
            <div class="avgTitle">è¨€ã„æ›ãˆï¼ˆä»»æ„ï¼‰</div>
            <div id="volumeLabelChips"></div>
            <div class="help" style="margin-top:8px;">
              â€»ã“ã“ã¯<strong>è¨€è‘‰ã®è¨€ã„æ›ãˆ</strong>ã§ã™ã€‚è¨ˆç®—ã¯åŒã˜ã§ã™ã€‚ã¾ãšã¯ã€Œæ±ç”¨ã€ã§OKã§ã™ã€‚
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="volumeUnitPrice">${L.unitPriceLabel}</label>
            <input id="volumeUnitPrice" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š12,000" data-format="int" value="${initUnitPrice}" />
            <div class="help">${L.unitHelp}</div>
            <div class="err" id="volumeUnitPriceErr" aria-live="polite"></div>
          </div>

          <div style="margin-top:10px;">
            <label for="volumeConvRate">${L.convLabel}ï¼ˆ% / ä»»æ„ï¼‰</label>
            <input id="volumeConvRate" inputmode="decimal" pattern="[0-9.]*" placeholder="ä¾‹ï¼š30" data-format="decimal" />
            <div class="help">${L.convHelp}</div>
            <div class="err" id="volumeConvRateErr" aria-live="polite"></div>
          </div>

          <div style="margin-top:10px;">
            <label for="volumeDays">${L.daysLabel}ï¼ˆä»»æ„ï¼‰</label>
            <input id="volumeDays" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š25" data-format="int" />
            <div class="help">æ—¥å‰²ã‚Šï¼ˆ1æ—¥ã‚ãŸã‚Šå¿…è¦æ•°ï¼‰ã‚’å‡ºã—ãŸã„å ´åˆã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
            <div class="err" id="volumeDaysErr" aria-live="polite"></div>
          </div>
        `;

        inputB.innerHTML = `
          <details class="fold" open>
            <summary>æ•´ç†ã®ã—ã‹ãŸï¼ˆè¦‹æ–¹ï¼‰</summary>
            <div class="inside">
              <div class="help">
                â‘  æœˆã‚ãŸã‚Šå›åç›®æ¨™ï¼ˆå¿…è¦ãªå£²ä¸Šï¼‰ã‚’å‡ºã™ â†’ â‘¡ ${L.unitPriceLabel} ã§å‰²ã£ã¦<strong>å¿…è¦ãªè¿½åŠ ${L.txName}æ•°</strong>ã‚’å‡ºã™<br>
                â‘¢ ã•ã‚‰ã« ${L.convLabel} ã‚’ä½¿ã£ã¦<strong>${L.entryLabel}</strong>ï¼ˆå‰æ®µã®æ•°ï¼‰ã‚’ç›®å®‰ã§å‡ºã—ã¾ã™ã€‚
              </div>

              <div class="note" style="margin-top:10px;">
                æ•°é‡ã‚¢ãƒƒãƒ—ã¯ã€Œå…¥å£ã‚’å¢—ã‚„ã™ã€ã ã‘ã§ãªãã€ã€Œæˆç´„ç‡ã‚’ä¸Šã’ã‚‹ã€ã§ã‚‚å®Ÿç¾ã§ãã¾ã™ã€‚
              </div>
            </div>
          </details>
        `;

        kpi.innerHTML = `
          <div class="k2">
            <div class="t">å¿…è¦ãªè¿½åŠ ${L.txName}æ•°ï¼ˆ${L.unitShort}/æœˆï¼‰</div>
            <div class="v" id="kpiNeedTxM">â€”</div>
          </div>
          <div class="k2">
            <div class="t">å¿…è¦ãªè¿½åŠ ${L.txName}æ•°ï¼ˆ${L.unitShort}/æ—¥ï¼‰â€»æ—¥æ•°å…¥åŠ›æ™‚</div>
            <div class="v" id="kpiNeedTxD">â€”</div>
          </div>
          <div class="k2">
            <div class="t">å¿…è¦ãª${L.entryLabel}ï¼ˆ${L.entryShort}/æœˆï¼‰â€»æˆç´„ç‡å…¥åŠ›æ™‚</div>
            <div class="v" id="kpiNeedEntryM">â€”</div>
          </div>
          <div class="k2">
            <div class="t">å¿…è¦ãª${L.entryLabel}ï¼ˆ${L.entryShort}/æ—¥ï¼‰â€»æˆç´„ç‡+æ—¥æ•°å…¥åŠ›æ™‚</div>
            <div class="v" id="kpiNeedEntryD">â€”</div>
          </div>
        `;

        $("detailHint").textContent =
          "æ¬¡ã«ã€å…¥å£ã‚’å¢—ã‚„ã™ï¼ˆæ–½ç­–ï¼‰ã€ã‹ ã€æˆç´„ç‡ã‚’ä¸Šã’ã‚‹ï¼ˆæ”¹å–„ï¼‰ã€ã®ã©ã¡ã‚‰ã‚’ä¸»è»¸ã«ã™ã‚‹ã‹ã‚’æ±ºã‚ã‚‹ã¨ã€å‹•ãã‚„ã™ããªã‚Šã¾ã™ã€‚";

        const mount = $("volumeLabelChips");
        if(mount){
          mount.innerHTML = "";
          buildVolumeLabelChips(mount);
        }

        bindLiveFormatting(document);

        const onVolInput = ()=>{
          updateRouteDetailKPIs();
          persist();
        };
        ["volumeUnitPrice","volumeConvRate","volumeDays"].forEach(id=>{
          if($(id)) $(id).addEventListener("input", onVolInput);
        });
      }

      if(selectedRoute === "auto"){
        $("detailTitle").textContent = "æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ã™ã‚‹ï¼ˆæ·±æ˜ã‚Šï¼‰";
        $("detailSub").textContent   = "æ”¯å‡ºï¼ˆå˜ç™ºã¯æœˆå‰²ã‚Šï¼‰ã‚’â€œå‰Šæ¸›ã§ãã‚‹æ™‚é–“â€ã«ç½®ãæ›ãˆã¦ã€å›åã®ç›®å®‰ã‚’ç¢ºèªã—ã¾ã™ã€‚";

        inputA.innerHTML = `
          <label for="hourCostInput">æ™‚é–“å˜ä¾¡ï¼ˆå†† / æ™‚ï¼‰</label>
          <input id="hourCostInput" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š3,000" data-format="int" />
          <div class="help">ç¤¾å†…ã®å®Ÿæ…‹ã«åˆã‚ã›ãŸç›®å®‰ã§OKã§ã™ï¼ˆæ¦‚ç®—ï¼‰ã€‚</div>
          <div class="err" id="hourCostErr" aria-live="polite"></div>

          <div class="avgWrap" style="margin-top:10px;">
            <div class="avgGrid" aria-label="æ™‚é–“å˜ä¾¡è¨ˆç®—ãƒ„ãƒ¼ãƒ«">
              <button type="button" class="avgBtn" id="btnTimeCostModal">æ™‚é–“å˜ä¾¡ã®è¨ˆç®—ã¯ã“ã¡ã‚‰</button>
              <button type="button" class="avgBtn" id="btnTimeCostNewTab">åˆ¥ã‚¿ãƒ–ã§é–‹ã</button>
            </div>
            <div class="help" style="margin-top:6px;">
              â€»æ™‚é–“å˜ä¾¡ãŒä¸æ˜ãªå ´åˆã«ã”åˆ©ç”¨ãã ã•ã„ã€‚
            </div>
          </div>
        `;

        inputB.innerHTML = `
          <label>ãƒã‚¤ãƒ³ãƒˆ</label>
          <div class="help">â€œç©ºã„ãŸæ™‚é–“â€ã‚’ã€å˜ä¾¡/æ•°é‡ã‚’ä¸Šã’ã‚‹æ´»å‹•ã¸ç§»ã™ã“ã¨ã§åŠ¹æœãŒå¤§ãããªã‚Šã¾ã™ã€‚</div>
        `;

        kpi.innerHTML = `
          <div class="k2">
            <div class="t">æœˆã‚ãŸã‚Šã®æ”¯å‡ºï¼ˆå˜ç™ºã¯æœˆå‰²ã‚Šï¼‰</div>
            <div class="v" id="kpiSpendMonthlyEq">â€”</div>
          </div>
          <div class="k2">
            <div class="t">å›åã«å¿…è¦ãªå‰Šæ¸›æ™‚é–“ï¼ˆh / æœˆï¼‰</div>
            <div class="v" id="kpiNeedHours">â€”</div>
          </div>
        `;

        $("detailHint").textContent = "ã€ã©ã®ä½œæ¥­ã‚’å‰Šã‚‹ã‹ã€ã€é‹ç”¨ãƒ«ãƒ¼ãƒ«ã€ã¾ã§æ±ºã‚ã‚‹ã¨ã€å†ç¾æ€§ãŒå‡ºã¾ã™ã€‚";

        bindLiveFormatting(document);
        if($("hourCostInput")){
          $("hourCostInput").addEventListener("input", ()=>{
            updateRouteDetailKPIs();
            persist();

            const raw = String($("hourCostInput").value ?? "").trim();
            const v = num(raw);
            if(raw !== "" && v <= 0) showErr("hourCostErr", "æ™‚é–“å˜ä¾¡ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            else showErr("hourCostErr", "");
          });
        }

        const b1 = $("btnTimeCostModal");
        const b2 = $("btnTimeCostNewTab");
        if(b1){
          b1.addEventListener("click", ()=>{
            openModal("æ™‚é–“å˜ä¾¡ã®è¨ˆç®—", TIME_UNIT_COST_URL);
          });
        }
        if(b2){
          b2.addEventListener("click", ()=>{
            window.open(TIME_UNIT_COST_URL, "_blank", "noopener,noreferrer");
          });
        }
      }

      detailBuiltFor = selectedRoute;
    }

    function updateRouteDetailKPIs(){
      if(!selectedRoute) return;
      const c = compute();

      if($("kpiSalesEqM")) {
        $("kpiSalesEqM").textContent = Number.isFinite(c.salesEqTargetM) ? yen(c.salesEqTargetM) : "æ”¯å‡ºé¡ã¨é™ç•Œåˆ©ç›Šç‡ã‚’å…¥åŠ›";
        if(!Number.isFinite(c.salesEqTargetM)) $("kpiSalesEqM").classList.add("small");
        else $("kpiSalesEqM").classList.remove("small");
      }

      if(selectedRoute === "price"){
        if($("kpiNeedPricePct")){
          if(c.annualSales>0 && Number.isFinite(c.needPricePct)){
            $("kpiNeedPricePct").textContent = pct1(c.needPricePct);
            $("kpiNeedPricePct").classList.remove("small");
          }else{
            $("kpiNeedPricePct").textContent = "å¹´å•†ã‚’å…¥åŠ›ã™ã‚‹ã¨è¡¨ç¤º";
            $("kpiNeedPricePct").classList.add("small");
          }
        }
      }

      if(selectedRoute === "volume"){
        const L = volLabels();
        const unitRaw = $("volumeUnitPrice") ? String($("volumeUnitPrice").value ?? "").trim() : "";
        const unitPrice = $("volumeUnitPrice") ? num($("volumeUnitPrice").value) : 0;

        const convRaw = $("volumeConvRate") ? String($("volumeConvRate").value ?? "").trim() : "";
        const convRate = $("volumeConvRate") ? num($("volumeConvRate").value) : 0;

        const daysRaw = $("volumeDays") ? String($("volumeDays").value ?? "").trim() : "";
        const days = $("volumeDays") ? num($("volumeDays").value) : 0;

        if($("volumeUnitPriceErr")){
          if(unitRaw !== "" && unitPrice <= 0) showErr("volumeUnitPriceErr", "å˜ä¾¡ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          else showErr("volumeUnitPriceErr", "");
        }
        if($("volumeConvRateErr")){
          if(convRaw !== "" && !(convRate>0 && convRate<=100)) showErr("volumeConvRateErr", "æˆç´„ç‡ã¯ 0ã€œ100 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          else showErr("volumeConvRateErr", "");
        }
        if($("volumeDaysErr")){
          if(daysRaw !== "" && days <= 0) showErr("volumeDaysErr", "æ—¥æ•°ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          else showErr("volumeDaysErr", "");
        }

        const canBase = (unitPrice>0 && Number.isFinite(c.salesEqTargetM));
        const needTxM = canBase ? (c.salesEqTargetM / unitPrice) : NaN;
        const needTxD = (days>0 && Number.isFinite(needTxM)) ? (needTxM / days) : NaN;

        const canEntry = (convRate>0 && convRate<=100 && Number.isFinite(needTxM));
        const needEntryM = canEntry ? (needTxM / (convRate/100)) : NaN;
        const needEntryD = (days>0 && Number.isFinite(needEntryM)) ? (needEntryM / days) : NaN;

        function setVal(id, txt, small){
          const el = $(id);
          if(!el) return;
          el.textContent = txt;
          el.classList.toggle("small", !!small);
        }

        if(!canBase){
          setVal("kpiNeedTxM", "å˜ä¾¡ã¨å›åç›®æ¨™ã‚’å…¥åŠ›", true);
          setVal("kpiNeedTxD", "æ—¥æ•°ã‚’å…¥ã‚Œã‚‹ã¨è¡¨ç¤º", true);
          setVal("kpiNeedEntryM", "æˆç´„ç‡ã‚’å…¥ã‚Œã‚‹ã¨è¡¨ç¤º", true);
          setVal("kpiNeedEntryD", "æˆç´„ç‡+æ—¥æ•°ã§è¡¨ç¤º", true);
        }else{
          setVal("kpiNeedTxM", (ceil1(needTxM) + " " + L.unitShort + "/æœˆ"), false);
          setVal("kpiNeedTxD", Number.isFinite(needTxD) ? (ceil1(needTxD) + " " + L.unitShort + "/æ—¥") : "æ—¥æ•°ã‚’å…¥ã‚Œã‚‹ã¨è¡¨ç¤º", !Number.isFinite(needTxD));
          setVal("kpiNeedEntryM", Number.isFinite(needEntryM) ? (ceil1(needEntryM) + " " + L.entryShort + "/æœˆ") : "æˆç´„ç‡ã‚’å…¥ã‚Œã‚‹ã¨è¡¨ç¤º", !Number.isFinite(needEntryM));
          setVal("kpiNeedEntryD", Number.isFinite(needEntryD) ? (ceil1(needEntryD) + " " + L.entryShort + "/æ—¥") : "æˆç´„ç‡+æ—¥æ•°ã§è¡¨ç¤º", !Number.isFinite(needEntryD));
        }
      }

      if(selectedRoute === "auto"){
        const hourRaw = $("hourCostInput") ? String($("hourCostInput").value ?? "").trim() : "";
        const hour = $("hourCostInput") ? num($("hourCostInput").value) : 0;
        const needHours = (hour>0 && Number.isFinite(c.spendPerMonth)) ? (c.spendPerMonth/hour) : NaN;

        if($("kpiSpendMonthlyEq")){
          $("kpiSpendMonthlyEq").textContent = Number.isFinite(c.spendPerMonth) ? yen(c.spendPerMonth) : "æ”¯å‡ºé¡ï¼ˆå˜ç™ºã¯å›åæœŸé–“ï¼‰ã‚’å…¥åŠ›";
          $("kpiSpendMonthlyEq").classList.toggle("small", !Number.isFinite(c.spendPerMonth));
        }

        if($("kpiNeedHours")){
          if(Number.isFinite(needHours)){
            $("kpiNeedHours").textContent = (ceil1(needHours)+" h/æœˆ");
            $("kpiNeedHours").classList.remove("small");
          }else{
            $("kpiNeedHours").textContent = (hourRaw ? "æ”¯å‡ºé¡ã‚’å…¥åŠ›" : "æ™‚é–“å˜ä¾¡ã‚’å…¥åŠ›");
            $("kpiNeedHours").classList.add("small");
          }
        }
      }
    }

    function setRoute(route){
      selectedRoute = route || "";

      if(!selectedRoute){
        $("routeChooser").style.display = "grid";
        $("routeDetail").style.display = "none";
        detailBuiltFor = "";
        persist();
        return;
      }

      $("routeChooser").style.display = "none";
      $("routeDetail").style.display = "block";

      if(route){
        setTimeout(() => {
          const box = $("routeDetail");
          if(!box) return;
          const y = box.getBoundingClientRect().top + window.scrollY - 70;
          window.scrollTo({ top: y, behavior: "smooth" });
        }, 50);
      }

      buildRouteDetailUI();
      updateRouteDetailKPIs();
      persist();
    }

    function render(){
      const c = compute();
      validateStep1Errors(c);

      $("monthlySalesAuto").value = (c.annualSales>0) ? yen(c.monthlySalesAuto) : "";

      if(spendMode==="once"){
        $("spendMonthlyEqAuto").value = Number.isFinite(c.spendPerMonth) ? yen(c.spendPerMonth) : "â€”";
        syncRecoveryChipsFromInput();
      }else{
        $("spendMonthlyEqAuto").value = "";
      }

      if(spendMode==="monthly" || spendMode==="yearly"){
        $("kpiT1").textContent = "å£²ä¸Šæ›ç®—é¡ï¼ˆå†† / æœˆï¼‰";
        $("kpiT2").textContent = "å£²ä¸Šæ›ç®—é¡ï¼ˆå†† / å¹´ï¼‰";

        if(Number.isFinite(c.salesEqTargetM)){
          $("salesEqM").textContent = yen(c.salesEqTargetM);
          $("salesEqM").classList.remove("small");
        }else{
          $("salesEqM").textContent = "æ”¯å‡ºé¡ã¨é™ç•Œåˆ©ç›Šç‡ã‚’å…¥åŠ›";
          $("salesEqM").classList.add("small");
        }

        if(Number.isFinite(c.salesEqAnnual)){
          $("salesEqY").textContent = yen(c.salesEqAnnual);
          $("salesEqY").classList.remove("small");
        }else{
          $("salesEqY").textContent = "æ”¯å‡ºé¡ã¨é™ç•Œåˆ©ç›Šç‡ã‚’å…¥åŠ›";
          $("salesEqY").classList.add("small");
        }
      }

      if(spendMode==="once"){
        $("kpiT1").textContent = "å£²ä¸Šæ›ç®—é¡ï¼ˆç·é¡ï¼‰";
        $("kpiT2").textContent = "å›åç›®æ¨™ï¼ˆå†† / æœˆï¼‰";

        if(Number.isFinite(c.salesEqTotal)){
          $("salesEqM").textContent = yen(c.salesEqTotal);
          $("salesEqM").classList.remove("small");
        }else{
          $("salesEqM").textContent = "æ”¯å‡ºé¡ã¨é™ç•Œåˆ©ç›Šç‡ã‚’å…¥åŠ›";
          $("salesEqM").classList.add("small");
        }

        if(Number.isFinite(c.salesEqTargetM)){
          $("salesEqY").textContent = yen(c.salesEqTargetM);
          $("salesEqY").classList.remove("small");
        }else{
          const rmRaw = String($("recoveryMonths").value ?? "").trim();
          $("salesEqY").textContent = (rmRaw === "") ? "å›åæœŸé–“ã‚’å…¥åŠ›" : "æ”¯å‡ºé¡ã¨é™ç•Œåˆ©ç›Šç‡ã‚’å…¥åŠ›";
          $("salesEqY").classList.add("small");
        }
      }

      if(Number.isFinite(c.shareY)){
        $("shareY").textContent = pct1(c.shareY);
        $("shareY").classList.remove("small");
      }else{
        if(c.annualSales>0){
          $("shareY").textContent = "å…¥åŠ›å€¤ã‚’ç¢ºèª";
        }else{
          $("shareY").textContent = "å¹´å•†ã‚’å…¥åŠ›ã™ã‚‹ã¨è¡¨ç¤º";
        }
        $("shareY").classList.add("small");
      }

      $("selectedRouteLabel").value =
        selectedRoute==="price" ? "å˜ä¾¡ã‚’ä¸Šã’ã‚‹" :
        selectedRoute==="volume" ? "æ•°é‡ã‚’ä¸Šã’ã‚‹" :
        selectedRoute==="auto" ? "æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ï¼ˆæ™‚é–“å‰µå‡ºï¼‰" :
        "ï¼ˆæœªé¸æŠï¼‰";

      if(selectedRoute){
        buildRouteDetailUI();
        updateRouteDetailKPIs();
      }

      persist();
    }

    // =========================
    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºï¼ˆè»¢è¨˜/ã‚³ãƒ”ãƒ¼ãªã©ã«æµç”¨ï¼‰
    // =========================
    function showImportToast(msg="æ•°å­—ã‚’è»¢è¨˜ã—ã¾ã—ãŸ"){
      const el = $("importToast");
      if(!el) return;
      el.textContent = msg;
      el.classList.add("show");
      window.clearTimeout(showImportToast._t);
      showImportToast._t = window.setTimeout(()=>{
        el.classList.remove("show");
      }, 2200);
    }

    // =========================
    // å…±æœ‰ç”¨ï¼ˆé–¢é€£ãƒ„ãƒ¼ãƒ«ã¸ï¼‰URLç”Ÿæˆ
    // =========================
    function buildShareParams(extra={}){
      const p = new URLSearchParams();

      p.set("mode", spendMode);

      if(spendMode==="monthly") {
        const v = stripNumberText($("spendMonthly")?.value);
        if(v) p.set("spend", v);
      }
      if(spendMode==="yearly") {
        const v = stripNumberText($("spendYearly")?.value);
        if(v) p.set("spend", v);
      }
      if(spendMode==="once") {
        const v = stripNumberText($("spendOnce")?.value);
        if(v) p.set("spend", v);
        const r = stripNumberText($("recoveryMonths")?.value);
        if(r) p.set("recovery", r);
      }

      const cmrV = normalizeDecimalText($("cmr")?.value);
      if(cmrV) p.set("cmr", cmrV);

      const s = stripNumberText($("annualSales")?.value);
      if(s) p.set("sales", s);

      const unitFromInput = stripNumberText($("volumeUnitPrice")?.value);
      if(unitFromInput){
        p.set("unit_price", unitFromInput);
      }else if(importedUnitPrice !== null && importedUnitPrice !== undefined){
        const u = String(Math.round(Number(importedUnitPrice)));
        if(u !== "" && u !== "0") p.set("unit_price", u);
      }

      if(importedMonthlyQty !== null && importedMonthlyQty !== undefined && Number(importedMonthlyQty) > 0){
        p.set("monthly_qty", String(Math.round(Number(importedMonthlyQty))));
      }

      if(selectedRoute) p.set("route", selectedRoute);

      Object.entries(extra || {}).forEach(([k,v])=>{
        if(v === null || v === undefined) return;
        const sv = String(v).trim();
        if(sv === "") return;
        p.set(k, sv);
      });

      return p;
    }

    function buildUrlWithParams(baseUrl, extra={}){
      if(!baseUrl) return "";
      const u = new URL(baseUrl, window.location.href);
      const params = buildShareParams(extra);
      params.forEach((v,k)=>u.searchParams.set(k,v));
      return u.toString();
    }

    function buildPriceToolExtraParams(){
      const ex = {};

      const cmrV = normalizeDecimalText($("cmr")?.value);
      if(cmrV){
        ex.cmr = cmrV;
        ex.margin = cmrV;
        ex.gm = cmrV;
        ex.rate = cmrV;
        ex.cmr_pct = cmrV;
      }

      const unitFromInput = stripNumberText($("volumeUnitPrice")?.value);
      let unitVal = null;
      if(unitFromInput){
        const n = Number(unitFromInput);
        if(Number.isFinite(n) && n > 0) unitVal = n;
      }else if(importedUnitPrice !== null && importedUnitPrice !== undefined){
        const n = Number(importedUnitPrice);
        if(Number.isFinite(n) && n > 0) unitVal = n;
      }
      if(unitVal !== null){
        const u = String(Math.round(unitVal));
        ex.unit_price = u;
        ex.unitPrice = u;
        ex.unit = u;
        ex.price = u;
        ex.current_price = u;
      }

      const sales = stripNumberText($("annualSales")?.value);
      if(sales){
        ex.sales = sales;
        ex.annual_sales = sales;
        ex.annualSales = sales;
        ex.revenue = sales;
      }

      let qty = null;
      if(importedMonthlyQty !== null && importedMonthlyQty !== undefined && Number(importedMonthlyQty) > 0){
        qty = Number(importedMonthlyQty);
      }else{
        const c = compute();
        if(unitVal && c.monthlySalesAuto > 0){
          const q = c.monthlySalesAuto / unitVal;
          if(Number.isFinite(q) && q > 0) qty = Math.round(q);
        }
      }
      if(qty !== null && Number.isFinite(qty) && qty > 0){
        const q = String(Math.round(qty));
        ex.monthly_qty = q;
        ex.monthlyQty = q;
        ex.qty = q;
        ex.quantity = q;
        ex.month_qty = q;
        ex.monthly_quantity = q;
      }

      return ex;
    }

    // =========================
    // URLå—ä¿¡
    // =========================
    const IN_KEYS = {
      mode:     ["mode","spendMode","m"],
      spend:    ["spend","expense","cost","amount","spend_amount"],
      spendM:   ["spend_monthly","spendMonthly","monthly_spend","monthly"],
      spendY:   ["spend_yearly","spendYearly","yearly_spend","yearly","annual_spend"],
      spendO:   ["spend_once","spendOnce","once_spend","once","one_time"],
      cmr:      ["cmr","cmr_pct","margin","gross_margin","gm","profit_rate","rate"],
      sales:    ["sales","annual_sales","annualSales","annual_sales_yen","revenue","turnover"],
      recovery: ["recovery","recoveryMonths","recovery_months","months","term"],
      unit:     ["unit_price","unitPrice","unitprice","unit","price_per_unit","unit_yen"],
      qty:      ["monthly_qty","monthlyQty","month_qty","qty","quantity","monthly_quantity","q"],
      route:    ["route","selectedRoute","r"],
      payload:  ["payload","p","data"]
    };

    function firstParam(params, keys){
      for(const k of (keys||[])){
        const v = params.get(k);
        if(v !== null && String(v).trim() !== "") return v;
      }
      return null;
    }

    function atobUtf8(b64){
      try{
        const bin = atob(b64);
        const esc = Array.prototype.map.call(bin, c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('');
        return decodeURIComponent(esc);
      }catch(e){
        try{ return atob(b64); }catch(e2){ return ""; }
      }
    }

    function tryParsePayload(params){
      const raw = firstParam(params, IN_KEYS.payload);
      if(!raw) return null;

      let s = raw;
      try{
        if(/%[0-9A-Fa-f]{2}/.test(s)) s = decodeURIComponent(s);
      }catch(e){}

      const t = String(s).trim();
      if(t.startsWith("{") && t.endsWith("}")){
        try{
          const obj = JSON.parse(t);
          if(obj && typeof obj === "object") return obj;
        }catch(e){}
      }

      if(/^[A-Za-z0-9\-_]+=*$/.test(t) && t.length >= 8){
        const b64 = t.replace(/-/g,'+').replace(/_/g,'/');
        const pad = b64.length % 4;
        const b64p = pad ? (b64 + "=".repeat(4-pad)) : b64;
        const decoded = atobUtf8(b64p);
        const dt = String(decoded || "").trim();
        if(dt.startsWith("{") && dt.endsWith("}")){
          try{
            const obj = JSON.parse(dt);
            if(obj && typeof obj === "object") return obj;
          }catch(e){}
        }
      }

      return null;
    }

    function getMergedParams(){
      const p = new URLSearchParams(window.location.search || "");
      const h = String(window.location.hash || "");
      const qi = h.indexOf("?");
      if(qi !== -1 && qi < h.length-1){
        const hs = h.slice(qi+1);
        const hp = new URLSearchParams(hs);
        hp.forEach((v,k)=>{
          if(!p.has(k)) p.set(k,v);
        });
      }
      return p;
    }

    function hasIncomingAny(params){
      if(firstParam(params, IN_KEYS.payload)) return true;
      const checks = ["mode","spend","spendM","spendY","spendO","cmr","sales","recovery","unit","qty","route"];
      return checks.some(name => firstParam(params, IN_KEYS[name]));
    }

    function cleanIncomingFromUrl(){
      const removeKeys = []
        .concat(IN_KEYS.mode, IN_KEYS.spend, IN_KEYS.spendM, IN_KEYS.spendY, IN_KEYS.spendO,
                IN_KEYS.cmr, IN_KEYS.sales, IN_KEYS.recovery, IN_KEYS.unit, IN_KEYS.qty, IN_KEYS.route, IN_KEYS.payload);

      const url = new URL(window.location.href);

      const keep = new URLSearchParams(url.search);
      removeKeys.forEach(k=>keep.delete(k));
      const qs = keep.toString();
      url.search = qs ? ("?" + qs) : "";

      const h = String(url.hash || "");
      const qi = h.indexOf("?");
      if(qi !== -1){
        const base = h.slice(0, qi);
        const hqs = h.slice(qi+1);
        const hp = new URLSearchParams(hqs);
        removeKeys.forEach(k=>hp.delete(k));
        const nh = hp.toString();
        url.hash = nh ? (base + "?" + nh) : base;
      }

      window.history.replaceState({}, "", url);
    }

    function checkUrlParams(){
      const params = getMergedParams();
      if(!hasIncomingAny(params)) return;

      const payloadObj = tryParsePayload(params) || {};

      const getFromPayload = (keys)=>{
        for(const k of keys){
          const v = payloadObj?.[k];
          if(v !== undefined && v !== null && String(v).trim() !== "") return String(v);
        }
        return null;
      };

      const p_mode     = firstParam(params, IN_KEYS.mode)     ?? getFromPayload(IN_KEYS.mode);
      const p_spend    = firstParam(params, IN_KEYS.spend)    ?? getFromPayload(IN_KEYS.spend);
      const p_spendM   = firstParam(params, IN_KEYS.spendM)   ?? getFromPayload(IN_KEYS.spendM);
      const p_spendY   = firstParam(params, IN_KEYS.spendY)   ?? getFromPayload(IN_KEYS.spendY);
      const p_spendO   = firstParam(params, IN_KEYS.spendO)   ?? getFromPayload(IN_KEYS.spendO);

      const p_cmr      = firstParam(params, IN_KEYS.cmr)      ?? getFromPayload(IN_KEYS.cmr);
      const p_sales    = firstParam(params, IN_KEYS.sales)    ?? getFromPayload(IN_KEYS.sales);
      const p_recovery = firstParam(params, IN_KEYS.recovery) ?? getFromPayload(IN_KEYS.recovery);
      const p_unit     = firstParam(params, IN_KEYS.unit)     ?? getFromPayload(IN_KEYS.unit);
      const p_qty      = firstParam(params, IN_KEYS.qty)      ?? getFromPayload(IN_KEYS.qty);
      const p_route    = firstParam(params, IN_KEYS.route)    ?? getFromPayload(IN_KEYS.route);

      let changed = false;

      const hasNumericIncoming =
        [p_spend, p_spendM, p_spendY, p_spendO, p_cmr, p_sales, p_recovery, p_unit, p_qty]
          .some(v => v !== null && String(v).trim() !== "");

      IS_RESTORING = true;

      let decidedMode = null;
      if(p_mode && ["monthly","yearly","once"].includes(p_mode)){
        decidedMode = p_mode;
      }else{
        if((p_recovery && String(p_recovery).trim() !== "") || (p_spendO && String(p_spendO).trim() !== "")){
          decidedMode = "once";
        }else if(p_spendY && String(p_spendY).trim() !== ""){
          decidedMode = "yearly";
        }else if(p_spendM && String(p_spendM).trim() !== ""){
          decidedMode = "monthly";
        }else{
          decidedMode = null;
        }
      }
      if(decidedMode){
        setSpendMode(decidedMode);
        changed = true;
      }

      const setSpendInto = (mode, rawVal)=>{
        const v = num(rawVal);
        if(v > 0){
          const fmtV = formatInt(v);
          if(mode === "monthly") $("spendMonthly").value = fmtV;
          if(mode === "yearly")  $("spendYearly").value  = fmtV;
          if(mode === "once")    $("spendOnce").value    = fmtV;
          return true;
        }
        return false;
      };

      const modeNow = spendMode;

      if(modeNow === "monthly" && p_spendM) { if(setSpendInto("monthly", p_spendM)) changed = true; }
      if(modeNow === "yearly"  && p_spendY) { if(setSpendInto("yearly",  p_spendY)) changed = true; }
      if(modeNow === "once"    && p_spendO) { if(setSpendInto("once",    p_spendO)) changed = true; }

      if(!((modeNow==="monthly"&&p_spendM) || (modeNow==="yearly"&&p_spendY) || (modeNow==="once"&&p_spendO))){
        if(p_spend !== null && String(p_spend).trim() !== ""){
          if(setSpendInto(modeNow, p_spend)) changed = true;
        }
      }

      if(p_cmr !== null && String(p_cmr).trim() !== ""){
        $("cmr").value = normalizeDecimalText(p_cmr);
        changed = true;
      }

      if(p_sales !== null && String(p_sales).trim() !== ""){
        const v = num(p_sales);
        if(v > 0){
          $("annualSales").value = formatInt(v);
          changed = true;
        }
      }

      if(p_recovery !== null && String(p_recovery).trim() !== ""){
        const v = num(p_recovery);
        if(v >= 1){
          $("recoveryMonths").value = formatInt(v);
          syncRecoveryChipsFromInput();
          changed = true;
        }
      }

      if(p_unit !== null && String(p_unit).trim() !== ""){
        const v = num(p_unit);
        importedUnitPrice = v;
        if($("volumeUnitPrice")){
          $("volumeUnitPrice").value = formatInt(v);
          formatIntInput($("volumeUnitPrice"));
        }
        changed = true;
      }

      if(p_qty !== null && String(p_qty).trim() !== ""){
        const v = num(p_qty);
        if(Number.isFinite(v) && v > 0){
          importedMonthlyQty = v;
          changed = true;
        }
      }

      if(p_route && ["price","volume","auto"].includes(p_route)){
        setRoute(p_route);
        changed = true;
      }

      IS_RESTORING = false;

      if(changed){
        bindLiveFormatting(document);
        document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
        document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);

        render();
        persist();

        cleanIncomingFromUrl();

        if(hasNumericIncoming){
          showImportToast("æ•°å­—ã‚’è»¢è¨˜ã—ã¾ã—ãŸ");
        }
      }
    }

    // modal helpers
    function openModal(title, url){
      currentUrl = url || "";
      $("modalTitle").innerHTML = `${title || "ãƒ„ãƒ¼ãƒ«ã‚’è¡¨ç¤º"} <span>ï¼ˆåŒä¸€ç”»é¢ï¼‰</span>`;
      $("toolFrame").src = currentUrl;
      $("modalBack").style.display = "flex";
    }
    function closeModal(){
      $("modalBack").style.display = "none";
      $("toolFrame").src = "about:blank";
      currentUrl = "";
    }

    function getToolUrl(){
      if(!selectedRoute) return "";
      const base = TOOL_URLS[selectedRoute] || "";
      if(!base) return "";

      if(selectedRoute === "price"){
        const ex = Object.assign({ src: "action_tool" }, buildPriceToolExtraParams());
        return buildUrlWithParams(base, ex);
      }
      return buildUrlWithParams(base, { src: "action_tool" });
    }
    function getToolTitle(){
      return selectedRoute==="price" ? "å˜ä¾¡ã‚’ä¸Šã’ã‚‹ï¼ˆé–¢é€£ãƒ„ãƒ¼ãƒ«ï¼‰"
           : selectedRoute==="volume" ? "æ•°é‡ã‚’ä¸Šã’ã‚‹ï¼ˆé–¢é€£ãƒ„ãƒ¼ãƒ«ï¼‰"
           : selectedRoute==="auto" ? "è‡ªå‹•åŒ–åŠ¹æœï¼ˆé–¢é€£ãƒ„ãƒ¼ãƒ«ï¼‰"
           : "é–¢é€£ãƒ„ãƒ¼ãƒ«";
    }

    function doReset(){
      const ok = confirm("å…¥åŠ›å†…å®¹ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ã•ã‚ŒãŸå†…å®¹ã‚‚æ¶ˆãˆã¾ã™ï¼‰");
      if(!ok) return;

      try{ localStorage.removeItem(KEY); }catch(e){}

      importedUnitPrice = null;
      importedMonthlyQty = null;
      volumeLabelKey = "generic";
      detailBuiltFor = "";

      [
        "spendMonthly","spendYearly","spendOnce","recoveryMonths","cmr","annualSales",
        "targetScope","checkKpi","targetGoal","firstAction","stopDoing","nextCheck","freeMemo"
      ].forEach(id=>{
        if($(id)) $(id).value = "";
      });

      ["spendMonthlyErr","spendYearlyErr","spendOnceErr","recoveryErr","cmrErr"].forEach(id=>showErr(id, ""));

      closeModal();

      setRoute("");
      setSpendMode("monthly");

      bindLiveFormatting(document);
      document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
      document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);

      render();
    }

    // =========================
    // ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    // =========================
    function buildSummaryText(){
      const c = compute();

      const lines = [];
      lines.push("ã€æ‰“ã¡æ‰‹æ¤œè¨ãƒ„ãƒ¼ãƒ«ï½œè¦ç‚¹ã€‘");

      // Step1
      const modeLabel =
        spendMode==="monthly" ? "æ¯æœˆï¼ˆå›ºå®šè²»ï¼‰" :
        spendMode==="yearly"  ? "å¹´é¡ï¼ˆå›ºå®šè²»ï¼‰" :
        "å˜ç™ºï¼ˆ1å›ï¼‰";
      lines.push("");
      lines.push("â– 1. å£²ä¸Šæ›ç®—");
      lines.push(`- æ”¯å‡ºã®é »åº¦ï¼š${modeLabel}`);

      if(spendMode==="monthly"){
        const v = $("spendMonthly").value.trim();
        if(v) lines.push(`- æ”¯å‡ºé¡ï¼šÂ¥${stripNumberText(v).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} / æœˆ`);
      }
      if(spendMode==="yearly"){
        const v = $("spendYearly").value.trim();
        if(v) lines.push(`- æ”¯å‡ºé¡ï¼šÂ¥${stripNumberText(v).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} / å¹´`);
      }
      if(spendMode==="once"){
        const v = $("spendOnce").value.trim();
        const rm = $("recoveryMonths").value.trim();
        if(v) lines.push(`- æ”¯å‡ºé¡ï¼šÂ¥${stripNumberText(v).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}ï¼ˆå˜ç™ºï¼‰`);
        if(rm) lines.push(`- å›åæœŸé–“ï¼š${stripNumberText(rm)}ãƒ¶æœˆ`);
        if(Number.isFinite(c.spendPerMonth)) lines.push(`- æœˆå‰²ã‚Šæ”¯å‡ºï¼ˆè‡ªå‹•ï¼‰ï¼š${yen(c.spendPerMonth)}`);
      }

      const cmrRaw = $("cmr").value.trim();
      if(cmrRaw) lines.push(`- é™ç•Œåˆ©ç›Šç‡ï¼š${normalizeDecimalText(cmrRaw)}%`);

      const salesRaw = $("annualSales").value.trim();
      if(salesRaw) lines.push(`- å¹´å•†ï¼ˆä»»æ„ï¼‰ï¼šÂ¥${stripNumberText(salesRaw).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`);

      if(spendMode==="once"){
        if(Number.isFinite(c.salesEqTotal)) lines.push(`- å£²ä¸Šæ›ç®—é¡ï¼ˆç·é¡ï¼‰ï¼š${yen(c.salesEqTotal)}`);
        if(Number.isFinite(c.salesEqTargetM)) lines.push(`- å›åç›®æ¨™ï¼ˆå††/æœˆï¼‰ï¼š${yen(c.salesEqTargetM)}`);
      }else{
        if(Number.isFinite(c.salesEqTargetM)) lines.push(`- å£²ä¸Šæ›ç®—é¡ï¼ˆå††/æœˆï¼‰ï¼š${yen(c.salesEqTargetM)}`);
        if(Number.isFinite(c.salesEqAnnual))  lines.push(`- å£²ä¸Šæ›ç®—é¡ï¼ˆå††/å¹´ï¼‰ï¼š${yen(c.salesEqAnnual)}`);
      }
      if(Number.isFinite(c.shareY)) lines.push(`- å¹´å•†ã«å ã‚ã‚‹å‰²åˆï¼š${pct1(c.shareY)}`);

      // Step2
      lines.push("");
      lines.push("â– 2. æ‰“ã¡æ‰‹ï¼ˆé¸æŠï¼‰");
      const routeLabel =
        selectedRoute==="price" ? "å˜ä¾¡ã‚’ä¸Šã’ã‚‹" :
        selectedRoute==="volume" ? "æ•°é‡ã‚’ä¸Šã’ã‚‹" :
        selectedRoute==="auto" ? "æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ï¼ˆæ™‚é–“å‰µå‡ºï¼‰" :
        "ï¼ˆæœªé¸æŠï¼‰";
      lines.push(`- æ–¹å‘æ€§ï¼š${routeLabel}`);

      // Step3
      lines.push("");
      lines.push("â– 3. æ¬¡ã®ä¸€æ‰‹");
      const f = (id)=>String($(id)?.value ?? "").trim();
      if(f("targetScope")) lines.push(`- å¯¾è±¡ï¼š${f("targetScope")}`);
      if(f("targetGoal"))  lines.push(`- ç›®æ¨™ï¼š${f("targetGoal")}`);
      if(f("checkKpi"))    lines.push(`- ç¢ºèªæŒ‡æ¨™ï¼š${f("checkKpi")}`);
      if(f("firstAction")) lines.push(`- æœ€åˆã®ä¸€æ­©ï¼š${f("firstAction")}`);
      if(f("stopDoing"))   lines.push(`- ã‚„ã‚ã‚‹ã“ã¨ï¼š${f("stopDoing")}`);
      if(f("nextCheck"))   lines.push(`- æ¬¡å›ç¢ºèªæ—¥/å ±å‘Šç›¸æ‰‹ï¼š${f("nextCheck")}`);
      if(f("freeMemo"))    lines.push(`- ãƒ¡ãƒ¢ï¼š${f("freeMemo")}`);

      return lines.join("\n");
    }

    async function copyToClipboard(text){
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(text);
          return true;
        }
      }catch(e){}
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      }catch(e){}
      return false;
    }

    // =========================
    // â˜…ä¿®æ­£ï¼šç”»åƒç”Ÿæˆå‡¦ç†
    // =========================
    function generateAndDownloadCard() {
      // 1. å€¤ã®ã‚»ãƒƒãƒˆ
      const f = (id)=>String($(id)?.value ?? "").trim();
      
      const scopeVal  = f("targetScope") || "-";
      const goalVal   = f("targetGoal")  || "-";
      const actionVal = f("firstAction") || "æœªå…¥åŠ›";
      const stopVal   = f("stopDoing")   || "-";
      const kpiVal    = f("checkKpi")    || "-";
      const nextVal   = f("nextCheck")   || "-";

      $("card-scope").textContent  = scopeVal;
      $("card-goal").textContent   = goalVal;
      $("card-action").textContent = actionVal;
      $("card-stop").textContent   = stopVal;
      $("card-kpi").textContent    = kpiVal;
      $("card-next").textContent   = nextVal;

      const d = new Date();
      $("card-date").textContent = `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;

      // 2. html2canvaså®Ÿè¡Œ
      const area = $("capture-area");
      showImportToast("ç”»åƒã‚’ä½œæˆä¸­...");

      html2canvas(area, {
        scale: 2, // é«˜è§£åƒåº¦
        useCORS: true
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'è¡Œå‹•å®£è¨€ã‚·ãƒ¼ãƒˆ.png';
        link.href = canvas.toDataURL("image/png");
        link.click();
        showImportToast("ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      }).catch(err => {
        console.error(err);
        showImportToast("ç”»åƒã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
      });
    }


    // =========================
    // ã‚¯ãƒªãƒƒã‚¯æŒ™å‹•ï¼ˆã‚«ãƒ¼ãƒ‰å…¨ä½“ï¼‰
    // =========================
    document.querySelectorAll('.bigCard').forEach(card => {
      card.addEventListener('click', (e) => {
        if(e.target.tagName === 'BUTTON') return;
        const target = card.getAttribute('data-target');
        if(target){
          setRoute(target);
          render();
        }
      });
    });

    // init
    bindLiveFormatting(document);
    buildRecoveryChips();

    $("modeMonthly").addEventListener("click", ()=>setSpendMode("monthly"));
    $("modeYearly").addEventListener("click",  ()=>setSpendMode("yearly"));
    $("modeOnce").addEventListener("click",    ()=>setSpendMode("once"));

    setSpendMode("monthly");

    // restoreï¼ˆç«¯æœ«ä¿å­˜ï¼‰
    const st = load();
    restore(st);

    // URLå—ä¿¡ï¼ˆã‚ã‚Œã°ä¸Šæ›¸ãï¼‰
    checkUrlParams();

    bindLiveFormatting(document);
    document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
    document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);

    [
      "spendMonthly","spendYearly","spendOnce","recoveryMonths","cmr","annualSales",
      "targetScope","checkKpi","targetGoal","firstAction","stopDoing","nextCheck","freeMemo"
    ].forEach(id=>{
      if($(id)){
        $(id).addEventListener("input", ()=>{
          if(id==="recoveryMonths") syncRecoveryChipsFromInput();
          render();
        });
      }
    });

    document.querySelectorAll("[data-pick]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const r = btn.getAttribute("data-pick");
        setRoute(r);
        render();
      });
    });
    $("btnBack").addEventListener("click", ()=>{ setRoute(""); render(); });

    $("btnOpenTool").addEventListener("click", ()=>{
      const url = getToolUrl();
      if(!url){ alert("ãƒ„ãƒ¼ãƒ«URLãŒæœªè¨­å®šã§ã™ã€‚"); return; }
      openModal(getToolTitle(), url);
    });
    $("btnOpenToolNewTab").addEventListener("click", ()=>{
      const url = getToolUrl();
      if(!url){ alert("ãƒ„ãƒ¼ãƒ«URLãŒæœªè¨­å®šã§ã™ã€‚"); return; }
      window.open(url, "_blank", "noopener,noreferrer");
    });

    $("btnClose").addEventListener("click", closeModal);
    $("modalBack").addEventListener("click", (e)=>{ if(e.target === $("modalBack")) closeModal(); });
    $("btnOpenNewTab2").addEventListener("click", ()=>{
      if(!currentUrl) return;
      window.open(currentUrl, "_blank", "noopener,noreferrer");
    });

    // Escã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆä»»æ„ï¼‰
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && $("modalBack").style.display === "flex"){
        closeModal();
      }
    });

    // ä¸‹éƒ¨ãƒœã‚¿ãƒ³
    $("btnPrint").addEventListener("click", ()=>window.print());
    $("btnReset").addEventListener("click", doReset);
    $("btnResetTop").addEventListener("click", doReset);

    $("btnCopy").addEventListener("click", async ()=>{
      const text = buildSummaryText();
      const ok = await copyToClipboard(text);
      showImportToast(ok ? "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ" : "ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
    });

    // â˜…è¿½åŠ ï¼šä¿å­˜ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    $("btnSaveCard").addEventListener("click", generateAndDownloadCard);

    // åˆå›æç”»
    render();
  </script>
</body>
</html>
