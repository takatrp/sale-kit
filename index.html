<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>打ち手検討ツール</title>

  <!-- Favicon（ご指定） -->
  <link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png" />
  <link rel="apple-touch-icon" href="favicon192192.png" />
  <meta name="theme-color" content="#578899" />

  <style>
    :root{
      --bg:#f4f9fb; --card:#ffffff; --ink:#2b3a3d; --muted:#5a6a6d;
      --accent:#578899; --accent-2:#7aa2b0; --shadow:0 10px 30px rgba(35,80,90,.12); --radius:16px;
      --border:#d9eaed; --blue:#1a6ea0;
      --soft:#f8fcfd;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic UI","YuGothic","Noto Sans JP","Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased;
    }
    .wrap{
      padding:max(12px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
              calc(16px + env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
      max-width:920px; margin:0 auto;
    }

    header{padding:8px 6px 2px;}
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{height:48px; width:auto; object-fit:contain;}
    .logo-link{display:inline-flex; align-items:center; line-height:0;}
    .title{
      flex:1; min-width:0;
      font-weight:900; letter-spacing:.02em; line-height:1.2; margin:0;
      white-space:nowrap;
      font-size:clamp(18px, 5.2vw, 30px); /* タイトルを少し大きく */
    }
    .subtitle{color:var(--muted); font-size:12px; margin:6px 0 0 0;}

    /* 上部リセット（小さめ） */
    .top-actions{margin-left:auto; display:flex; gap:8px; align-items:center;}
    .top-btn{
      border:1px solid var(--border);
      background:#eef7f9;
      color:#3f7c8e;
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .top-btn:active{transform:translateY(1px);}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 16px;
      margin:12px 0 18px;
      break-inside:avoid;
    }
    .card h2{margin:0 0 10px; font-size:18px; font-weight:900; color:#324245; letter-spacing:.01em;}
    .desc{color:var(--muted); font-size:13px; margin:4px 0 14px; line-height:1.7;}

    .label{font-size:14px; color:var(--muted); margin:0 0 6px 2px; font-weight:800;}

    .row-two{display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:end;}
    @media (max-width:720px){ .row-two{grid-template-columns:1fr;} }

    /* 入力 */
    .inputbox, .pctbox, .readonlybox{
      display:flex; align-items:center; gap:8px;
      background:var(--soft);
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 10px;
    }
    .inputbox .prefix{font-weight:900; color:var(--accent); border-right:1px solid #e6f1f3; padding-right:8px;}
    input.money, input.pct, input.int{
      border:0; outline:none; background:transparent;
      font-size:18px; font-weight:900; color:var(--ink);
      letter-spacing:.02em;
      width:100%;
      text-align:right;
      font-feature-settings:"tnum";
      font-variant-numeric:tabular-nums;
    }
    input.pct{width:90px;}
    input::placeholder{
      color:#8fa2a6;
      opacity:.22; /* プレースホルダーを薄く */
      font-weight:800;
    }

    .inline-actions{display:flex; align-items:center; gap:10px; flex-wrap:nowrap;}
    #cmr{flex:1 1 auto; min-width:0; width:100%; height:26px; -webkit-appearance:none; background:transparent;}
    #cmr::-webkit-slider-runnable-track{height:6px; background:linear-gradient(90deg,var(--accent-2),var(--accent)); border-radius:999px;}
    #cmr::-webkit-slider-thumb{-webkit-appearance:none; width:22px; height:22px; border-radius:50%; background:#fff; border:2px solid var(--accent); margin-top:-8px; box-shadow:0 1px 6px rgba(0,0,0,.08);}
    .pctbox{gap:6px;}
    .pctbox .unit{font-weight:900; color:var(--muted);}

    /* チップ（シンプル） */
    .chip-row{display:flex; gap:8px; flex-wrap:wrap;}
    .chip{
      border:1px solid #e6f3f7;
      background:#f7fbfd;
      color:#567;
      padding:7px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:background-color .15s, color .15s, border-color .15s;
      white-space:nowrap;
    }
    .chip:hover{background:#eef7fa;}
    .chip.active{background:#cfe7ef; border-color:#9ecbd9; color:#0f4f63;}

    /* 結果 */
    .result{
      margin-top:14px;
      background:#f7fbfd;
      border:1px solid #e6f3f7;
      border-radius:14px;
      padding:14px 14px;
    }
    .amount{
      font-size:clamp(22px,7vw,34px);
      font-weight:1000;
      color:#2a6b7b;
      margin:2px 0 4px;
      font-feature-settings:"tnum";
      font-variant-numeric:tabular-nums;
    }
    .subamount{color:var(--muted); font-size:12px; font-weight:900; margin-top:2px;}
    .kpi-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .chip-like{
      background:#e9f6f8;
      border:1px dashed #8fb3c0;
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
      color:#234;
    }
    .note-soft{
      margin-top:10px;
      color:#345;
      font-size:12px;
      background:#eef7fa;
      border:1px solid #d9eaed;
      border-radius:12px;
      padding:10px 12px;
      line-height:1.7;
    }

    /* 2. 打ち手（カード一覧） */
    .route-grid{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      margin-top:8px;
    }
    @media (max-width:820px){ .route-grid{grid-template-columns:1fr;} }

    .route-card{
      border:1px solid var(--border);
      background:#ffffff;
      border-radius:16px;
      padding:14px 14px;
      cursor:pointer;
      transition:transform .12s, box-shadow .12s, border-color .12s;
      display:flex; gap:12px; align-items:flex-start;
    }
    .route-card:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(35,80,90,.10); border-color:#cfe3ea;}
    .icon{
      width:44px; height:44px; /* アイコンを大きく */
      border-radius:12px;
      background:#eef7f9;
      border:1px solid #cfe3ea;
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }
    .icon svg{width:26px; height:26px;}
    .route-title{margin:0; font-weight:1000; font-size:16px; color:#234;}
    .route-note{margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.6; font-weight:800;}

    .detail-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .back-btn{
      border:1px solid var(--border);
      background:#eef7f9;
      color:#3f7c8e;
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:1000;
      cursor:pointer;
      white-space:nowrap;
    }
    .back-btn:active{transform:translateY(1px);}

    /* 3. 次の一手 */
    textarea{
      width:100%;
      min-height:120px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      font-weight:800;
      color:var(--ink);
      background:#fbfeff;
      outline:none;
      resize:vertical;
      line-height:1.7;
    }
    textarea::placeholder{color:#8fa2a6; opacity:.22; font-weight:800;}

    /* 操作ボタンカード（白背景）※ご提示コードと同様の設計 */
    .card-actions{padding-top:10px;}
    .action-row{display:flex; gap:10px; margin:6px 0; flex-wrap:nowrap;}
    .action-row .btn{
      background:#eef7f9; color:#3f7c8e; border:1px solid #cfe3ea; box-shadow:none;
      padding:12px 14px; font-size:15px; border-radius:12px; flex:1 1 33%; white-space:nowrap;
      font-weight:1000;
      cursor:pointer;
    }
    .action-row .btn:hover{background:#e6f2f6;}
    .action-row .btn:active{transform:translateY(1px);}

    /* フッター：ツールポータル仕様（ミニ版・折返し可）※ご提示コード同様 */
    footer.mk-mini{
      margin:18px 4px 10px;
      text-align:center;
      color:#667;
      font-size:11px;
      line-height:1.6;
      white-space:normal;
      overflow-wrap:anywhere;
      text-overflow:clip;
    }
    footer.mk-mini a{
      color:inherit;
      text-decoration:underline;
      text-underline-offset:2px;
    }

    /* 印刷 */
    @page { size: auto; margin: 12mm; }
    @media print{
      body{background:#fff;}
      .card{box-shadow:none;}
      .no-print{display:none !important;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <a class="logo-link" href="https://takatrp.github.io/tool-portal/" title="ツールポータルへ">
          <img src="ロゴ.jpg" alt="松本会計事務所ロゴ" class="logo" />
        </a>
        <h1 class="title">打ち手検討ツール</h1>

        <!-- 上部にもリセット（ご要望） -->
        <div class="top-actions no-print">
          <button id="resetTop" class="top-btn" type="button">リセット</button>
        </div>
      </div>
      <div class="subtitle">支出額を売上換算 → 打ち手を検討</div>
    </header>

    <!-- 1. 売上換算 -->
    <section class="card" aria-label="売上換算">
      <h2>1. 売上換算</h2>
      <div class="desc">支出額が「売上に直すとどれくらいか」を、限界利益率で整理します（概算）。</div>

      <!-- ※赤線で不要とされていた“上部の補助チップ列（ステップ/ナビ）”は削除 -->

      <div class="row-two">
        <div>
          <div class="label">支出の種類</div>
          <div class="chip-row" role="tablist" aria-label="支出の種類">
            <button class="chip active" id="chipSpendMonthly" type="button">毎月（固定費）</button>
            <button class="chip" id="chipSpendYearly" type="button">年額（固定費）</button>
            <button class="chip" id="chipSpendOnce" type="button">単発（1回）</button>
          </div>
        </div>

        <div>
          <div class="label">限界利益率（%）</div>
          <div class="inline-actions">
            <input id="cmr" type="range" min="5" max="95" step="0.1" value="43.6" />
            <div class="pctbox">
              <input id="cmrInput" class="pct" type="text" inputmode="decimal" autocomplete="off" value="43.6" />
              <span class="unit">%</span>
            </div>
          </div>

          <div class="chip-row" style="margin-top:8px;" aria-label="参考：産業ごとの全国平均">
            <span class="label" style="margin:0 8px 0 0; font-size:12px; font-weight:900;">参考：産業ごとの全国平均</span>
            <button class="chip" type="button" data-cmr="43.6">全産業 43.6%</button>
            <button class="chip" type="button" data-cmr="64.6">漁業 64.6%</button>
            <button class="chip" type="button" data-cmr="39.9">建設業 39.9%</button>
            <button class="chip" type="button" data-cmr="44.8">製造業 44.8%</button>
            <button class="chip" type="button" data-cmr="20.5">卸売業 20.5%</button>
            <button class="chip" type="button" data-cmr="32.0">小売業 32.0%</button>
            <button class="chip" type="button" data-cmr="79.2">宿泊業 79.2%</button>
            <button class="chip" type="button" data-cmr="64.1">飲食業 64.1%</button>
          </div>
        </div>
      </div>

      <div class="row-two" style="margin-top:12px;">
        <div>
          <div class="label" id="spendLabel">今回検討する支出額（円／月）</div>
          <div class="inputbox">
            <span class="prefix">¥</span>
            <input id="spendAmount" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="例：200,000" autocomplete="off" />
          </div>
        </div>

        <div>
          <div class="label">年商（任意／円）</div>
          <div class="inputbox">
            <span class="prefix">¥</span>
            <input id="annualSales" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="例：100,000,000" autocomplete="off" />
          </div>
        </div>
      </div>

      <!-- 単発のときだけ表示：回収期間（チップ＋自由入力） -->
      <div id="onceBlock" style="margin-top:12px;" hidden>
        <div class="row-two">
          <div>
            <div class="label">回収期間（ヶ月）</div>
            <div class="chip-row no-print" aria-label="回収期間チップ">
              <button class="chip" type="button" data-months="3">3</button>
              <button class="chip active" type="button" data-months="6">6</button>
              <button class="chip" type="button" data-months="12">12</button>
              <button class="chip" type="button" data-months="24">24</button>
            </div>
          </div>
          <div>
            <div class="label">回収期間（自由入力）</div>
            <div class="inputbox">
              <input id="recoverMonths" class="int" type="text" inputmode="numeric" pattern="\d*" placeholder="例：5" autocomplete="off" />
            </div>
          </div>
        </div>

        <div class="row-two" style="margin-top:10px;">
          <div>
            <div class="label">月割り支出（自動）</div>
            <div class="readonlybox">
              <span class="prefix" style="font-weight:1000; color:var(--accent);">¥</span>
              <div id="monthlySpendAuto" style="margin-left:auto; font-weight:1000; font-variant-numeric:tabular-nums;">—</div>
            </div>
          </div>
          <div>
            <div class="label">月商（自動／年商÷12）</div>
            <div class="readonlybox">
              <span class="prefix" style="font-weight:1000; color:var(--accent);">¥</span>
              <div id="monthlySalesAuto" style="margin-left:auto; font-weight:1000; font-variant-numeric:tabular-nums;">—</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 結果 -->
      <div class="result" id="resConv" hidden>
        <div class="label" style="margin-bottom:6px;">売上換算額（総額）</div>
        <div class="amount" id="salesEqBig">—</div>
        <div class="subamount" id="salesEqSub">—</div>

        <div class="kpi-row">
          <span class="chip-like" id="monthlyTargetChip">回収目標（円／月）：—</span>
          <span class="chip-like" id="ratioChip" hidden>年商に占める割合：—</span>
        </div>

        <div class="note-soft">入力値はこの端末内で計算され、送信されません（このページ単体で完結します）。</div>
      </div>
    </section>

    <!-- 2. 打ち手を検討 -->
    <section class="card" aria-label="打ち手を検討">
      <h2>2. 打ち手を検討</h2>

      <!-- 「話し方メモ」をタイトル直下に（ご要望） -->
      <div class="note-soft" style="margin-top:0;">
        いま見えている「回収目標（円／月）」を、<b>どうやって上げるか</b>を一緒に整理します。<br>
        必要なら、ここで算出した数字をもとに、具体策（単価・数量・業務改善）に落とし込みます。
      </div>

      <!-- 3カード -->
      <div id="routeHome" class="route-grid">
        <div class="route-card" data-route="price" role="button" aria-label="単価を上げる">
          <div class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M6 16l4-4 3 3 5-7" stroke="#3f7c8e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M5 19h14" stroke="#9ecbd9" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <div class="route-title">単価を上げる</div>
            <div class="route-note">同じ数量でも、単価（価格・付加価値）を上げることで回収目標に近づけます。</div>
          </div>
        </div>

        <div class="route-card" data-route="volume" role="button" aria-label="数量を上げる">
          <div class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M4 12h16" stroke="#3f7c8e" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 4v16" stroke="#3f7c8e" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 7l10 10" stroke="#9ecbd9" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <div class="route-title">数量を上げる</div>
            <div class="route-note">必要な追加件数・入口数を、回収目標（円／月）から逆算します。</div>
          </div>
        </div>

        <div class="route-card" data-route="auto" role="button" aria-label="業務プロセスを自動化（時間創出）">
          <div class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 2a10 10 0 1010 10" stroke="#3f7c8e" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 6v6l4 2" stroke="#3f7c8e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div>
            <div class="route-title">業務プロセスを自動化（時間創出）</div>
            <div class="route-note">創出できる時間を、回収目標（円／月）に結びつける考え方で整理します。</div>
          </div>
        </div>
      </div>

      <!-- 詳細 -->
      <div id="routeDetail" hidden>
        <div class="detail-head">
          <h3 id="detailTitle" style="margin:0; font-size:16px; font-weight:1000; color:#234;">—</h3>
          <button id="btnBack" class="back-btn no-print" type="button">3つの打ち手に戻る</button>
        </div>

        <!-- 単価 -->
        <div id="detailPrice" hidden>
          <div class="desc" style="margin-top:0;">
            回収目標（円／月）を、<b>単価アップ</b>で埋めるとした場合の「必要な上げ幅」を概算します。
          </div>

          <div class="row-two">
            <div>
              <div class="label">対象とする月商（任意）</div>
              <div class="inputbox">
                <span class="prefix">¥</span>
                <input id="targetMonthlySales" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="未入力なら年商から自動計算" autocomplete="off" />
              </div>
            </div>
            <div>
              <div class="label">月商（自動／年商÷12）</div>
              <div class="readonlybox">
                <span class="prefix" style="font-weight:1000; color:var(--accent);">¥</span>
                <div id="monthlySalesAuto2" style="margin-left:auto; font-weight:1000; font-variant-numeric:tabular-nums;">—</div>
              </div>
            </div>
          </div>

          <div class="result" id="priceRes" hidden>
            <div class="label" style="margin-bottom:6px;">必要な単価アップ率（概算）</div>
            <div class="amount" id="needPriceUp">—</div>
            <div class="subamount" id="priceSub">—</div>
          </div>
        </div>

        <!-- 数量 -->
        <div id="detailVolume" hidden>
          <div class="desc" style="margin-top:0;">
            回収目標（円／月）に必要な<b>追加件数</b>と<b>入口数</b>を揃えます。
          </div>

          <div class="label">用語の言い換え（任意）</div>
          <div class="chip-row" role="tablist" aria-label="用語の言い換え">
            <button class="chip active" type="button" data-vkey="generic">汎用</button>
            <button class="chip" type="button" data-vkey="visit">来店/客数型</button>
            <button class="chip" type="button" data-vkey="order">受注/案件数型</button>
            <button class="chip" type="button" data-vkey="contract">契約型</button>
            <button class="chip" type="button" data-vkey="ship">出荷/数量型</button>
          </div>
          <!-- ※赤線で不要とされた「補足説明行」は削除（ここは置かない） -->

          <div class="row-two" style="margin-top:12px;">
            <div>
              <div class="label" id="unitRevenueLabel">取引単価（1件あたり売上）</div>
              <div class="inputbox">
                <span class="prefix">¥</span>
                <input id="unitRevenue" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="例：12,000" autocomplete="off" />
              </div>
              <!-- ※赤線で不要とされた「入力欄直下の冗長な説明」は削除 -->
            </div>
            <div>
              <div class="label" id="closeRateLabel">成約率（入口→取引）（%／任意）</div>
              <div class="pctbox">
                <input id="closeRate" class="pct" type="text" inputmode="decimal" placeholder="例：30" autocomplete="off" />
                <span class="unit">%</span>
              </div>
            </div>
          </div>

          <div class="row-two" style="margin-top:12px;">
            <div>
              <div class="label" id="workDaysLabel">稼働日数（月）（任意）</div>
              <div class="inputbox">
                <input id="workDays" class="int" type="text" inputmode="numeric" pattern="\d*" placeholder="例：25" autocomplete="off" />
              </div>
            </div>
            <div>
              <div class="label" id="dailyDealsInputLabel">日割り（1日あたり必要数）を出したい場合</div>
              <div class="readonlybox">
                <div style="margin-left:auto; font-weight:900; color:var(--muted);">稼働日数を入力してください</div>
              </div>
            </div>
          </div>

          <div class="result" id="volRes" hidden>
            <div class="label" style="margin-bottom:6px;">必要な追加取引数</div>
            <div class="amount" id="needDeals">—</div>
            <div class="kpi-row">
              <span class="chip-like" id="needDealsPerDay" hidden>—</span>
              <span class="chip-like" id="needLeads" hidden>—</span>
              <span class="chip-like" id="needLeadsPerDay" hidden>—</span>
            </div>
          </div>

          <div class="note-soft">
            数量アップは「入口を増やす」だけでなく、「成約率を上げる」でも実現できます。
          </div>
        </div>

        <!-- 自動化 -->
        <div id="detailAuto" hidden>
          <div class="desc" style="margin-top:0;">
            回収目標（円／月）を、<b>時間創出</b>で埋めるとした場合に必要な「時間」や「価値」を概算します。
          </div>

          <div class="row-two">
            <div>
              <div class="label">時間価値（円／時間）（任意）</div>
              <div class="inputbox">
                <span class="prefix">¥</span>
                <input id="valuePerHour" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="例：10,000" autocomplete="off" />
              </div>
            </div>
            <div>
              <div class="label">創出できる時間（時間／月）（任意）</div>
              <div class="inputbox">
                <input id="hoursCanMake" class="int" type="text" inputmode="numeric" pattern="\d*" placeholder="例：20" autocomplete="off" />
              </div>
            </div>
          </div>

          <div class="result" id="autoRes" hidden>
            <div class="label" style="margin-bottom:6px;">必要な時間（概算）</div>
            <div class="amount" id="needHours">—</div>
            <div class="subamount" id="autoSub">—</div>

            <div class="kpi-row">
              <span class="chip-like" id="autoGapChip" hidden>—</span>
            </div>
          </div>

          <div class="note-soft">
            ここでの「時間価値」は、<b>創出した時間を何に使うか</b>（営業・採用・品質向上など）で変わります。まずは概算でOKです。
          </div>
        </div>
      </div>
    </section>

    <!-- 3. 次の一手 -->
    <section class="card" aria-label="次の一手">
      <h2>3. 次の一手</h2>
      <div class="desc">本日の整理を踏まえて、次に何をするかをメモします（印刷してお渡しできます）。</div>
      <textarea id="nextAction" placeholder="例：
・単価：対象商品を絞り、価格改定案を1週間以内に作成
・数量：入口の定義と、月あたりの必要数を社内で共有
・業務：経理/請求/入力の現状棚卸し（30分）"></textarea>
    </section>

    <!-- 操作ボタンカード（最下部）※ご提示コードと同様に -->
    <section class="card card-actions no-print" aria-label="操作">
      <div class="action-row">
        <button id="copy" class="btn" type="button">要点をコピー</button>
        <button id="print" class="btn" type="button">印刷 / PDF</button>
        <button id="reset" class="btn" type="button">リセット</button>
      </div>
    </section>

    <!-- フッター：ツールポータル仕様（ミニ版・折返し対応）※ご提示コード同様 -->
    <footer class="mk-mini">
      © <span id="cpy-year">2025</span> <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">税理士法人松本会計事務所</a> ｜ 
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ｜ 
      <a href="/tool-portal/terms.html" target="_blank" rel="noopener">利用条件</a> ｜ 
      <span id="build-rev">r1</span>（<span id="last-updated-date"></span>）
    </footer>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    /* ========= 年号 & 最終更新日（YYYY-MM-DD） ========= */
    (function(){
      const yEl = $('#cpy-year'), dEl = $('#last-updated-date');
      const now = new Date();
      if (yEl) yEl.textContent = String(now.getFullYear());
      if (dEl) {
        const lm = new Date(document.lastModified);
        const pad = n => String(n).padStart(2,'0');
        dEl.textContent = `${lm.getFullYear()}-${pad(lm.getMonth()+1)}-${pad(lm.getDate())}`;
      }
    })();

    /* ========= フォーマット / パース ========= */
    const fmtJPY = n => n.toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0});
    const fmtPlain = n => n.toLocaleString('ja-JP',{maximumFractionDigits:0});
    const fmt1 = n => n.toLocaleString('ja-JP',{minimumFractionDigits:1, maximumFractionDigits:1});

    function normalizeDigits(str){
      if(!str) return '';
      str = String(str).replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0)-0xFEE0));
      const map={'⓪':'0','①':'1','②':'2','③':'3','④':'4','⑤':'5','⑥':'6','⑦':'7','⑧':'8','⑨':'9'};
      str = str.replace(/[⓪①②③④⑤⑥⑦⑧⑨]/g, s => map[s] || s);
      return str;
    }
    function digitsOnly(str){
      return normalizeDigits(str).replace(/[^\d]/g,'');
    }
    function parseMoney(str){
      const d = digitsOnly(str);
      return d ? Number(d) : NaN;
    }
    function parsePct(str){
      if(str==null) return NaN;
      const s = normalizeDigits(str).replace('%','').replace(',', '.').trim();
      if(s === '' || s === '.' || s === '-') return NaN;
      const v = Number(s);
      return Number.isFinite(v) ? v : NaN;
    }

    /* ========= 入力：リアルタイムカンマ（カーソル維持） ========= */
    function caretPosAfterDigits(formatted, digitsLeft){
      if(digitsLeft <= 0) return 0;
      let count = 0;
      for(let i=0;i<formatted.length;i++){
        if(/\d/.test(formatted[i])) count++;
        if(count >= digitsLeft) return i+1;
      }
      return formatted.length;
    }
    function attachMoneyInput(el, onChange){
      el.addEventListener('input', (e)=>{
        const v = e.target.value;
        const caret = e.target.selectionStart ?? v.length;
        const left = v.slice(0, caret);
        const digitsLeft = (left.match(/\d/g) || []).length;

        const d = digitsOnly(v);
        if(!d){
          e.target.value = '';
          onChange?.();
          return;
        }
        const num = Number(d);
        const formatted = num.toLocaleString('ja-JP');
        e.target.value = formatted;

        const newPos = caretPosAfterDigits(formatted, digitsLeft);
        try{ e.target.setSelectionRange(newPos, newPos); }catch{}
        onChange?.();
      });

      el.addEventListener('focus', (e)=>{
        const d = digitsOnly(e.target.value);
        if(d) e.target.value = String(Number(d));
      });
      el.addEventListener('blur', (e)=>{
        const d = digitsOnly(e.target.value);
        e.target.value = d ? Number(d).toLocaleString('ja-JP') : '';
      });
    }

    /* ========= ％入力（末尾ドット維持 / 端末差の小数点正規化） ========= */
    function attachPctInput(el, onChange){
      el.addEventListener('input', ()=>{
        let s = String(el.value ?? '');
        s = normalizeDigits(s).replace(/[%\s]/g,'');
        s = s.replace(/[，、・]/g,'.');

        if(s === '' || s === '.' || s === '-' || /^(\d+)\.$/.test(s)){
          el.value = s; // 入力途中を維持
          onChange?.();
          return;
        }
        const v = Number(s);
        if(Number.isFinite(v)){
          el.value = String(v);
          onChange?.();
        }else{
          onChange?.();
        }
      });
    }

    /* ========= 状態（localStorage） ========= */
    const STORE_KEY = 'mk_strategy_tool_r1';
    function saveState(){
      const state = {
        spendType,
        spendAmount: $('#spendAmount').value,
        cmr: $('#cmrInput').value,
        annualSales: $('#annualSales').value,
        recoverMonths: $('#recoverMonths').value,
        route: selectedRoute,
        vkey: volumeLabelKey,
        targetMonthlySales: $('#targetMonthlySales').value,
        unitRevenue: $('#unitRevenue').value,
        closeRate: $('#closeRate').value,
        workDays: $('#workDays').value,
        valuePerHour: $('#valuePerHour').value,
        hoursCanMake: $('#hoursCanMake').value,
        nextAction: $('#nextAction').value
      };
      try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch{}
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch{ return null; }
    }

    /* ========= 1. 売上換算（単発/固定費 切替） ========= */
    let spendType = 'monthly'; // monthly | yearly | once
    const spendLabelEl = $('#spendLabel');
    const onceBlock = $('#onceBlock');

    const chipSpendMonthly = $('#chipSpendMonthly');
    const chipSpendYearly  = $('#chipSpendYearly');
    const chipSpendOnce    = $('#chipSpendOnce');

    function setChipActive(btn, group){
      group.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    function setSpendType(t){
      spendType = t;
      setChipActive(
        t==='monthly'?chipSpendMonthly : t==='yearly'?chipSpendYearly : chipSpendOnce,
        [chipSpendMonthly, chipSpendYearly, chipSpendOnce]
      );

      if(t==='monthly'){
        spendLabelEl.textContent = '今回検討する支出額（円／月）';
        onceBlock.hidden = true;
      }else if(t==='yearly'){
        spendLabelEl.textContent = '今回検討する支出額（円／年）';
        onceBlock.hidden = true;
      }else{
        spendLabelEl.textContent = '今回検討する支出額（円／1回）';
        onceBlock.hidden = false;
      }
      recalcAll();
      saveState();
    }

    chipSpendMonthly.addEventListener('click', ()=> setSpendType('monthly'));
    chipSpendYearly .addEventListener('click', ()=> setSpendType('yearly'));
    chipSpendOnce   .addEventListener('click', ()=> setSpendType('once'));

    /* 限界利益率（slider連動） */
    const cmrR = $('#cmr');
    const cmrI = $('#cmrInput');
    function setCmr(v){
      const n = Number(v);
      if(!Number.isFinite(n)) return;
      cmrR.value = n.toFixed(1);
      cmrI.value = n.toFixed(1);
    }
    setCmr(43.6);
    cmrR.addEventListener('input', ()=>{ cmrI.value = (+cmrR.value).toFixed(1); recalcAll(); saveState(); });
    attachPctInput(cmrI, ()=>{
      const v = parsePct(cmrI.value);
      if(Number.isFinite(v)) cmrR.value = v;
      recalcAll(); saveState();
    });

    /* 全国平均チップ：クリックでCMR入力 */
    $$('.chip-row button[data-cmr]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const v = Number(btn.getAttribute('data-cmr'));
        if(Number.isFinite(v)){
          setCmr(v);
          recalcAll();
          saveState();
        }
      });
    });

    /* 金額入力 */
    attachMoneyInput($('#spendAmount'), ()=>{ recalcAll(); saveState(); });
    attachMoneyInput($('#annualSales'), ()=>{ recalcAll(); saveState(); });
    attachMoneyInput($('#targetMonthlySales'), ()=>{ recalcAll(); saveState(); });

    /* 単発：回収期間 */
    const recoverMonthsEl = $('#recoverMonths');
    attachMoneyInput(recoverMonthsEl, ()=>{ recalcAll(); saveState(); }); // moneyフォーマッタでOK（整数用途）

    function setRecoverMonths(m){
      const n = Number(m);
      if(!Number.isFinite(n) || n<=0) return;
      recoverMonthsEl.value = String(n);
      // チップのactive
      $$('#onceBlock .chip-row button[data-months]').forEach(b=>{
        b.classList.toggle('active', Number(b.getAttribute('data-months'))===n);
      });
      recalcAll();
      saveState();
    }
    $$('#onceBlock .chip-row button[data-months]').forEach(btn=>{
      btn.addEventListener('click', ()=> setRecoverMonths(btn.getAttribute('data-months')));
    });

    /* ========= 2. 打ち手：画面切替 ========= */
    let selectedRoute = null; // price | volume | auto
    const routeHome = $('#routeHome');
    const routeDetail = $('#routeDetail');
    const detailTitle = $('#detailTitle');
    const btnBack = $('#btnBack');

    const detailPrice = $('#detailPrice');
    const detailVolume = $('#detailVolume');
    const detailAuto = $('#detailAuto');

    function showRouteHome(){
      selectedRoute = null;
      routeHome.hidden = false;
      routeDetail.hidden = true;
      detailPrice.hidden = true;
      detailVolume.hidden = true;
      detailAuto.hidden = true;
      saveState();
    }
    function showRoute(route){
      selectedRoute = route;
      routeHome.hidden = true;
      routeDetail.hidden = false;

      detailPrice.hidden = route!=='price';
      detailVolume.hidden = route!=='volume';
      detailAuto.hidden = route!=='auto';

      if(route==='price') detailTitle.textContent = '単価を上げる（深掘り）';
      if(route==='volume') detailTitle.textContent = '数量を上げる（深掘り）';
      if(route==='auto') detailTitle.textContent = '業務プロセスを自動化（時間創出）（深掘り）';

      recalcAll();
      saveState();
    }

    $$('.route-card').forEach(card=>{
      card.addEventListener('click', ()=> showRoute(card.getAttribute('data-route')));
    });
    btnBack.addEventListener('click', showRouteHome);

    /* ========= 数量：用語切替（ラベルセット） ========= */
    const VOLUME_LABEL_SETS = {
      generic:  { unitPriceLabel:'取引単価（1件あたり売上）', dealLabel:'取引', leadLabel:'入口', daysLabel:'稼働日数（月）' },
      visit:    { unitPriceLabel:'客単価（1回あたり売上）',   dealLabel:'来店', leadLabel:'問い合わせ/来店', daysLabel:'稼働日数（月）' },
      order:    { unitPriceLabel:'案件単価（1件あたり売上）', dealLabel:'受注', leadLabel:'問い合わせ/見積', daysLabel:'稼働日数（月）' },
      contract: { unitPriceLabel:'契約単価（1件あたり売上）', dealLabel:'契約', leadLabel:'問い合わせ/商談', daysLabel:'稼働日数（月）' },
      ship:     { unitPriceLabel:'出荷単価（1件あたり売上）', dealLabel:'出荷', leadLabel:'見込み', daysLabel:'稼働日数（月）' }
    };
    let volumeLabelKey = 'generic';

    function applyVolumeLabels(){
      const L = VOLUME_LABEL_SETS[volumeLabelKey] || VOLUME_LABEL_SETS.generic;
      $('#unitRevenueLabel').textContent = L.unitPriceLabel;
      $('#closeRateLabel').textContent = `成約率（${L.leadLabel}→${L.dealLabel}）（%／任意）`;
      $('#workDaysLabel').textContent = `${L.daysLabel}（任意）`;
    }

    attachMoneyInput($('#unitRevenue'), ()=>{ recalcAll(); saveState(); });
    attachPctInput($('#closeRate'), ()=>{ recalcAll(); saveState(); });
    attachMoneyInput($('#workDays'), ()=>{ recalcAll(); saveState(); });

    $$('#detailVolume .chip-row button[data-vkey]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        volumeLabelKey = btn.getAttribute('data-vkey');
        $$('#detailVolume .chip-row button[data-vkey]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        applyVolumeLabels();
        recalcAll();
        saveState();
      });
    });

    /* ========= 自動化 ========= */
    attachMoneyInput($('#valuePerHour'), ()=>{ recalcAll(); saveState(); });
    attachMoneyInput($('#hoursCanMake'), ()=>{ recalcAll(); saveState(); });

    /* ========= 3. 次の一手 ========= */
    $('#nextAction').addEventListener('input', saveState);

    /* ========= 中核計算 ========= */
    const resConv = $('#resConv');
    const salesEqBig = $('#salesEqBig');
    const salesEqSub = $('#salesEqSub');
    const monthlyTargetChip = $('#monthlyTargetChip');
    const ratioChip = $('#ratioChip');

    const monthlySpendAuto = $('#monthlySpendAuto');
    const monthlySalesAuto = $('#monthlySalesAuto');
    const monthlySalesAuto2 = $('#monthlySalesAuto2');

    const priceRes = $('#priceRes');
    const needPriceUp = $('#needPriceUp');
    const priceSub = $('#priceSub');

    const volRes = $('#volRes');
    const needDeals = $('#needDeals');
    const needDealsPerDay = $('#needDealsPerDay');
    const needLeads = $('#needLeads');
    const needLeadsPerDay = $('#needLeadsPerDay');

    const autoRes = $('#autoRes');
    const needHours = $('#needHours');
    const autoSub = $('#autoSub');
    const autoGapChip = $('#autoGapChip');

    let calc = {
      rate: 0,
      spend: 0,
      annualSales: NaN,
      monthlySales: NaN,
      salesEqTotal: NaN,     // 売上換算（総額）
      monthlyTarget: NaN,    // 回収目標（円/月）
      recoverMonths: NaN
    };

    function recalcConversion(){
      const ratePct = parsePct(cmrI.value);
      const rate = Number.isFinite(ratePct) ? ratePct/100 : NaN;
      const spend = parseMoney($('#spendAmount').value);
      const annualSales = parseMoney($('#annualSales').value);
      const monthlySales = (annualSales>0) ? annualSales/12 : NaN;

      calc.rate = rate;
      calc.spend = spend;
      calc.annualSales = annualSales;
      calc.monthlySales = monthlySales;

      // 単発：回収期間
      let recoverMonths = NaN;
      if(spendType === 'once'){
        const m = parseMoney(recoverMonthsEl.value);
        recoverMonths = (m>0) ? m : 6; // 未入力ならデフォルト6
        // チップのactive同期
        $$('#onceBlock .chip-row button[data-months]').forEach(b=>{
          b.classList.toggle('active', Number(b.getAttribute('data-months'))===recoverMonths);
        });
      }
      calc.recoverMonths = recoverMonths;

      // 月商自動表示（単発ブロック/単価ブロック）
      monthlySalesAuto.textContent = (monthlySales>0) ? fmtPlain(Math.round(monthlySales)) : '—';
      monthlySalesAuto2.textContent = (monthlySales>0) ? fmtPlain(Math.round(monthlySales)) : '—';

      if(!(rate>0) || !(spend>0)){
        resConv.hidden = true;
        calc.salesEqTotal = NaN;
        calc.monthlyTarget = NaN;
        return;
      }

      let salesEqTotal = 0;
      let monthlyTarget = 0;

      if(spendType === 'monthly'){
        const salesEqMonthly = Math.ceil(spend / rate);
        salesEqTotal = salesEqMonthly * 12;
        monthlyTarget = salesEqMonthly;

        salesEqBig.textContent = `${fmtJPY(salesEqMonthly)} / 月`;
        salesEqSub.textContent = `（年 ${fmtJPY(salesEqTotal)}）`;

      }else if(spendType === 'yearly'){
        salesEqTotal = Math.ceil(spend / rate);
        monthlyTarget = Math.ceil(salesEqTotal / 12);

        salesEqBig.textContent = `${fmtJPY(salesEqTotal)} / 年`;
        salesEqSub.textContent = `（月 ${fmtJPY(monthlyTarget)}）`;

      }else{ // once
        salesEqTotal = Math.ceil(spend / rate);
        const m = recoverMonths > 0 ? recoverMonths : 6;
        monthlyTarget = Math.ceil(salesEqTotal / m);

        // 月割り支出
        const ms = Math.round(spend / m);
        monthlySpendAuto.textContent = (ms>0) ? fmtPlain(ms) : '—';

        salesEqBig.textContent = `${fmtJPY(salesEqTotal)}`;
        salesEqSub.textContent = `（単発1回・回収期間 ${m} ヶ月 → 月 ${fmtJPY(monthlyTarget)}）`;
      }

      calc.salesEqTotal = salesEqTotal;
      calc.monthlyTarget = monthlyTarget;

      monthlyTargetChip.textContent = `回収目標（円／月）：${fmtJPY(monthlyTarget)}`;

      // 年商比率
      if(annualSales > 0){
        const pct = (salesEqTotal / annualSales) * 100;
        ratioChip.hidden = false;
        ratioChip.textContent = `年商に占める割合：${pct.toFixed(1)}%`;
      }else{
        ratioChip.hidden = true;
      }

      resConv.hidden = false;

      // 単発ブロックの月商自動は、単発のときだけ表示済み
    }

    function recalcPrice(){
      if(selectedRoute !== 'price') return;

      const mt = calc.monthlyTarget;
      const monthlySales = calc.monthlySales;

      if(!(mt>0)){
        priceRes.hidden = true;
        return;
      }

      // 対象月商（任意）優先
      const tms = parseMoney($('#targetMonthlySales').value);
      const base = (tms>0) ? tms : monthlySales;

      if(!(base>0)){
        priceRes.hidden = false;
        needPriceUp.textContent = '—';
        priceSub.textContent = '年商（任意）を入力するか、「対象とする月商」を入力してください。';
        return;
      }

      const ratio = (mt / base) * 100;
      priceRes.hidden = false;
      needPriceUp.textContent = `${ratio.toFixed(1)}%`;
      priceSub.textContent = `回収目標 ${fmtJPY(mt)} を、月商 ${fmtJPY(Math.round(base))} に対して単価で埋める場合の概算です。`;
    }

    function recalcVolume(){
      if(selectedRoute !== 'volume') return;

      const mt = calc.monthlyTarget;
      const unit = parseMoney($('#unitRevenue').value);
      const cr = parsePct($('#closeRate').value); // %
      const days = parseMoney($('#workDays').value);

      if(!(mt>0) || !(unit>0)){
        volRes.hidden = true;
        return;
      }

      const L = VOLUME_LABEL_SETS[volumeLabelKey] || VOLUME_LABEL_SETS.generic;

      const deals = mt / unit; // 追加取引数（月）
      volRes.hidden = false;
      needDeals.textContent = `${fmt1(deals)} ${L.dealLabel} / 月`;

      if(days>0){
        const perDay = deals / days;
        needDealsPerDay.hidden = false;
        needDealsPerDay.textContent = `1日あたり：${fmt1(perDay)} ${L.dealLabel} / 日（稼働${days}日）`;
      }else{
        needDealsPerDay.hidden = true;
      }

      if(Number.isFinite(cr) && cr>0){
        const leads = deals / (cr/100);
        needLeads.hidden = false;
        needLeads.textContent = `${fmt1(leads)} ${L.leadLabel} / 月（成約率 ${cr.toFixed(1)}%）`;

        if(days>0){
          needLeadsPerDay.hidden = false;
          needLeadsPerDay.textContent = `1日あたり：${fmt1(leads/days)} ${L.leadLabel} / 日（稼働${days}日）`;
        }else{
          needLeadsPerDay.hidden = true;
        }
      }else{
        needLeads.hidden = true;
        needLeadsPerDay.hidden = true;
      }
    }

    function recalcAuto(){
      if(selectedRoute !== 'auto') return;

      const mt = calc.monthlyTarget;
      const vph = parseMoney($('#valuePerHour').value); // 円/時間
      const hcan = parseMoney($('#hoursCanMake').value); // 時間/月

      if(!(mt>0)){
        autoRes.hidden = true;
        return;
      }

      if(!(vph>0)){
        autoRes.hidden = false;
        needHours.textContent = '—';
        autoSub.textContent = '時間価値（円/時間）を入力すると、必要な時間を概算できます。';
        autoGapChip.hidden = true;
        return;
      }

      const need = mt / vph;
      autoRes.hidden = false;
      needHours.textContent = `${fmt1(need)} 時間 / 月`;
      autoSub.textContent = `回収目標 ${fmtJPY(mt)} を、時間価値 ¥${fmtPlain(vph)}/時間 で埋める場合の概算です。`;

      if(hcan>0){
        const createdValue = hcan * vph;
        const gap = createdValue - mt;
        autoGapChip.hidden = false;
        autoGapChip.textContent = `創出 ${fmt1(hcan)} 時間 → 価値 ¥${fmtPlain(createdValue)} ／ 差分 ${gap>=0?'+':''}¥${fmtPlain(gap)}`;
      }else{
        autoGapChip.hidden = true;
      }
    }

    function recalcAll(){
      // 単発：回収期間 未入力ならデフォルト6（表示用）
      if(spendType==='once'){
        if(!digitsOnly(recoverMonthsEl.value)){
          recoverMonthsEl.value = '6';
          // money formatter blur待ちではなく即反映
          $$('#onceBlock .chip-row button[data-months]').forEach(b=>{
            b.classList.toggle('active', Number(b.getAttribute('data-months'))===6);
          });
        }
      }

      applyVolumeLabels();
      recalcConversion();
      recalcPrice();
      recalcVolume();
      recalcAuto();
    }

    /* ========= コピー / 印刷 / リセット ========= */
    function buildCopyText(){
      const lines = [];
      const rate = parsePct(cmrI.value);
      const spend = parseMoney($('#spendAmount').value);

      lines.push('【打ち手検討ツール】');
      if(Number.isFinite(rate)) lines.push(`限界利益率：${rate.toFixed(1)}%`);

      const typeLabel = (spendType==='monthly') ? '毎月（固定費）'
                      : (spendType==='yearly')  ? '年額（固定費）'
                      : '単発（1回）';
      lines.push(`支出の種類：${typeLabel}`);

      if(spend>0){
        const unit = (spendType==='monthly') ? '／月' : (spendType==='yearly') ? '／年' : '（1回）';
        lines.push(`支出額：¥${fmtPlain(spend)} ${unit}`);
      }

      if(calc.salesEqTotal>0){
        lines.push(`売上換算（総額）：¥${fmtPlain(calc.salesEqTotal)}`);
      }
      if(calc.monthlyTarget>0){
        lines.push(`回収目標（円／月）：¥${fmtPlain(calc.monthlyTarget)}`);
      }
      if(calc.annualSales>0){
        lines.push(`年商：¥${fmtPlain(calc.annualSales)}（月商：¥${fmtPlain(Math.round(calc.annualSales/12))}）`);
        const pct = (calc.salesEqTotal/calc.annualSales)*100;
        lines.push(`年商に占める割合：${pct.toFixed(1)}%`);
      }

      if(spendType==='once'){
        const m = calc.recoverMonths>0 ? calc.recoverMonths : 6;
        lines.push(`回収期間：${m} ヶ月`);
      }

      // 選択ルート
      if(selectedRoute){
        lines.push('');
        if(selectedRoute==='price'){
          lines.push('【打ち手：単価を上げる】');
          if(!priceRes.hidden){
            lines.push(`必要な単価アップ率（概算）：${needPriceUp.textContent}`);
          }
        }
        if(selectedRoute==='volume'){
          const L = VOLUME_LABEL_SETS[volumeLabelKey] || VOLUME_LABEL_SETS.generic;
          lines.push(`【打ち手：数量を上げる】（用語：${L.dealLabel}/${L.leadLabel}）`);
          if(!volRes.hidden){
            lines.push(`追加${L.dealLabel}数：${needDeals.textContent}`);
            if(!needDealsPerDay.hidden) lines.push(needDealsPerDay.textContent);
            if(!needLeads.hidden) lines.push(needLeads.textContent);
            if(!needLeadsPerDay.hidden) lines.push(needLeadsPerDay.textContent);
          }
        }
        if(selectedRoute==='auto'){
          lines.push('【打ち手：業務プロセスを自動化（時間創出）】');
          if(!autoRes.hidden){
            lines.push(`必要な時間（概算）：${needHours.textContent}`);
            if(!autoGapChip.hidden) lines.push(autoGapChip.textContent);
          }
        }
      }

      const memo = ($('#nextAction').value || '').trim();
      if(memo){
        lines.push('');
        lines.push('【次の一手】');
        lines.push(memo);
      }

      return lines.join('\n');
    }

    async function copyToClipboard(text){
      try{
        if(navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(text);
        }else{
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }
        alert('要点をコピーしました。');
      }catch{
        alert('コピーに失敗しました。');
      }
    }

    $('#copy').addEventListener('click', ()=> copyToClipboard(buildCopyText()));
    $('#print').addEventListener('click', ()=> window.print());

    function resetAll(){
      // 入力
      $('#spendAmount').value = '';
      $('#annualSales').value = '';
      $('#targetMonthlySales').value = '';
      $('#unitRevenue').value = '';
      $('#closeRate').value = '';
      $('#workDays').value = '';
      $('#valuePerHour').value = '';
      $('#hoursCanMake').value = '';
      $('#nextAction').value = '';

      // 既定
      setCmr(43.6);
      setSpendType('monthly');
      volumeLabelKey = 'generic';
      $$('#detailVolume .chip-row button[data-vkey]').forEach(b=>{
        b.classList.toggle('active', b.getAttribute('data-vkey')==='generic');
      });
      applyVolumeLabels();

      // 単発デフォルト
      recoverMonthsEl.value = '6';
      $$('#onceBlock .chip-row button[data-months]').forEach(b=>{
        b.classList.toggle('active', Number(b.getAttribute('data-months'))===6);
      });

      // 画面
      showRouteHome();

      // 表示
      resConv.hidden = true;
      priceRes.hidden = true;
      volRes.hidden = true;
      autoRes.hidden = true;

      try{ localStorage.removeItem(STORE_KEY); }catch{}
      window.scrollTo({top:0, behavior:'smooth'});
    }

    $('#reset').addEventListener('click', resetAll);
    $('#resetTop').addEventListener('click', resetAll);

    /* ========= 初期化：localStorage復元 + URLパラメータ対応（任意） ========= */
    function applyState(st){
      if(!st) return;

      // 支出タイプ
      if(st.spendType==='monthly' || st.spendType==='yearly' || st.spendType==='once'){
        spendType = st.spendType;
      }
      // 値
      $('#spendAmount').value = st.spendAmount ?? '';
      $('#cmrInput').value = st.cmr ?? '43.6';
      const v = parsePct($('#cmrInput').value);
      if(Number.isFinite(v)) cmrR.value = v;

      $('#annualSales').value = st.annualSales ?? '';
      $('#recoverMonths').value = st.recoverMonths ?? '';
      $('#targetMonthlySales').value = st.targetMonthlySales ?? '';
      $('#unitRevenue').value = st.unitRevenue ?? '';
      $('#closeRate').value = st.closeRate ?? '';
      $('#workDays').value = st.workDays ?? '';
      $('#valuePerHour').value = st.valuePerHour ?? '';
      $('#hoursCanMake').value = st.hoursCanMake ?? '';
      $('#nextAction').value = st.nextAction ?? '';

      // 用語
      if(st.vkey && VOLUME_LABEL_SETS[st.vkey]){
        volumeLabelKey = st.vkey;
        $$('#detailVolume .chip-row button[data-vkey]').forEach(b=>{
          b.classList.toggle('active', b.getAttribute('data-vkey')===volumeLabelKey);
        });
      }

      // タイプ反映（UI更新込み）
      setSpendType(spendType);

      // ルート復元（任意）
      if(st.route==='price' || st.route==='volume' || st.route==='auto'){
        showRoute(st.route);
      }else{
        showRouteHome();
      }
    }

    function applyQueryParams(){
      const p = new URLSearchParams(location.search);
      const s = p.get('spend');
      const r = p.get('cmr');
      const a = p.get('annual');
      const t = p.get('type');   // monthly/yearly/once
      const m = p.get('months'); // for once

      let changed = false;
      if(t && (t==='monthly' || t==='yearly' || t==='once')){ spendType = t; changed = true; }
      if(s){ $('#spendAmount').value = String(s); changed = true; }
      if(r){ $('#cmrInput').value = String(r); const v = parsePct($('#cmrInput').value); if(Number.isFinite(v)) cmrR.value = v; changed = true; }
      if(a){ $('#annualSales').value = String(a); changed = true; }
      if(m){ $('#recoverMonths').value = String(m); changed = true; }
      if(changed){
        setSpendType(spendType);
      }
    }

    // 起動
    (function init(){
      applyQueryParams();
      const st = loadState();
      if(st) applyState(st);
      recalcAll();
    })();

  </script>
</body>
</html>
