<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>打ち手検討ツール｜支出額を売上換算 → 打ち手を検討</title>
  <meta name="description" content="支出額を限界利益率で売上換算し、単価・数量・自動化のどこで回収するかを同じ画面で整理します。" />

  <link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="favicon192192.png">

  <style>
    :root{
      --brand:#578899;
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#17323a;
      --muted:#56707a;
      --line:rgba(23,50,58,.12);
      --soft:rgba(87,136,153,.10);
      --shadow:0 10px 28px rgba(20,40,50,.10);
      --r:16px;

      --danger:#b42318;
      --dangerSoft:rgba(180,35,24,.08);
      --focus:rgba(87,136,153,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height:1.55;
    }
    a{color:inherit}

    .top{position:static; background:var(--bg); border-bottom:1px solid var(--line);}
    .topin{
      max-width:980px; margin:0 auto;
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0;}
    .logo{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(87,136,153,.35);
      background:#fff;
      object-fit:cover;
      display:block;
      flex:0 0 auto;
    }
    .btxt{min-width:0}
    .bttl{font-weight:900; font-size:20px; line-height:1.15; letter-spacing:.02em;}
    .bsub{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .btns{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:12px;
      padding:9px 12px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.02);
      transition:.12s transform,.12s box-shadow,.12s border-color,.12s background;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 18px rgba(20,40,50,.08); border-color:rgba(87,136,153,.35)}
    .btn.primary{background:var(--soft); border-color:rgba(87,136,153,.35)}
    .btn.ghost{background:transparent}

    .btn.back{
      background:rgba(87,136,153,.14);
      border-color:rgba(87,136,153,.60);
      color:var(--text);
      font-weight:900;
      padding:10px 14px;
    }
    .btn.back:hover{
      background:rgba(87,136,153,.20);
      border-color:rgba(87,136,153,.75);
    }

    .btn:focus-visible,
    .avgBtn:focus-visible,
    summary:focus-visible{
      outline:3px solid var(--focus);
      outline-offset:2px;
      border-radius:12px;
    }

    .wrap{max-width:980px; margin:0 auto; padding:16px 14px 34px}
    .grid{display:grid; gap:12px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }
    h2{margin:0 0 6px; font-size:18px}
    .p{margin:6px 0 0; color:var(--muted)}

    .talk{
      margin:10px 0 0;
      border:1px solid rgba(87,136,153,.28);
      background:rgba(87,136,153,.06);
      border-radius:14px;
      padding:10px 12px;
      color:var(--muted);
      font-size:12px;
    }

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:760px){ .row{grid-template-columns:1fr} }

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px; font-weight:800}
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(23,50,58,.14);
      background:#fff;
      color:var(--text);
      font-size:16px;
      outline:none;
    }

    input::placeholder, textarea::placeholder{ color: rgba(86,112,122,.45); }
    input::-webkit-input-placeholder, textarea::-webkit-input-placeholder{ color: rgba(86,112,122,.45); }
    input::-moz-placeholder, textarea::-moz-placeholder{ color: rgba(86,112,122,.45); opacity:1; }
    input:-ms-input-placeholder, textarea:-ms-input-placeholder{ color: rgba(86,112,122,.45); }

    textarea{min-height:110px; resize:vertical}
    input:focus, textarea:focus{
      border-color:rgba(87,136,153,.55);
      box-shadow:0 0 0 4px rgba(87,136,153,.16);
    }
    .help{font-size:12px; color:var(--muted); margin-top:6px}

    .err{
      margin-top:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(180,35,24,.35);
      background:var(--dangerSoft);
      color:var(--danger);
      font-size:12px;
      font-weight:900;
      display:none;
    }
    .err.show{display:block;}

    .kpi{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px}
    @media (max-width:760px){ .kpi{grid-template-columns:1fr} }
    .k{
      border:1px solid rgba(23,50,58,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(87,136,153,.04);
    }
    .k .t{font-size:12px; color:var(--muted); font-weight:800}
    .k .v{font-size:18px; font-weight:900; margin-top:6px}
    .k .v.small{font-size:14px; font-weight:900; color:var(--muted)}

    .note{
      border:1px solid rgba(87,136,153,.28);
      background:rgba(87,136,153,.06);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }

    .avgWrap{margin-top:10px}
    .avgTitle{font-size:12px; color:var(--muted); font-weight:900; margin:0 0 8px}
    .avgGrid{display:flex; flex-wrap:wrap; gap:8px}
    .avgBtn{
      appearance:none;
      border:1px solid rgba(87,136,153,.22);
      background:rgba(87,136,153,.06);
      color:var(--text);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:.12s transform,.12s box-shadow,.12s border-color,.12s background;
      user-select:none;
      white-space:nowrap;
    }
    .avgBtn:hover{transform:translateY(-1px); box-shadow:0 10px 18px rgba(20,40,50,.08); border-color:rgba(87,136,153,.35)}
    .avgBtn.active{border-color:rgba(87,136,153,.65); background:rgba(87,136,153,.12)}
    .avgBtn[aria-pressed="true"]{border-color:rgba(87,136,153,.75); background:rgba(87,136,153,.14)}

    .chooser{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width:900px){ .chooser{grid-template-columns:1fr} }
    .bigCard{
      border:1px solid rgba(23,50,58,.12);
      border-radius:16px;
      padding:14px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:140px;
    }
    .bigCard h3{margin:0; font-size:16px}
    .bigCard p{margin:0; color:var(--muted); font-size:12px}
    .bigCard .grow{flex:1}

    .detail{
      margin-top:12px;
      border:1px solid rgba(23,50,58,.12);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }

    .detailHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;

      position:sticky;
      top:0;
      z-index:5;
      background:#fff;
      padding-top:2px;
      padding-bottom:8px;
      border-bottom:1px solid rgba(23,50,58,.10);
      margin-bottom:8px;
    }
    .detailHead h3{margin:0; font-size:16px}
    .detailHead .mini{margin:4px 0 0; color:var(--muted); font-size:12px}

    .kpi2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    @media (max-width:760px){ .kpi2{grid-template-columns:1fr} }
    .k2{
      border:1px solid rgba(23,50,58,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(87,136,153,.04);
    }
    .k2 .t{font-size:12px; color:var(--muted); font-weight:800}
    .k2 .v{font-size:16px; font-weight:900; margin-top:6px}
    .k2 .v.small{font-size:13px; font-weight:900; color:var(--muted)}
    .mutedLine{margin-top:8px; color:var(--muted); font-size:12px}

    details.fold{
      margin-top:10px;
      border:1px solid rgba(87,136,153,.22);
      background:rgba(87,136,153,.04);
      border-radius:14px;
      padding:8px 10px;
    }
    details.fold summary{
      cursor:pointer;
      font-weight:900;
      color:var(--text);
      font-size:13px;
      user-select:none;
      list-style:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    details.fold summary::-webkit-details-marker{ display:none; }
    details.fold summary:before{
      content:"▸";
      display:inline-block;
      transform:translateY(-1px);
      color:var(--muted);
    }
    details.fold[open] summary:before{
      content:"▾";
    }
    details.fold .inside{
      margin-top:8px;
    }

    .modalBack{
      position:fixed; inset:0; z-index:100;
      background:rgba(10,20,25,.35);
      display:none; align-items:center; justify-content:center;
      padding:14px;
    }
    .modal{
      width:min(1040px, 96vw);
      height:min(720px, 86vh);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(23,50,58,.14);
      box-shadow:0 18px 50px rgba(0,0,0,.18);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .modalTop{
      padding:10px 12px;
      border-bottom:1px solid rgba(23,50,58,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(246,248,251,.92);
    }
    .modalTitle{font-weight:900; font-size:13px; color:var(--text); min-width:0}
    .modalTitle span{color:var(--muted); font-weight:800; font-size:12px}
    .modalFrame{flex:1; background:#fff;}
    iframe{width:100%; height:100%; border:0; background:#fff;}
    .modalHint{
      padding:10px 12px;
      border-top:1px solid rgba(23,50,58,.10);
      color:var(--muted);
      font-size:12px;
      background:#fff;
    }

    .card-actions{padding-top:10px;}
    .action-row{display:flex; gap:10px; margin:6px 0; flex-wrap:nowrap;}
    .action-row .btn{
      background:#eef7f9; color:#3f7c8e; border:1px solid #cfe3ea; box-shadow:none;
      padding:12px 14px; font-size:15px; border-radius:12px; flex:1 1 33%; white-space:nowrap;
    }
    .action-row .btn:hover{background:#e6f2f6;}
    @media (max-width:760px){
      .action-row{flex-wrap:wrap;}
      .action-row .btn{flex:1 1 100%;}
    }

    footer.mk-mini{
      margin:18px 4px 10px;
      text-align:center;
      color:#667;
      font-size:11px;
      line-height:1.6;
      white-space:normal;
      overflow-wrap:anywhere;
      text-overflow:clip;
    }
    footer.mk-mini a{
      color:inherit;
      text-decoration:underline;
      text-underline-offset:2px;
    }

    @page { size: auto; margin: 12mm; }
    @media print{
      body{background:#fff}
      .btns, .modalBack{display:none !important}
      .wrap{padding:0}
      .card{box-shadow:none; border:1px solid #ddd}
      .k, .k2{background:#fff}
      a{color:#000; text-decoration:none}
      textarea{min-height:140px}
      details.fold{border:1px solid #ddd; background:#fff;}
      details.fold summary:before{content:"";}
    }
  </style>
</head>

<body>
  <div class="top">
    <div class="topin">
      <div class="brand">
        <img class="logo" src="ロゴ.jpg" alt="ロゴ" />
        <div class="btxt">
          <div class="bttl">打ち手検討ツール</div>
          <div class="bsub">支出額を売上換算 → 打ち手を検討</div>
        </div>
      </div>

      <div class="btns">
        <button class="btn primary" id="btnResetTop">リセット</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <section class="card">
        <h2>1. 売上換算</h2>
        <div class="p">支出額が「売上に直すとどれくらいか」を、限界利益率で整理します（概算）。</div>

        <div class="avgWrap">
          <div class="avgTitle">支出の頻度</div>
          <div class="avgGrid" id="spendModeGrid">
            <button type="button" class="avgBtn" id="modeMonthly">毎月（固定費）</button>
            <button type="button" class="avgBtn" id="modeYearly">年額（固定費）</button>
            <button type="button" class="avgBtn" id="modeOnce">単発（1回）</button>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <div id="boxSpendMonthly">
              <label for="spendMonthly">支出額（円 / 月）</label>
              <input id="spendMonthly" inputmode="numeric" pattern="[0-9]*" placeholder="例：20,000" data-format="int" />
              <div class="help">例：サブスク、保守料、固定費の増加など。</div>
              <div class="err" id="spendMonthlyErr" aria-live="polite"></div>
            </div>

            <div id="boxSpendYearly" style="display:none;">
              <label for="spendYearly">支出額（円 / 年）</label>
              <input id="spendYearly" inputmode="numeric" pattern="[0-9]*" placeholder="例：240,000" data-format="int" />
              <div class="help">例：年額保守料、年間契約費など。</div>
              <div class="err" id="spendYearlyErr" aria-live="polite"></div>
            </div>

            <div id="boxSpendOnce" style="display:none;">
              <label for="spendOnce">支出額（円 / 1回）</label>
              <input id="spendOnce" inputmode="numeric" pattern="[0-9]*" placeholder="例：600,000" data-format="int" />
              <div class="err" id="spendOnceErr" aria-live="polite"></div>

              <div class="row" style="margin-top:10px;">
                <div>
                  <label for="recoveryMonths">回収期間（ヶ月）</label>

                  <div class="avgWrap" style="margin-top:6px;">
                    <div class="avgGrid" id="recoveryChipGrid" aria-label="回収期間プリセット"></div>
                    <div class="help">クリックで入力できます。自由入力も可能です。</div>
                  </div>

                  <input id="recoveryMonths" inputmode="numeric" pattern="[0-9]*" placeholder="例：12" data-format="int" />
                  <div class="help">単発支出を、この期間で回収すると仮定して「月あたりの回収目標」を出します。</div>
                  <div class="err" id="recoveryErr" aria-live="polite"></div>
                </div>
                <div>
                  <label>月割り支出（自動）</label>
                  <input id="spendMonthlyEqAuto" readonly placeholder="—" />
                </div>
              </div>
            </div>
          </div>

          <div>
            <label for="cmr">限界利益率（%）</label>
            <input id="cmr" inputmode="decimal" pattern="[0-9.]*" placeholder="例：30" data-format="decimal" />
            <div class="help">不明な場合は、まずは概算で入力（例：30）し、後で更新してもOKです。</div>
            <div class="err" id="cmrErr" aria-live="polite"></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label for="annualSales">年商（任意 / 円）</label>
            <input id="annualSales" inputmode="numeric" pattern="[0-9]*" placeholder="例：120,000,000" data-format="int" />
          </div>
          <div>
            <label>月商（自動 / 年商÷12）</label>
            <input id="monthlySalesAuto" readonly placeholder="—" />
          </div>
        </div>

        <div class="kpi">
          <div class="k">
            <div class="t" id="kpiT1">—</div>
            <div class="v" id="salesEqM">—</div>
          </div>
          <div class="k">
            <div class="t" id="kpiT2">—</div>
            <div class="v" id="salesEqY">—</div>
          </div>
          <div class="k">
            <div class="t" id="kpiT3">年商に占める割合（%）</div>
            <div class="v" id="shareY">—</div>
          </div>
        </div>

        <div class="note">
          入力値はこの端末内で計算され、送信されません（このページ単体で完結します）。
        </div>
      </section>

      <section class="card">
        <h2>2. 打ち手を検討</h2>
        <div class="p">売上換算額を「どうやって作るか」を3つの方向から検討します。</div>

        <details class="fold" id="foldTalk">
          <summary>補足（考え方）</summary>
          <div class="inside">
            <div class="talk" id="talkMemo">
              「売上換算（支出額 ÷ 限界利益率）で“必要な売上”を揃えました。次に、これを <b>単価</b>・<b>数量</b>・<b>自動化</b> のどの方向で回収するかを一緒に決めましょう。」
            </div>
          </div>
        </details>

        <div id="routeChooser" class="chooser" aria-label="打ち手の選択">
          <div class="bigCard">
            <div class="grow">
              <h3>単価を上げる</h3>
              <p>価格・値付け・客層・提供価値の見直しで、同じ労力で利益を増やす方向です。</p>
            </div>
            <button class="btn primary" data-pick="price">この方向で深掘り</button>
          </div>

          <div class="bigCard">
            <div class="grow">
              <h3>数量を上げる</h3>
              <p>「取引単価×取引数」の整理で、必要な追加件数と入口数を数字で見える化します（業種共通）。</p>
            </div>
            <button class="btn primary" data-pick="volume">この方向で深掘り</button>
          </div>

          <div class="bigCard">
            <div class="grow">
              <h3>業務プロセスを自動化（時間創出）</h3>
              <p>時間を作り、その時間で付加価値活動へ移す方向です（回収に必要な削減時間の目安が出ます）。</p>
            </div>
            <button class="btn primary" data-pick="auto">この方向で深掘り</button>
          </div>
        </div>

        <div id="routeDetail" class="detail" style="display:none;">
          <div class="detailHead">
            <div>
              <h3 id="detailTitle">—</h3>
              <div class="mini" id="detailSub">—</div>
            </div>
            <div class="btns">
              <button class="btn back" id="btnBack">3つの打ち手に戻る</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div id="detailInputA"></div>
            <div id="detailInputB"></div>
          </div>

          <div class="kpi2" id="detailKpi"></div>

          <div class="btns" style="margin-top:10px; justify-content:flex-start;">
            <button class="btn primary" id="btnOpenTool">関連ツールで確認（同一画面）</button>
            <button class="btn" id="btnOpenToolNewTab">別タブで開く</button>
          </div>

          <div class="mutedLine" id="detailHint"></div>
        </div>
      </section>

      <section class="card">
        <h2>3. 次の一手</h2>
        <div class="p">「実行（アクション）」へ落とし込むための整理です。</div>

        <div class="row" style="margin-top:12px;">
          <div>
            <label>今回の打ち手（選択結果）</label>
            <input id="selectedRouteLabel" readonly value="（未選択）" />
          </div>
          <div>
            <label>対象（商品 / 客層 / 業務など）</label>
            <input id="targetScope" placeholder="例：A商品、既存顧客の更新単価、請求業務 など" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>目標とする成果（数値）</label>
            <input id="targetGoal" placeholder="例：売上+30万円、時間-10h など" />
            <div class="help">Step1-2で試算した数字を目標として設定します。</div>
          </div>
          <div>
            <label>確認する指標（月次で見るもの）</label>
            <input id="checkKpi" placeholder="例：平均単価、粗利率、件数、月次確定日 など" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>最初の一歩（明日やること）</label>
            <input id="firstAction" placeholder="例：〇〇さんに電話する、資料を取り寄せる" />
            <div class="help">「24時間以内にできる具体的な行動」を書きます。</div>
          </div>
          <div>
            <label>そのためにやめること（劣後順位）</label>
            <input id="stopDoing" placeholder="例：定例会議、移動時間のスマホ、不要な報告書" />
            <div class="help">新しい時間を確保するために「捨てるもの」を決めます。</div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>次回確認日 / 報告相手</label>
          <input id="nextCheck" placeholder="例：来月1日の打ち合わせ（税理士の先生と）、幹部MTGなど" />
          <div class="help">「いつ」「誰と」振り返るかを決めると、実行力が高まります。</div>
        </div>

        <div style="margin-top:10px;">
          <label>自由記入（メモ）</label>
          <textarea id="freeMemo" placeholder="例：実施手順、担当、期限、想定リスクと対策など"></textarea>
        </div>
      </section>

      <section class="card card-actions" aria-label="操作">
        <div class="action-row">
          <button id="btnCopy" class="btn" type="button">要点をコピー</button>
          <button id="btnPrint" class="btn" type="button">印刷 / PDF保存</button>
          <button id="btnReset" class="btn" type="button">リセット</button>
        </div>
      </section>

      <footer class="mk-mini">
        © <span id="cpy-year">2025</span>
        <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">税理士法人松本会計事務所</a> ｜ 
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ｜ 
        <a href="/tool-portal/terms.html" target="_blank" rel="noopener">利用条件</a> ｜ 
        <span id="build-rev">r8</span>（<span id="last-updated-date"></span>）
      </footer>

    </div>

    <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="ツール表示">
      <div class="modal" role="document" aria-label="ツール本体">
        <div class="modalTop">
          <div class="modalTitle" id="modalTitle">ツールを表示 <span>（同一画面）</span></div>
          <div class="btns">
            <button class="btn" id="btnOpenNewTab2">別タブで開く</button>
            <button class="btn primary" id="btnClose">閉じる</button>
          </div>
        </div>
        <div class="modalFrame">
          <iframe id="toolFrame" title="tool"></iframe>
        </div>
        <div class="modalHint">
          もし表示されない場合は「別タブで開く」をご利用ください（ブラウザ側/ツール側の制限で埋め込み表示ができない場合があります）。
        </div>
      </div>
    </div>
  </div>

  <script>
    const TOOL_URLS = {
      price:  "https://takatrp.github.io/price-up-down-LP/",
      volume: "https://takatrp.github.io/hendou_PL_LP/",
      auto:   "https://takatrp.github.io/jidouka-kouka-LP/"
    };
    const TIME_UNIT_COST_URL = "https://takatrp.github.io/time-unit-cost/";

    const VOLUME_LABEL_SETS = {
      generic: {
        key:"generic",
        label:"汎用（おすすめ）",
        txName:"取引",
        unitPriceLabel:"取引単価（1件あたり売上）",
        unitShort:"件",
        entryLabel:"入口数（問い合わせ/来店/見積 等）",
        entryShort:"入口",
        convLabel:"成約率（入口→取引）",
        daysLabel:"稼働日数（月）",
        unitHelp:"「1件あたりの売上」でOKです（客単価/受注単価/契約単価/出荷単価など）。",
        entryHelp:"入口は、取引が生まれる前段の数です（問い合わせ、見積、商談、来店など）。",
        convHelp:"入口のうち、取引につながる割合（概算でOK）。"
      },
      visit: {
        key:"visit",
        label:"来店/客数型",
        txName:"購入",
        unitPriceLabel:"客単価（円/人）",
        unitShort:"人",
        entryLabel:"来店数（入口）",
        entryShort:"来店",
        convLabel:"購入率（来店→購入）",
        daysLabel:"営業日数（月）",
        unitHelp:"「1人あたりの売上（客単価）」の目安でOKです。",
        entryHelp:"来店数を入口として扱います（必要なら予約/問い合わせ数でもOK）。",
        convHelp:"来店のうち購入に至る割合（概算でOK）。"
      },
      order: {
        key:"order",
        label:"受注/案件数型",
        txName:"受注",
        unitPriceLabel:"受注単価（円/件）",
        unitShort:"件",
        entryLabel:"商談/見積数（入口）",
        entryShort:"商談",
        convLabel:"受注率（商談→受注）",
        daysLabel:"稼働日数（月）",
        unitHelp:"「1件あたり売上（受注単価）」の目安でOKです。",
        entryHelp:"商談・見積など、受注前段の数を入口として扱います。",
        convHelp:"商談（入口）のうち、受注に至る割合（概算でOK）。"
      },
      contract: {
        key:"contract",
        label:"契約型",
        txName:"契約",
        unitPriceLabel:"契約単価（円/件）",
        unitShort:"件",
        entryLabel:"提案/相談数（入口）",
        entryShort:"提案",
        convLabel:"契約率（提案→契約）",
        daysLabel:"稼働日数（月）",
        unitHelp:"「1契約あたりの売上（単価）」の目安でOKです。",
        entryHelp:"提案・相談など、契約前段の数を入口として扱います。",
        convHelp:"入口のうち契約に至る割合（概算でOK）。"
      },
      shipment: {
        key:"shipment",
        label:"出荷/数量型",
        txName:"出荷",
        unitPriceLabel:"出荷単価（円/個）",
        unitShort:"個",
        entryLabel:"引合い数（入口）",
        entryShort:"引合",
        convLabel:"成約率（引合→出荷）",
        daysLabel:"稼働日数（月）",
        unitHelp:"「1個あたりの売上（単価）」の目安でOKです。",
        entryHelp:"引合いなど、出荷に至る前段の数を入口として扱います。",
        convHelp:"入口のうち、成約して出荷に至る割合（概算でOK）。"
      }
    };

    const RECOVERY_PRESETS = [3, 6, 12, 24];

    const KEY = "mk_action_tool_v4";
    const $ = (id)=>document.getElementById(id);

    (function(){
      const yEl = document.getElementById("cpy-year");
      const dEl = document.getElementById("last-updated-date");
      const now = new Date();
      if (yEl) yEl.textContent = String(now.getFullYear());
      if (dEl) {
        const lm = new Date(document.lastModified);
        const pad = n => String(n).padStart(2,'0');
        dEl.textContent = `${lm.getFullYear()}-${pad(lm.getMonth()+1)}-${pad(lm.getDate())}`;
      }
    })();

    function normalizeDecimalText(s){
      return String(s ?? "")
        .trim()
        .replace(/[,，\s]/g,'')
        .replace(/[・]/g,'.');
    }
    function num(v){
      const s = normalizeDecimalText(v);
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function yen(n){
      if(!Number.isFinite(n)) return "—";
      const r = Math.round(n);
      return "¥" + r.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function pct1(n){
      if(!Number.isFinite(n)) return "—";
      return (Math.round(n*10)/10).toString() + "%";
    }
    function ceil1(n){
      if(!Number.isFinite(n)) return "—";
      return (Math.ceil(n*10)/10).toString();
    }

    function showErr(id, msg){
      const el = $(id);
      if(!el) return;
      if(msg){
        el.textContent = msg;
        el.classList.add("show");
      }else{
        el.textContent = "";
        el.classList.remove("show");
      }
    }

    function formatIntInput(el){
      const raw = String(el.value ?? "");
      const caret = (el.selectionStart ?? raw.length);
      const digitsBefore = raw.slice(0, caret).replace(/[^\d]/g, "").length;
      const digits = raw.replace(/[^\d]/g, "");
      if(digits === ""){
        el.value = "";
        return;
      }
      const formatted = digits.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      el.value = formatted;

      try{
        let newCaret = 0;
        let count = 0;
        while(newCaret < formatted.length && count < digitsBefore){
          if(/\d/.test(formatted[newCaret])) count++;
          newCaret++;
        }
        el.setSelectionRange(newCaret, newCaret);
      }catch(e){}
    }

    function formatDecimalInput(el){
      const raw = String(el.value ?? "");
      const caret = (el.selectionStart ?? raw.length);
      let normalized = raw.replace(/[,，\s]/g,'').replace(/[・]/g,'.');
      normalized = normalized.replace(/[^\d.]/g, "");
      const parts = normalized.split(".");
      if(parts.length > 2){
        normalized = parts[0] + "." + parts.slice(1).join("");
      }
      el.value = normalized;
      try{
        const newPos = Math.min(caret, el.value.length);
        el.setSelectionRange(newPos, newPos);
      }catch(e){}
    }

    function bindLiveFormatting(root=document){
      root.querySelectorAll('input[data-format="int"]').forEach(el=>{
        if(el.dataset.boundInt === "1") return;
        el.dataset.boundInt = "1";
        el.addEventListener("input", ()=>formatIntInput(el));
        el.addEventListener("blur",  ()=>formatIntInput(el));
      });
      root.querySelectorAll('input[data-format="decimal"]').forEach(el=>{
        if(el.dataset.boundDec === "1") return;
        el.dataset.boundDec = "1";
        el.addEventListener("input", ()=>formatDecimalInput(el));
        el.addEventListener("blur",  ()=>formatDecimalInput(el));
      });
    }

    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : {};
      }catch(e){ return {}; }
    }
    function save(state){
      try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){}
    }

    let selectedRoute = "";
    let detailBuiltFor = "";
    let volumeLabelKey = "generic";
    let spendMode = "monthly";

    function volLabels(){
      return VOLUME_LABEL_SETS[volumeLabelKey] || VOLUME_LABEL_SETS.generic;
    }

    function setPressed(el, pressed){
      if(!el) return;
      el.setAttribute("aria-pressed", pressed ? "true" : "false");
    }

    function setSpendMode(mode){
      spendMode = mode;

      const ids = ["modeMonthly","modeYearly","modeOnce"];
      ids.forEach(id=>{
        const b = $(id);
        b.classList.remove("active");
        setPressed(b, false);
      });

      if(mode==="monthly"){ $("modeMonthly").classList.add("active"); setPressed($("modeMonthly"), true); }
      if(mode==="yearly"){  $("modeYearly").classList.add("active");  setPressed($("modeYearly"), true); }
      if(mode==="once"){    $("modeOnce").classList.add("active");    setPressed($("modeOnce"), true); }

      $("boxSpendMonthly").style.display = (mode==="monthly") ? "" : "none";
      $("boxSpendYearly").style.display  = (mode==="yearly")  ? "" : "none";
      $("boxSpendOnce").style.display    = (mode==="once")    ? "" : "none";

      if(mode==="once"){
        const raw = String($("recoveryMonths").value ?? "").trim();
        if(raw === ""){
          $("recoveryMonths").value = "12";
          formatIntInput($("recoveryMonths"));
        }
        syncRecoveryChipsFromInput();
      }

      render();
      persist();
    }

    function parseCmr(){
      const raw = String($("cmr").value ?? "").trim();
      if(raw === "") return { valid:false, cmrPct:NaN, cmr:NaN, raw };
      const cmrPct = num(raw);
      const valid = Number.isFinite(cmrPct) && cmrPct > 0 && cmrPct <= 100;
      return { valid, cmrPct, cmr: valid ? cmrPct/100 : NaN, raw };
    }

    function parseRecoveryMonths(){
      const raw = String($("recoveryMonths").value ?? "").trim();
      if(raw === "") return { valid:false, months:NaN, raw, reason:"未入力" };
      const m = num(raw);
      const isInt = Number.isFinite(m) && Math.floor(m) === m;
      if(!isInt) return { valid:false, months:NaN, raw, reason:"整数で入力してください" };
      if(m < 1 || m > 120) return { valid:false, months:NaN, raw, reason:"1〜120の範囲で入力してください" };
      return { valid:true, months:m, raw, reason:"" };
    }

    function compute(){
      const cmrInfo = parseCmr();

      const spendM = num($("spendMonthly").value);
      const spendY = num($("spendYearly").value);
      const spendO = num($("spendOnce").value);

      const annualSales = num($("annualSales").value);
      const monthlySalesAuto = (annualSales>0) ? (annualSales/12) : 0;

      let spendPerMonth = NaN;
      let recoveryInfo = { valid:true, months:NaN, raw:"", reason:"" };

      if(spendMode==="monthly"){
        spendPerMonth = (spendM>0) ? spendM : NaN;
      }else if(spendMode==="yearly"){
        spendPerMonth = (spendY>0) ? (spendY/12) : NaN;
      }else{
        recoveryInfo = parseRecoveryMonths();
        if(spendO>0 && recoveryInfo.valid){
          spendPerMonth = spendO / recoveryInfo.months;
        }else{
          spendPerMonth = NaN;
        }
      }

      const salesEqTargetM = (cmrInfo.valid && Number.isFinite(spendPerMonth)) ? (spendPerMonth / cmrInfo.cmr) : NaN;

      const salesEqAnnual = (cmrInfo.valid)
        ? (spendMode==="monthly" ? (Number.isFinite(salesEqTargetM)? salesEqTargetM*12 : NaN)
          : spendMode==="yearly" ? (spendY>0 ? (spendY / cmrInfo.cmr) : NaN)
          : NaN)
        : NaN;

      const salesEqTotal = (cmrInfo.valid && spendMode==="once" && spendO>0) ? (spendO / cmrInfo.cmr) : NaN;

      const shareY = (annualSales>0)
        ? (spendMode==="once"
            ? (Number.isFinite(salesEqTotal) ? (salesEqTotal/annualSales*100) : NaN)
            : (Number.isFinite(salesEqAnnual) ? (salesEqAnnual/annualSales*100) : NaN))
        : NaN;

      const needPricePct = (monthlySalesAuto>0 && Number.isFinite(salesEqTargetM))
        ? (salesEqTargetM/monthlySalesAuto*100)
        : NaN;

      return {
        cmrInfo,
        spendM, spendY, spendO,
        recoveryInfo,
        spendPerMonth,
        annualSales, monthlySalesAuto,
        salesEqTargetM, salesEqAnnual, salesEqTotal,
        shareY, needPricePct
      };
    }

    function buildRecoveryChips(){
      const grid = $("recoveryChipGrid");
      if(!grid) return;
      grid.innerHTML = "";
      RECOVERY_PRESETS.forEach(m=>{
        const b = document.createElement("button");
        b.type = "button";
        b.className = "avgBtn";
        b.id = "rec_" + m;
        b.textContent = `${m}ヶ月`;
        setPressed(b, false);
        b.addEventListener("click", ()=>{
          $("recoveryMonths").value = String(m);
          formatIntInput($("recoveryMonths"));
          syncRecoveryChipsFromInput();
          render();
          persist();
        });
        grid.appendChild(b);
      });
      syncRecoveryChipsFromInput();
    }

    function syncRecoveryChipsFromInput(){
      const raw = String($("recoveryMonths").value ?? "").trim().replace(/[,，\s]/g,'');
      const v = raw ? Number(raw) : NaN;
      RECOVERY_PRESETS.forEach(m=>{
        const b = document.getElementById("rec_" + m);
        if(!b) return;
        const active = (Number.isFinite(v) && v === m);
        b.classList.toggle("active", active);
        setPressed(b, active);
      });
    }

    function buildVolumeLabelChips(container){
      const grid = document.createElement("div");
      grid.className = "avgGrid";
      Object.keys(VOLUME_LABEL_SETS).forEach(k=>{
        const item = VOLUME_LABEL_SETS[k];
        const b = document.createElement("button");
        b.type="button";
        b.className="avgBtn";
        b.dataset.vkey = item.key;
        b.textContent = item.label;
        b.classList.toggle("active", item.key===volumeLabelKey);
        setPressed(b, item.key===volumeLabelKey);

        b.addEventListener("click", ()=>{
          const keep = {
            unitPrice: $("volumeUnitPrice") ? $("volumeUnitPrice").value : "",
            convRate: $("volumeConvRate") ? $("volumeConvRate").value : "",
            days: $("volumeDays") ? $("volumeDays").value : ""
          };
          volumeLabelKey = item.key;
          detailBuiltFor = "";
          buildRouteDetailUI();
          if($("volumeUnitPrice")) $("volumeUnitPrice").value = keep.unitPrice;
          if($("volumeConvRate")) $("volumeConvRate").value = keep.convRate;
          if($("volumeDays")) $("volumeDays").value = keep.days;

          bindLiveFormatting(document);
          document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
          document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);

          updateRouteDetailKPIs();
          persist();
        });
        grid.appendChild(b);
      });
      container.appendChild(grid);
    }

    function validateStep1Errors(c){
      if(c.cmrInfo.raw !== "" && !c.cmrInfo.valid){
        showErr("cmrErr", "限界利益率は 0〜100 の範囲で入力してください。");
      }else{
        showErr("cmrErr", "");
      }

      showErr("spendMonthlyErr", "");
      showErr("spendYearlyErr", "");
      showErr("spendOnceErr", "");
      if(spendMode==="monthly"){
        const raw = String($("spendMonthly").value ?? "").trim();
        if(raw !== "" && c.spendM <= 0) showErr("spendMonthlyErr", "支出額は 0 より大きい数値で入力してください。");
      }
      if(spendMode==="yearly"){
        const raw = String($("spendYearly").value ?? "").trim();
        if(raw !== "" && c.spendY <= 0) showErr("spendYearlyErr", "支出額は 0 より大きい数値で入力してください。");
      }
      if(spendMode==="once"){
        const raw = String($("spendOnce").value ?? "").trim();
        if(raw !== "" && c.spendO <= 0) showErr("spendOnceErr", "支出額は 0 より大きい数値で入力してください。");

        if(c.recoveryInfo.raw !== "" && !c.recoveryInfo.valid){
          showErr("recoveryErr", c.recoveryInfo.reason || "回収期間を確認してください。");
        }else{
          showErr("recoveryErr", "");
        }
      }else{
        showErr("recoveryErr", "");
      }
    }

    function buildRouteDetailUI(){
      if(!selectedRoute) return;
      if(detailBuiltFor === selectedRoute) return;

      const inputA = $("detailInputA");
      const inputB = $("detailInputB");
      const kpi = $("detailKpi");

      inputA.innerHTML = "";
      inputB.innerHTML = "";
      kpi.innerHTML = "";
      $("detailHint").textContent = "";

      if(selectedRoute === "price"){
        $("detailTitle").textContent = "単価を上げる（深掘り）";
        $("detailSub").textContent   = "年商から月商（年商÷12）を自動計算し、月あたり回収目標に対する必要な上乗せ率の目安を確認します。";

        inputA.innerHTML = `<label>前提</label><div class="help">※年商を入力している場合、月商は自動計算されます（年商÷12）。</div>`;
        inputB.innerHTML = `<label>ポイント</label><div class="help">値付け・提供価値・客層の見直しで、同じ稼働でも利益を作りやすい方向です。</div>`;

        kpi.innerHTML = `
          <div class="k2">
            <div class="t">月あたり回収目標（売上換算）</div>
            <div class="v" id="kpiSalesEqM">—</div>
          </div>
          <div class="k2">
            <div class="t">必要な上乗せ率（%）※年商入力時</div>
            <div class="v" id="kpiNeedPricePct">—</div>
          </div>
        `;

        $("detailHint").textContent = "次に『どの商品/客層/契約が対象か』『いつから実施するか』を決めると、実行に落ちます。";
      }

      if(selectedRoute === "volume"){
        const L = volLabels();

        $("detailTitle").textContent = "数量を上げる（深掘り）";
        $("detailSub").textContent   = "「取引単価×取引数」で、月あたり回収目標に必要な追加件数と入口数を揃えます。";

        inputA.innerHTML = `
          <label>入力</label>

          <div class="avgWrap" style="margin-top:6px;">
            <div class="avgTitle">言い換え（任意）</div>
            <div id="volumeLabelChips"></div>
            <div class="help" style="margin-top:8px;">
              ※ここは<strong>言葉の言い換え</strong>です。計算は同じです。まずは「汎用」でOKです。
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="volumeUnitPrice">${L.unitPriceLabel}</label>
            <input id="volumeUnitPrice" inputmode="numeric" pattern="[0-9]*" placeholder="例：12,000" data-format="int" />
            <div class="help">${L.unitHelp}</div>
            <div class="err" id="volumeUnitPriceErr" aria-live="polite"></div>
          </div>

          <div style="margin-top:10px;">
            <label for="volumeConvRate">${L.convLabel}（% / 任意）</label>
            <input id="volumeConvRate" inputmode="decimal" pattern="[0-9.]*" placeholder="例：30" data-format="decimal" />
            <div class="help">${L.convHelp}</div>
            <div class="err" id="volumeConvRateErr" aria-live="polite"></div>
          </div>

          <div style="margin-top:10px;">
            <label for="volumeDays">${L.daysLabel}（任意）</label>
            <input id="volumeDays" inputmode="numeric" pattern="[0-9]*" placeholder="例：25" data-format="int" />
            <div class="help">日割り（1日あたり必要数）を出したい場合に入力してください。</div>
            <div class="err" id="volumeDaysErr" aria-live="polite"></div>
          </div>
        `;

        inputB.innerHTML = `
          <details class="fold" open>
            <summary>整理のしかた（見方）</summary>
            <div class="inside">
              <div class="help">
                ① 月あたり回収目標（必要な売上）を出す → ② ${L.unitPriceLabel} で割って<strong>必要な追加${L.txName}数</strong>を出す<br>
                ③ さらに ${L.convLabel} を使って<strong>${L.entryLabel}</strong>（前段の数）を目安で出します。
              </div>

              <div class="note" style="margin-top:10px;">
                数量アップは「入口を増やす」だけでなく、「成約率を上げる」でも実現できます。
              </div>
            </div>
          </details>
        `;

        kpi.innerHTML = `
          <div class="k2">
            <div class="t">必要な追加${L.txName}数（${L.unitShort}/月）</div>
            <div class="v" id="kpiNeedTxM">—</div>
          </div>
          <div class="k2">
            <div class="t">必要な追加${L.txName}数（${L.unitShort}/日）※日数入力時</div>
            <div class="v" id="kpiNeedTxD">—</div>
          </div>
          <div class="k2">
            <div class="t">必要な${L.entryLabel}（${L.entryShort}/月）※成約率入力時</div>
            <div class="v" id="kpiNeedEntryM">—</div>
          </div>
          <div class="k2">
            <div class="t">必要な${L.entryLabel}（${L.entryShort}/日）※成約率+日数入力時</div>
            <div class="v" id="kpiNeedEntryD">—</div>
          </div>
        `;

        $("detailHint").textContent =
          "次に『入口を増やす（施策）』か『成約率を上げる（改善）』のどちらを主軸にするかを決めると、動きやすくなります。";

        const mount = $("volumeLabelChips");
        if(mount){
          mount.innerHTML = "";
          buildVolumeLabelChips(mount);
        }

        bindLiveFormatting(document);

        const onVolInput = ()=>{
          updateRouteDetailKPIs();
          persist();
        };
        ["volumeUnitPrice","volumeConvRate","volumeDays"].forEach(id=>{
          if($(id)) $(id).addEventListener("input", onVolInput);
        });
      }

      if(selectedRoute === "auto"){
        $("detailTitle").textContent = "業務プロセスを自動化する（深掘り）";
        $("detailSub").textContent   = "支出（単発は月割り）を“削減できる時間”に置き換えて、回収の目安を確認します。";

        inputA.innerHTML = `
          <label for="hourCostInput">時間単価（円 / 時）</label>
          <input id="hourCostInput" inputmode="numeric" pattern="[0-9]*" placeholder="例：3,000" data-format="int" />
          <div class="help">社内の実態に合わせた目安でOKです（概算）。</div>
          <div class="err" id="hourCostErr" aria-live="polite"></div>

          <div class="avgWrap" style="margin-top:10px;">
            <div class="avgGrid" aria-label="時間単価計算ツール">
              <button type="button" class="avgBtn" id="btnTimeCostModal">時間単価の計算はこちら</button>
              <button type="button" class="avgBtn" id="btnTimeCostNewTab">別タブで開く</button>
            </div>
            <div class="help" style="margin-top:6px;">
              ※時間単価が不明な場合にご利用ください。
            </div>
          </div>
        `;

        inputB.innerHTML = `
          <label>ポイント</label>
          <div class="help">“空いた時間”を、単価/数量を上げる活動へ移すことで効果が大きくなります。</div>
        `;

        kpi.innerHTML = `
          <div class="k2">
            <div class="t">月あたりの支出（単発は月割り）</div>
            <div class="v" id="kpiSpendMonthlyEq">—</div>
          </div>
          <div class="k2">
            <div class="t">回収に必要な削減時間（h / 月）</div>
            <div class="v" id="kpiNeedHours">—</div>
          </div>
        `;

        $("detailHint").textContent = "『どの作業を削るか』『運用ルール』まで決めると、再現性が出ます。";

        bindLiveFormatting(document);
        if($("hourCostInput")){
          $("hourCostInput").addEventListener("input", ()=>{
            updateRouteDetailKPIs();
            persist();
          });

          $("hourCostInput").addEventListener("input", ()=>{
            const raw = String($("hourCostInput").value ?? "").trim();
            const v = num(raw);
            if(raw !== "" && v <= 0) showErr("hourCostErr", "時間単価は 0 より大きい数値で入力してください。");
            else showErr("hourCostErr", "");
          });
        }

        const b1 = $("btnTimeCostModal");
        const b2 = $("btnTimeCostNewTab");
        if(b1){
          b1.addEventListener("click", ()=>{
            openModal("時間単価の計算", TIME_UNIT_COST_URL);
          });
        }
        if(b2){
          b2.addEventListener("click", ()=>{
            window.open(TIME_UNIT_COST_URL, "_blank", "noopener,noreferrer");
          });
        }
      }

      detailBuiltFor = selectedRoute;
    }

    function updateRouteDetailKPIs(){
      if(!selectedRoute) return;
      const c = compute();

      if($("kpiSalesEqM")) {
        $("kpiSalesEqM").textContent = Number.isFinite(c.salesEqTargetM) ? yen(c.salesEqTargetM) : "支出額と限界利益率を入力";
        if(!Number.isFinite(c.salesEqTargetM)) $("kpiSalesEqM").classList.add("small");
        else $("kpiSalesEqM").classList.remove("small");
      }

      if(selectedRoute === "price"){
        if($("kpiNeedPricePct")){
          if(c.annualSales>0 && Number.isFinite(c.needPricePct)){
            $("kpiNeedPricePct").textContent = pct1(c.needPricePct);
            $("kpiNeedPricePct").classList.remove("small");
          }else{
            $("kpiNeedPricePct").textContent = "年商を入力すると表示";
            $("kpiNeedPricePct").classList.add("small");
          }
        }
      }

      if(selectedRoute === "volume"){
        const L = volLabels();
        const unitRaw = $("volumeUnitPrice") ? String($("volumeUnitPrice").value ?? "").trim() : "";
        const unitPrice = $("volumeUnitPrice") ? num($("volumeUnitPrice").value) : 0;

        const convRaw = $("volumeConvRate") ? String($("volumeConvRate").value ?? "").trim() : "";
        const convRate = $("volumeConvRate") ? num($("volumeConvRate").value) : 0;

        const daysRaw = $("volumeDays") ? String($("volumeDays").value ?? "").trim() : "";
        const days = $("volumeDays") ? num($("volumeDays").value) : 0;

        if($("volumeUnitPriceErr")){
          if(unitRaw !== "" && unitPrice <= 0) showErr("volumeUnitPriceErr", "単価は 0 より大きい数値で入力してください。");
          else showErr("volumeUnitPriceErr", "");
        }
        if($("volumeConvRateErr")){
          if(convRaw !== "" && !(convRate>0 && convRate<=100)) showErr("volumeConvRateErr", "成約率は 0〜100 の範囲で入力してください。");
          else showErr("volumeConvRateErr", "");
        }
        if($("volumeDaysErr")){
          if(daysRaw !== "" && days <= 0) showErr("volumeDaysErr", "日数は 0 より大きい数値で入力してください。");
          else showErr("volumeDaysErr", "");
        }

        const canBase = (unitPrice>0 && Number.isFinite(c.salesEqTargetM));
        const needTxM = canBase ? (c.salesEqTargetM / unitPrice) : NaN;
        const needTxD = (days>0 && Number.isFinite(needTxM)) ? (needTxM / days) : NaN;

        const canEntry = (convRate>0 && convRate<=100 && Number.isFinite(needTxM));
        const needEntryM = canEntry ? (needTxM / (convRate/100)) : NaN;
        const needEntryD = (days>0 && Number.isFinite(needEntryM)) ? (needEntryM / days) : NaN;

        function setVal(id, txt, small){
          const el = $(id);
          if(!el) return;
          el.textContent = txt;
          el.classList.toggle("small", !!small);
        }

        if(!canBase){
          setVal("kpiNeedTxM", "単価と回収目標を入力", true);
          setVal("kpiNeedTxD", "日数を入れると表示", true);
          setVal("kpiNeedEntryM", "成約率を入れると表示", true);
          setVal("kpiNeedEntryD", "成約率+日数で表示", true);
        }else{
          setVal("kpiNeedTxM", (ceil1(needTxM) + " " + L.unitShort + "/月"), false);
          setVal("kpiNeedTxD", Number.isFinite(needTxD) ? (ceil1(needTxD) + " " + L.unitShort + "/日") : "日数を入れると表示", !Number.isFinite(needTxD));
          setVal("kpiNeedEntryM", Number.isFinite(needEntryM) ? (ceil1(needEntryM) + " " + L.entryShort + "/月") : "成約率を入れると表示", !Number.isFinite(needEntryM));
          setVal("kpiNeedEntryD", Number.isFinite(needEntryD) ? (ceil1(needEntryD) + " " + L.entryShort + "/日") : "成約率+日数で表示", !Number.isFinite(needEntryD));
        }
      }

      if(selectedRoute === "auto"){
        const hourRaw = $("hourCostInput") ? String($("hourCostInput").value ?? "").trim() : "";
        const hour = $("hourCostInput") ? num($("hourCostInput").value) : 0;
        const needHours = (hour>0 && Number.isFinite(c.spendPerMonth)) ? (c.spendPerMonth/hour) : NaN;

        if($("kpiSpendMonthlyEq")){
          $("kpiSpendMonthlyEq").textContent = Number.isFinite(c.spendPerMonth) ? yen(c.spendPerMonth) : "支出額（単発は回収期間）を入力";
          $("kpiSpendMonthlyEq").classList.toggle("small", !Number.isFinite(c.spendPerMonth));
        }

        if($("kpiNeedHours")){
          if(Number.isFinite(needHours)){
            $("kpiNeedHours").textContent = (ceil1(needHours)+" h/月");
            $("kpiNeedHours").classList.remove("small");
          }else{
            $("kpiNeedHours").textContent = (hourRaw ? "支出額を入力" : "時間単価を入力");
            $("kpiNeedHours").classList.add("small");
          }
        }
      }
    }

    function setRoute(route){
      selectedRoute = route || "";

      if(!selectedRoute){
        $("routeChooser").style.display = "grid";
        $("routeDetail").style.display = "none";
        detailBuiltFor = "";
        persist();
        return;
      }

      $("routeChooser").style.display = "none";
      $("routeDetail").style.display = "block";

      if(route){
        setTimeout(() => {
          const box = $("routeDetail");
          if(!box) return;
          const y = box.getBoundingClientRect().top + window.scrollY - 70;
          window.scrollTo({ top: y, behavior: "smooth" });
        }, 50);
      }

      buildRouteDetailUI();
      updateRouteDetailKPIs();
      persist();
    }

    function render(){
      const c = compute();
      validateStep1Errors(c);

      $("monthlySalesAuto").value = (c.annualSales>0) ? yen(c.monthlySalesAuto) : "";

      if(spendMode==="once"){
        $("spendMonthlyEqAuto").value = Number.isFinite(c.spendPerMonth) ? yen(c.spendPerMonth) : "—";
        syncRecoveryChipsFromInput();
      }else{
        $("spendMonthlyEqAuto").value = "";
      }

      if(spendMode==="monthly" || spendMode==="yearly"){
        $("kpiT1").textContent = "売上換算額（円 / 月）";
        $("kpiT2").textContent = "売上換算額（円 / 年）";

        if(Number.isFinite(c.salesEqTargetM)){
          $("salesEqM").textContent = yen(c.salesEqTargetM);
          $("salesEqM").classList.remove("small");
        }else{
          $("salesEqM").textContent = "支出額と限界利益率を入力";
          $("salesEqM").classList.add("small");
        }

        if(Number.isFinite(c.salesEqAnnual)){
          $("salesEqY").textContent = yen(c.salesEqAnnual);
          $("salesEqY").classList.remove("small");
        }else{
          $("salesEqY").textContent = "支出額と限界利益率を入力";
          $("salesEqY").classList.add("small");
        }
      }

      if(spendMode==="once"){
        $("kpiT1").textContent = "売上換算額（総額）";
        $("kpiT2").textContent = "回収目標（円 / 月）";

        if(Number.isFinite(c.salesEqTotal)){
          $("salesEqM").textContent = yen(c.salesEqTotal);
          $("salesEqM").classList.remove("small");
        }else{
          $("salesEqM").textContent = "支出額と限界利益率を入力";
          $("salesEqM").classList.add("small");
        }

        if(Number.isFinite(c.salesEqTargetM)){
          $("salesEqY").textContent = yen(c.salesEqTargetM);
          $("salesEqY").classList.remove("small");
        }else{
          const rmRaw = String($("recoveryMonths").value ?? "").trim();
          $("salesEqY").textContent = (rmRaw === "") ? "回収期間を入力" : "支出額と限界利益率を入力";
          $("salesEqY").classList.add("small");
        }
      }

      if(Number.isFinite(c.shareY)){
        $("shareY").textContent = pct1(c.shareY);
        $("shareY").classList.remove("small");
      }else{
        if(c.annualSales>0){
          $("shareY").textContent = "入力値を確認";
        }else{
          $("shareY").textContent = "年商を入力すると表示";
        }
        $("shareY").classList.add("small");
      }

      $("selectedRouteLabel").value = 
        selectedRoute==="price" ? "単価を上げる" :
        selectedRoute==="volume" ? "数量を上げる" :
        selectedRoute==="auto" ? "業務プロセスを自動化（時間創出）" :
        "（未選択）";

      if(selectedRoute){
        buildRouteDetailUI();
        updateRouteDetailKPIs();
      }

      persist();
    }

    let currentUrl = "";
    let lastFocusEl = null;
    let modalOpen = false;

    function getToolTitle(){
      return selectedRoute==="price" ? "価格改定ツール" :
             selectedRoute==="volume" ? "変動PLツール" :
             selectedRoute==="auto" ? "自動化効果ツール" : "ツール";
    }
    function getToolUrl(){
      return selectedRoute ? TOOL_URLS[selectedRoute] : "";
    }
    function getFocusable(root){
      const sel = [
        'button:not([disabled])',
        'a[href]',
        'input:not([disabled])',
        'textarea:not([disabled])',
        'select:not([disabled])',
        '[tabindex]:not([tabindex="-1"])'
      ].join(',');
      return Array.from(root.querySelectorAll(sel)).filter(el=>{
        const style = window.getComputedStyle(el);
        return style.display !== "none" && style.visibility !== "hidden";
      });
    }
    function openModal(title, url){
      lastFocusEl = document.activeElement;
      currentUrl = url;

      $("modalTitle").innerHTML = `${title} <span>（同一画面）</span>`;

      $("toolFrame").src = url;
      $("modalBack").style.display = "flex";
      document.body.style.overflow = "hidden";

      modalOpen = true;

      setTimeout(()=>{
        try{ $("btnClose").focus(); }catch(e){}
      }, 0);
    }
    function closeModal(){
      $("modalBack").style.display = "none";
      $("toolFrame").src = "about:blank";
      currentUrl = "";
      document.body.style.overflow = "";
      modalOpen = false;

      if(lastFocusEl && typeof lastFocusEl.focus === "function"){
        try{ lastFocusEl.focus(); }catch(e){}
      }
      lastFocusEl = null;
    }

    document.addEventListener("keydown", (e)=>{
      if(!modalOpen) return;
      if(e.key === "Escape"){
        e.preventDefault();
        closeModal();
        return;
      }
      if(e.key !== "Tab") return;

      const focusables = getFocusable(document.querySelector("#modalBack .modal"));
      if(focusables.length === 0) return;

      const first = focusables[0];
      const last  = focusables[focusables.length - 1];
      const active = document.activeElement;

      if(e.shiftKey){
        if(active === first || !focusables.includes(active)){
          e.preventDefault();
          last.focus();
        }
      }else{
        if(active === last){
          e.preventDefault();
          first.focus();
        }
      }
    }, true);

    function getState(){
      return {
        spendMode,
        spendMonthly: $("spendMonthly").value,
        spendYearly: $("spendYearly").value,
        spendOnce: $("spendOnce").value,
        recoveryMonths: $("recoveryMonths").value,
        cmr: $("cmr").value,
        annualSales: $("annualSales").value,
        selectedRoute,
        // r8 updates
        targetScope: $("targetScope").value,
        checkKpi: $("checkKpi").value,
        targetGoal: $("targetGoal").value,
        firstAction: $("firstAction").value,
        stopDoing: $("stopDoing").value,
        nextCheck: $("nextCheck").value,
        freeMemo: $("freeMemo").value,
        
        volumeLabelKey,
        volumeUnitPrice: $("volumeUnitPrice") ? $("volumeUnitPrice").value : "",
        volumeConvRate: $("volumeConvRate") ? $("volumeConvRate").value : "",
        volumeDays: $("volumeDays") ? $("volumeDays").value : "",
        hourCost: $("hourCostInput") ? $("hourCostInput").value : "",
        foldTalkOpen: $("foldTalk") ? $("foldTalk").open : false
      };
    }
    function persist(){ save(getState()); }

    function restore(v){
      if(v.spendMode) setSpendMode(v.spendMode);
      if(v.spendMonthly!=null) $("spendMonthly").value = v.spendMonthly;
      if(v.spendYearly!=null) $("spendYearly").value = v.spendYearly;
      if(v.spendOnce!=null) $("spendOnce").value = v.spendOnce;
      if(v.recoveryMonths!=null) $("recoveryMonths").value = v.recoveryMonths;

      if(v.cmr!=null) $("cmr").value = v.cmr;
      if(v.annualSales!=null) $("annualSales").value = v.annualSales;

      // r8 updates
      if(v.targetScope!=null) $("targetScope").value = v.targetScope;
      if(v.checkKpi!=null) $("checkKpi").value = v.checkKpi;
      if(v.targetGoal!=null) $("targetGoal").value = v.targetGoal;
      if(v.firstAction!=null) $("firstAction").value = v.firstAction;
      if(v.stopDoing!=null) $("stopDoing").value = v.stopDoing;
      if(v.nextCheck!=null) $("nextCheck").value = v.nextCheck;
      if(v.freeMemo!=null) $("freeMemo").value = v.freeMemo;

      if(v.volumeLabelKey) volumeLabelKey = v.volumeLabelKey;

      if($("foldTalk") && typeof v.foldTalkOpen === "boolean"){
        $("foldTalk").open = v.foldTalkOpen;
      }

      if(v.selectedRoute==="price" || v.selectedRoute==="volume" || v.selectedRoute==="auto"){
        setRoute(v.selectedRoute);
        setTimeout(()=>{
          if($("volumeUnitPrice") && v.volumeUnitPrice!=null) $("volumeUnitPrice").value = v.volumeUnitPrice;
          if($("volumeConvRate") && v.volumeConvRate!=null) $("volumeConvRate").value = v.volumeConvRate;
          if($("volumeDays") && v.volumeDays!=null) $("volumeDays").value = v.volumeDays;
          if($("hourCostInput") && v.hourCost!=null) $("hourCostInput").value = v.hourCost;

          bindLiveFormatting(document);
          document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
          document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);

          render();
        }, 0);
      }else{
        setRoute("");
      }
    }

    function doReset(){
      if(!confirm("入力内容をすべてリセットしますか？\n（この操作は取り消せません）")){
        return;
      }

      spendMode = "monthly";
      [
        "spendMonthly","spendYearly","spendOnce","recoveryMonths",
        "cmr","annualSales",
        "targetScope","checkKpi","targetGoal","firstAction","stopDoing","nextCheck","freeMemo"
      ].forEach(id=>{ if($(id)) $(id).value=""; });
      
      $("monthlySalesAuto").value = "";
      $("spendMonthlyEqAuto").value = "";

      showErr("cmrErr", "");
      showErr("spendMonthlyErr", "");
      showErr("spendYearlyErr", "");
      showErr("spendOnceErr", "");
      showErr("recoveryErr", "");

      volumeLabelKey = "generic";
      setRoute("");
      localStorage.removeItem(KEY);
      setSpendMode("monthly");
      render();
    }

    bindLiveFormatting(document);
    buildRecoveryChips();

    $("modeMonthly").addEventListener("click", ()=>setSpendMode("monthly"));
    $("modeYearly").addEventListener("click",  ()=>setSpendMode("yearly"));
    $("modeOnce").addEventListener("click",    ()=>setSpendMode("once"));

    setSpendMode("monthly");

    const st = load();
    restore(st);

    bindLiveFormatting(document);
    document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
    document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);

    // Watch all inputs for Step 3 persistence
    [
      "spendMonthly","spendYearly","spendOnce","recoveryMonths","cmr","annualSales",
      "targetScope","checkKpi","targetGoal","firstAction","stopDoing","nextCheck","freeMemo"
    ].forEach(id=>{
      if($(id)){
        $(id).addEventListener("input", ()=>{
          if(id==="recoveryMonths") syncRecoveryChipsFromInput();
          render();
        });
      }
    });

    document.querySelectorAll("[data-pick]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const r = btn.getAttribute("data-pick");
        setRoute(r);
        render();
      });
    });
    $("btnBack").addEventListener("click", ()=>{ setRoute(""); render(); });

    $("btnOpenTool").addEventListener("click", ()=>{
      const url = getToolUrl();
      if(!url){ alert("ツールURLが未設定です。"); return; }
      openModal(getToolTitle(), url);
    });
    $("btnOpenToolNewTab").addEventListener("click", ()=>{
      const url = getToolUrl();
      if(!url){ alert("ツールURLが未設定です。"); return; }
      window.open(url, "_blank", "noopener,noreferrer");
    });
    $("btnClose").addEventListener("click", closeModal);
    $("modalBack").addEventListener("click", (e)=>{ if(e.target === $("modalBack")) closeModal(); });
    $("btnOpenNewTab2").addEventListener("click", ()=>{ if(currentUrl) window.open(currentUrl, "_blank", "noopener,noreferrer"); });

    $("btnPrint").addEventListener("click", ()=>window.print());

    $("btnCopy").addEventListener("click", async ()=>{
      const c = compute();
      const routeLabel = 
        selectedRoute==="price" ? "単価を上げる" :
        selectedRoute==="volume" ? "数量を上げる" :
        selectedRoute==="auto" ? "業務プロセスを自動化する" :
        "（未選択）";

      let spendLine = "";
      if(spendMode==="monthly"){
        spendLine = `・支出（月）：${yen(c.spendM)}`;
      }else if(spendMode==="yearly"){
        spendLine = `・支出（年）：${yen(c.spendY)}`;
      }else{
        const rm = String($("recoveryMonths").value ?? "").trim();
        const rmDisp = rm ? rm : "—";
        spendLine = `・支出（単発）：${yen(c.spendO)}／回収期間：${rmDisp}ヶ月（月割り ${Number.isFinite(c.spendPerMonth)?yen(c.spendPerMonth):"—"}）`;
      }

      const cmrDisp = $("cmr").value ? ($("cmr").value + "%") : "—";

      let eqLine = "";
      if(spendMode==="once"){
        eqLine = `・売上換算（総額）：${Number.isFinite(c.salesEqTotal)?yen(c.salesEqTotal):"—"}／回収目標（月）：${Number.isFinite(c.salesEqTargetM)?yen(c.salesEqTargetM):"—"}`;
      }else{
        eqLine = `・売上換算（月）：${Number.isFinite(c.salesEqTargetM)?yen(c.salesEqTargetM):"—"}／（年）：${Number.isFinite(c.salesEqAnnual)?yen(c.salesEqAnnual):"—"}`;
      }

      let routeDetail = "";
      if(selectedRoute==="price"){
        routeDetail = `・必要な上乗せ率（%）※年商入力時：${Number.isFinite(c.needPricePct)?pct1(c.needPricePct):"—"}`;
      }
      if(selectedRoute==="volume"){
        const L = volLabels();
        const unitPrice = $("volumeUnitPrice") ? num($("volumeUnitPrice").value) : 0;
        const convRate = $("volumeConvRate") ? num($("volumeConvRate").value) : 0;
        const needTxM = (unitPrice>0 && Number.isFinite(c.salesEqTargetM)) ? (c.salesEqTargetM / unitPrice) : NaN;
        const needEntryM = (convRate>0 && convRate<=100 && Number.isFinite(needTxM)) ? (needTxM / (convRate/100)) : NaN;

        routeDetail = 
`・${L.unitPriceLabel}：${unitPrice?yen(unitPrice):"—"}
・${L.convLabel}：${$("volumeConvRate") && $("volumeConvRate").value ? ($("volumeConvRate").value+"%") : "—"}
・必要な追加${L.txName}数：${Number.isFinite(needTxM)?(ceil1(needTxM)+" "+L.unitShort+"/月"):"—"}
・必要な${L.entryLabel}：${Number.isFinite(needEntryM)?(ceil1(needEntryM)+" "+L.entryShort+"/月"):"—"}`;
      }
      if(selectedRoute==="auto"){
        const hour = $("hourCostInput") ? num($("hourCostInput").value) : 0;
        const needHours = (hour>0 && Number.isFinite(c.spendPerMonth)) ? (c.spendPerMonth/hour) : NaN;
        routeDetail = `・時間単価：${hour?yen(hour):"—"}／回収に必要な削減時間：${Number.isFinite(needHours)?(ceil1(needHours)+" h/月"):"—"}`;
      }

      const text = 
`【打ち手検討（概算）】
■1. 売上換算
${spendLine}
・限界利益率：${cmrDisp}
${eqLine}
・年商比：${Number.isFinite(c.shareY)?pct1(c.shareY):"—"}
・月商（年商÷12）：${c.annualSales>0 ? yen(c.monthlySalesAuto) : "—"}

■2. 打ち手
・選択：${routeLabel}
${routeDetail ? routeDetail : ""}

■3. 次の一手
・対象：${$("targetScope").value || "—"}
・目標成果：${$("targetGoal").value || "—"}
・確認指標：${$("checkKpi").value || "—"}
・最初の一歩：${$("firstAction").value || "—"}
・やめること：${$("stopDoing").value || "—"}
・次回確認：${$("nextCheck").value || "—"}
・メモ：${$("freeMemo").value || "—"}`;

      try{
        await navigator.clipboard.writeText(text);
        const b = $("btnCopy"); const old = b.textContent;
        b.textContent = "コピーしました";
        setTimeout(()=>b.textContent=old, 900);
      }catch(e){
        alert("コピーできない場合があります。必要なら画面の数値をそのままご利用ください。");
      }
    });

    $("btnReset").addEventListener("click", doReset);
    $("btnResetTop").addEventListener("click", doReset);

    render();
  </script>
</body>
</html>
