<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ‰“ã¡æ‰‹æ¤œè¨ãƒ„ãƒ¼ãƒ«ï½œæ”¯å‡ºé¡ã‚’å£²ä¸Šæ›ç®— â†’ æ‰“ã¡æ‰‹ã‚’æ¤œè¨</title>
  <meta name="description" content="æ”¯å‡ºé¡ã‚’é™ç•Œåˆ©ç›Šç‡ã§å£²ä¸Šæ›ç®—ã—ã€å˜ä¾¡ãƒ»æ•°é‡ãƒ»è‡ªå‹•åŒ–ã®ã©ã“ã§å›åã™ã‚‹ã‹ã‚’åŒã˜ç”»é¢ã§æ•´ç†ã—ã¾ã™ã€‚" />

  <link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="favicon192192.png">

  <style>
    :root{
      --brand:#578899;
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#17323a;
      --muted:#56707a;
      --line:rgba(23,50,58,.12);
      --soft:rgba(87,136,153,.10);
      --shadow:0 10px 28px rgba(20,40,50,.10);
      --r:16px;

      --danger:#b42318;
      --dangerSoft:rgba(180,35,24,.08);
      --focus:rgba(87,136,153,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height:1.55;
    }
    a{color:inherit}

    .top{position:static; background:var(--bg); border-bottom:1px solid var(--line);}
    .topin{
      max-width:980px; margin:0 auto;
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0;}
    .logo{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(87,136,153,.35);
      background:#fff;
      object-fit:cover;
      display:block;
      flex:0 0 auto;
    }
    .btxt{min-width:0}
    .bttl{font-weight:900; font-size:20px; line-height:1.15; letter-spacing:.02em;}
    .bsub{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .btns{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:12px;
      padding:9px 12px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.02);
      transition:.12s transform,.12s box-shadow,.12s border-color,.12s background;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 18px rgba(20,40,50,.08); border-color:rgba(87,136,153,.35)}
    .btn.primary{background:var(--soft); border-color:rgba(87,136,153,.35)}
    .btn.ghost{background:transparent}

    .btn.back{
      background:rgba(87,136,153,.14);
      border-color:rgba(87,136,153,.60);
      color:var(--text);
      font-weight:900;
      padding:10px 14px;
    }
    .btn.back:hover{
      background:rgba(87,136,153,.20);
      border-color:rgba(87,136,153,.75);
    }

    .btn:focus-visible,
    .avgBtn:focus-visible,
    summary:focus-visible{
      outline:3px solid var(--focus);
      outline-offset:2px;
      border-radius:12px;
    }

    .wrap{max-width:980px; margin:0 auto; padding:16px 14px 34px}
    .grid{display:grid; gap:12px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }
    h2{margin:0 0 6px; font-size:18px}
    .p{margin:6px 0 0; color:var(--muted)}

    .talk{
      margin:10px 0 0;
      border:1px solid rgba(87,136,153,.28);
      background:rgba(87,136,153,.06);
      border-radius:14px;
      padding:10px 12px;
      color:var(--muted);
      font-size:12px;
    }

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:760px){ .row{grid-template-columns:1fr} }

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px; font-weight:800}
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(23,50,58,.14);
      background:#fff;
      color:var(--text);
      font-size:16px;
      outline:none;
    }

    input::placeholder, textarea::placeholder{ color: rgba(86,112,122,.45); }
    input::-webkit-input-placeholder, textarea::-webkit-input-placeholder{ color: rgba(86,112,122,.45); }
    input::-moz-placeholder, textarea::-moz-placeholder{ color: rgba(86,112,122,.45); opacity:1; }
    input:-ms-input-placeholder, textarea:-ms-input-placeholder{ color: rgba(86,112,122,.45); }

    textarea{min-height:110px; resize:vertical}
    input:focus, textarea:focus{
      border-color:rgba(87,136,153,.55);
      box-shadow:0 0 0 4px rgba(87,136,153,.16);
    }
    .help{font-size:12px; color:var(--muted); margin-top:6px}

    .err{
      margin-top:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(180,35,24,.35);
      background:var(--dangerSoft);
      color:var(--danger);
      font-size:12px;
      font-weight:900;
      display:none;
    }
    .err.show{display:block;}

    .kpi{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px}
    @media (max-width:760px){ .kpi{grid-template-columns:1fr} }
    .k{
      border:1px solid rgba(23,50,58,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(87,136,153,.04);
    }
    .k .t{font-size:12px; color:var(--muted); font-weight:800}
    .k .v{font-size:18px; font-weight:900; margin-top:6px}
    .k .v.small{font-size:14px; font-weight:900; color:var(--muted)}

    .note{
      border:1px solid rgba(87,136,153,.28);
      background:rgba(87,136,153,.06);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }

    .avgWrap{margin-top:10px}
    .avgTitle{font-size:12px; color:var(--muted); font-weight:900; margin:0 0 8px}
    .avgGrid{display:flex; flex-wrap:wrap; gap:8px}
    .avgBtn{
      appearance:none;
      border:1px solid rgba(87,136,153,.22);
      background:rgba(87,136,153,.06);
      color:var(--text);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:.12s transform,.12s box-shadow,.12s border-color,.12s background;
      user-select:none;
      white-space:nowrap;
    }
    .avgBtn:hover{transform:translateY(-1px); box-shadow:0 10px 18px rgba(20,40,50,.08); border-color:rgba(87,136,153,.35)}
    .avgBtn.active{border-color:rgba(87,136,153,.65); background:rgba(87,136,153,.12)}
    .avgBtn[aria-pressed="true"]{border-color:rgba(87,136,153,.75); background:rgba(87,136,153,.14)}

    .chooser{
      margin-top:16px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:16px;
    }
    @media (max-width:900px){ .chooser{grid-template-columns:1fr} }
    .bigCard{
      border:2px solid rgba(87,136,153,.15);
      border-radius:20px;
      padding:20px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:180px;
      align-items:center;
      text-align:center;
      transition:all .2s ease;
      position:relative;
      cursor:pointer;
    }
    .bigCard:hover{
      border-color:var(--brand);
      background:rgba(87,136,153,.02);
      transform:translateY(-4px);
      box-shadow:0 12px 30px rgba(87,136,153,.15);
    }
    .bigCardIcon{
      font-size:38px;
      line-height:1;
      margin-bottom:4px;
    }
    .bigCard h3{margin:0; font-size:17px; font-weight:900}
    .bigCard p{margin:0; color:var(--muted); font-size:12px; line-height:1.5}
    .bigCard .grow{flex:1; width:100%}
    .bigCard .btn{width:100%; margin-top:8px;}

    .detail{
      margin-top:12px;
      border:1px solid rgba(23,50,58,.12);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }

    .detailHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;

      position:sticky;
      top:0;
      z-index:5;
      background:#fff;
      padding-top:2px;
      padding-bottom:8px;
      border-bottom:1px solid rgba(23,50,58,.10);
      margin-bottom:8px;
    }
    .detailHead h3{margin:0; font-size:16px}
    .detailHead .mini{margin:4px 0 0; color:var(--muted); font-size:12px}

    .kpi2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    @media (max-width:760px){ .kpi2{grid-template-columns:1fr} }
    .k2{
      border:1px solid rgba(23,50,58,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(87,136,153,.04);
    }
    .k2 .t{font-size:12px; color:var(--muted); font-weight:800}
    .k2 .v{font-size:16px; font-weight:900; margin-top:6px}
    .k2 .v.small{font-size:13px; font-weight:900; color:var(--muted)}
    .mutedLine{margin-top:8px; color:var(--muted); font-size:12px}

    details.fold{
      margin-top:10px;
      border:1px solid rgba(87,136,153,.22);
      background:rgba(87,136,153,.04);
      border-radius:14px;
      padding:8px 10px;
    }
    details.fold summary{
      cursor:pointer;
      font-weight:900;
      color:var(--text);
      font-size:13px;
      user-select:none;
      list-style:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    details.fold summary::-webkit-details-marker{ display:none; }
    details.fold summary:before{
      content:"â–¸";
      display:inline-block;
      transform:translateY(-1px);
      color:var(--muted);
    }
    details.fold[open] summary:before{
      content:"â–¾";
    }
    details.fold .inside{
      margin-top:8px;
    }

    .modalBack{
      position:fixed; inset:0; z-index:100;
      background:rgba(10,20,25,.35);
      display:none; align-items:center; justify-content:center;
      padding:14px;
    }
    .modal{
      width:min(1040px, 96vw);
      height:min(720px, 86vh);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(23,50,58,.14);
      box-shadow:0 18px 50px rgba(0,0,0,.18);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .modalTop{
      padding:10px 12px;
      border-bottom:1px solid rgba(23,50,58,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(246,248,251,.92);
    }
    .modalTitle{font-weight:900; font-size:13px; color:var(--text); min-width:0}
    .modalTitle span{color:var(--muted); font-weight:800; font-size:12px}
    .modalFrame{flex:1; background:#fff;}
    iframe{width:100%; height:100%; border:0; background:#fff;}
    .modalHint{
      padding:10px 12px;
      border-top:1px solid rgba(23,50,58,.10);
      color:var(--muted);
      font-size:12px;
      background:#fff;
    }

    .card-actions{padding-top:10px;}
    .action-row{display:flex; gap:10px; margin:6px 0; flex-wrap:nowrap;}
    .action-row .btn{
      background:#eef7f9; color:#3f7c8e; border:1px solid #cfe3ea; box-shadow:none;
      padding:12px 14px; font-size:15px; border-radius:12px; flex:1 1 33%; white-space:nowrap;
    }
    .action-row .btn:hover{background:#e6f2f6;}
    @media (max-width:760px){
      .action-row{flex-wrap:wrap;}
      .action-row .btn{flex:1 1 100%;}
    }

    footer.mk-mini{
      margin:18px 4px 10px;
      text-align:center;
      color:#667;
      font-size:11px;
      line-height:1.6;
      white-space:normal;
      overflow-wrap:anywhere;
      text-overflow:clip;
    }
    footer.mk-mini a{
      color:inherit;
      text-decoration:underline;
      text-underline-offset:2px;
    }

    @page { size: auto; margin: 12mm; }
    @media print{
      body{background:#fff}
      .btns, .modalBack{display:none !important}
      .wrap{padding:0}
      .card{box-shadow:none; border:1px solid #ddd}
      .k, .k2{background:#fff}
      a{color:#000; text-decoration:none}
      textarea{min-height:140px}
      details.fold{border:1px solid #ddd; background:#fff;}
      details.fold summary:before{content:"";}
    }
  </style>
</head>

<body>
  <div class="top">
    <div class="topin">
      <div class="brand">
        <img class="logo" src="ãƒ­ã‚´.jpg" alt="ãƒ­ã‚´" />
        <div class="btxt">
          <div class="bttl">æ‰“ã¡æ‰‹æ¤œè¨ãƒ„ãƒ¼ãƒ«</div>
          <div class="bsub">æ”¯å‡ºé¡ã‚’å£²ä¸Šæ›ç®— â†’ æ‰“ã¡æ‰‹ã‚’æ¤œè¨</div>
        </div>
      </div>

      <div class="btns">
        <button class="btn primary" id="btnResetTop">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <section class="card">
        <h2>1. å£²ä¸Šæ›ç®—</h2>
        <div class="p">æ”¯å‡ºé¡ãŒã€Œå£²ä¸Šã«ç›´ã™ã¨ã©ã‚Œãã‚‰ã„ã‹ã€ã‚’ã€é™ç•Œåˆ©ç›Šç‡ã§æ•´ç†ã—ã¾ã™ï¼ˆæ¦‚ç®—ï¼‰ã€‚</div>

        <div class="avgWrap">
          <div class="avgTitle">æ”¯å‡ºã®é »åº¦</div>
          <div class="avgGrid" id="spendModeGrid">
            <button type="button" class="avgBtn" id="modeMonthly">æ¯æœˆï¼ˆå›ºå®šè²»ï¼‰</button>
            <button type="button" class="avgBtn" id="modeYearly">å¹´é¡ï¼ˆå›ºå®šè²»ï¼‰</button>
            <button type="button" class="avgBtn" id="modeOnce">å˜ç™ºï¼ˆ1å›ï¼‰</button>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div>
            <div id="boxSpendMonthly">
              <label for="spendMonthly">æ”¯å‡ºé¡ï¼ˆå†† / æœˆï¼‰</label>
              <input id="spendMonthly" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š20,000" data-format="int" />
              <div class="help">ä¾‹ï¼šã‚µãƒ–ã‚¹ã‚¯ã€ä¿å®ˆæ–™ã€å›ºå®šè²»ã®å¢—åŠ ãªã©ã€‚</div>
              <div class="err" id="spendMonthlyErr" aria-live="polite"></div>
            </div>

            <div id="boxSpendYearly" style="display:none;">
              <label for="spendYearly">æ”¯å‡ºé¡ï¼ˆå†† / å¹´ï¼‰</label>
              <input id="spendYearly" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š240,000" data-format="int" />
              <div class="help">ä¾‹ï¼šå¹´é¡ä¿å®ˆæ–™ã€å¹´é–“å¥‘ç´„è²»ãªã©ã€‚</div>
              <div class="err" id="spendYearlyErr" aria-live="polite"></div>
            </div>

            <div id="boxSpendOnce" style="display:none;">
              <label for="spendOnce">æ”¯å‡ºé¡ï¼ˆå†† / 1å›ï¼‰</label>
              <input id="spendOnce" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š600,000" data-format="int" />
              <div class="err" id="spendOnceErr" aria-live="polite"></div>

              <div class="row" style="margin-top:10px;">
                <div>
                  <label for="recoveryMonths">å›åæœŸé–“ï¼ˆãƒ¶æœˆï¼‰</label>

                  <div class="avgWrap" style="margin-top:6px;">
                    <div class="avgGrid" id="recoveryChipGrid" aria-label="å›åæœŸé–“ãƒ—ãƒªã‚»ãƒƒãƒˆ"></div>
                    <div class="help">ã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›ã§ãã¾ã™ã€‚è‡ªç”±å…¥åŠ›ã‚‚å¯èƒ½ã§ã™ã€‚</div>
                  </div>

                  <input id="recoveryMonths" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š12" data-format="int" />
                  <div class="help">å˜ç™ºæ”¯å‡ºã‚’ã€ã“ã®æœŸé–“ã§å›åã™ã‚‹ã¨ä»®å®šã—ã¦ã€Œæœˆã‚ãŸã‚Šã®å›åç›®æ¨™ã€ã‚’å‡ºã—ã¾ã™ã€‚</div>
                  <div class="err" id="recoveryErr" aria-live="polite"></div>
                </div>
                <div>
                  <label>æœˆå‰²ã‚Šæ”¯å‡ºï¼ˆè‡ªå‹•ï¼‰</label>
                  <input id="spendMonthlyEqAuto" readonly placeholder="â€”" />
                </div>
              </div>
            </div>
          </div>

          <div>
            <label for="cmr">é™ç•Œåˆ©ç›Šç‡ï¼ˆ%ï¼‰</label>
            <input id="cmr" inputmode="decimal" pattern="[0-9.]*" placeholder="ä¾‹ï¼š30" data-format="decimal" />
            <div class="help">ä¸æ˜ãªå ´åˆã¯ã€ã¾ãšã¯æ¦‚ç®—ã§å…¥åŠ›ï¼ˆä¾‹ï¼š30ï¼‰ã—ã€å¾Œã§æ›´æ–°ã—ã¦ã‚‚OKã§ã™ã€‚</div>
            <div class="err" id="cmrErr" aria-live="polite"></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label for="annualSales">å¹´å•†ï¼ˆä»»æ„ / å††ï¼‰</label>
            <input id="annualSales" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š120,000,000" data-format="int" />
          </div>
          <div>
            <label>æœˆå•†ï¼ˆè‡ªå‹• / å¹´å•†Ã·12ï¼‰</label>
            <input id="monthlySalesAuto" readonly placeholder="â€”" />
          </div>
        </div>

        <div class="kpi">
          <div class="k">
            <div class="t" id="kpiT1">â€”</div>
            <div class="v" id="salesEqM">â€”</div>
          </div>
          <div class="k">
            <div class="t" id="kpiT2">â€”</div>
            <div class="v" id="salesEqY">â€”</div>
          </div>
          <div class="k">
            <div class="t" id="kpiT3">å¹´å•†ã«å ã‚ã‚‹å‰²åˆï¼ˆ%ï¼‰</div>
            <div class="v" id="shareY">â€”</div>
          </div>
        </div>

        <div class="note">
          å…¥åŠ›å€¤ã¯ã“ã®ç«¯æœ«å†…ã§è¨ˆç®—ã•ã‚Œã€é€ä¿¡ã•ã‚Œã¾ã›ã‚“ï¼ˆã“ã®ãƒšãƒ¼ã‚¸å˜ä½“ã§å®Œçµã—ã¾ã™ï¼‰ã€‚
        </div>
      </section>

      <section class="card">
        <h2>2. æ‰“ã¡æ‰‹ã‚’æ¤œè¨</h2>
        <div class="p">å£²ä¸Šæ›ç®—é¡ã‚’ã€Œã©ã†ã‚„ã£ã¦ä½œã‚‹ã‹ã€ã‚’3ã¤ã®æ–¹å‘ã‹ã‚‰æ¤œè¨ã—ã¾ã™ã€‚</div>

        <details class="fold" id="foldTalk">
          <summary>è£œè¶³ï¼ˆè€ƒãˆæ–¹ï¼‰</summary>
          <div class="inside">
            <div class="talk" id="talkMemo">
              ã€Œå£²ä¸Šæ›ç®—ï¼ˆæ”¯å‡ºé¡ Ã· é™ç•Œåˆ©ç›Šç‡ï¼‰ã§â€œå¿…è¦ãªå£²ä¸Šâ€ã‚’æƒãˆã¾ã—ãŸã€‚æ¬¡ã«ã€ã“ã‚Œã‚’ <b>å˜ä¾¡</b>ãƒ»<b>æ•°é‡</b>ãƒ»<b>è‡ªå‹•åŒ–</b> ã®ã©ã®æ–¹å‘ã§å›åã™ã‚‹ã‹ã‚’ä¸€ç·’ã«æ±ºã‚ã¾ã—ã‚‡ã†ã€‚ã€
            </div>
          </div>
        </details>

        <div id="routeChooser" class="chooser" aria-label="æ‰“ã¡æ‰‹ã®é¸æŠ">
          <div class="bigCard" data-target="price">
            <div class="bigCardIcon">ğŸ’</div>
            <div class="grow">
              <h3>å˜ä¾¡ã‚’ä¸Šã’ã‚‹</h3>
              <p>ä¾¡æ ¼ãƒ»å€¤ä»˜ã‘ãƒ»å®¢å±¤ãƒ»æä¾›ä¾¡å€¤ã®è¦‹ç›´ã—ã§ã€åŒã˜åŠ´åŠ›ã§åˆ©ç›Šã‚’å¢—ã‚„ã™æ–¹å‘ã§ã™ã€‚</p>
            </div>
            <button class="btn primary" data-pick="price">ã“ã®æ–¹å‘ã§æ·±æ˜ã‚Š</button>
          </div>

          <div class="bigCard" data-target="volume">
            <div class="bigCardIcon">ğŸ“¦</div>
            <div class="grow">
              <h3>æ•°é‡ã‚’ä¸Šã’ã‚‹</h3>
              <p>ã€Œå–å¼•å˜ä¾¡Ã—å–å¼•æ•°ã€ã®æ•´ç†ã§ã€å¿…è¦ãªè¿½åŠ ä»¶æ•°ã¨å…¥å£æ•°ã‚’æ•°å­—ã§è¦‹ãˆã‚‹åŒ–ã—ã¾ã™ã€‚</p>
            </div>
            <button class="btn primary" data-pick="volume">ã“ã®æ–¹å‘ã§æ·±æ˜ã‚Š</button>
          </div>

          <div class="bigCard" data-target="auto">
            <div class="bigCardIcon">âš™ï¸</div>
            <div class="grow">
              <h3>æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–</h3>
              <p>æ™‚é–“ã‚’ä½œã‚Šã€ãã®æ™‚é–“ã§ä»˜åŠ ä¾¡å€¤æ´»å‹•ã¸ç§»ã™æ–¹å‘ã§ã™ï¼ˆå›åã«å¿…è¦ãªå‰Šæ¸›æ™‚é–“ã®ç›®å®‰ãŒå‡ºã¾ã™ï¼‰ã€‚</p>
            </div>
            <button class="btn primary" data-pick="auto">ã“ã®æ–¹å‘ã§æ·±æ˜ã‚Š</button>
          </div>
        </div>

        <div id="routeDetail" class="detail" style="display:none;">
          <div class="detailHead">
            <div>
              <h3 id="detailTitle">â€”</h3>
              <div class="mini" id="detailSub">â€”</div>
            </div>
            <div class="btns">
              <button class="btn back" id="btnBack">3ã¤ã®æ‰“ã¡æ‰‹ã«æˆ»ã‚‹</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div id="detailInputA"></div>
            <div id="detailInputB"></div>
          </div>

          <div class="kpi2" id="detailKpi"></div>

          <div class="btns" style="margin-top:10px; justify-content:flex-start;">
            <button class="btn primary" id="btnOpenTool">é–¢é€£ãƒ„ãƒ¼ãƒ«ã§ç¢ºèªï¼ˆåŒä¸€ç”»é¢ï¼‰</button>
            <button class="btn" id="btnOpenToolNewTab">åˆ¥ã‚¿ãƒ–ã§é–‹ã</button>
          </div>

          <div class="mutedLine" id="detailHint"></div>
        </div>
      </section>

      <section class="card">
        <h2>3. æ¬¡ã®ä¸€æ‰‹</h2>
        <div class="p">ã€Œå®Ÿè¡Œï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã€ã¸è½ã¨ã—è¾¼ã‚€ãŸã‚ã®æ•´ç†ã§ã™ã€‚</div>

        <div class="row" style="margin-top:12px;">
          <div>
            <label>ä»Šå›ã®æ‰“ã¡æ‰‹ï¼ˆé¸æŠçµæœï¼‰</label>
            <input id="selectedRouteLabel" readonly value="ï¼ˆæœªé¸æŠï¼‰" />
          </div>
          <div>
            <label>å¯¾è±¡ï¼ˆå•†å“ / å®¢å±¤ / æ¥­å‹™ãªã©ï¼‰</label>
            <input id="targetScope" placeholder="ä¾‹ï¼šAå•†å“ã€æ—¢å­˜é¡§å®¢ã®æ›´æ–°å˜ä¾¡ã€è«‹æ±‚æ¥­å‹™ ãªã©" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>ç›®æ¨™ã¨ã™ã‚‹æˆæœï¼ˆæ•°å€¤ï¼‰</label>
            <input id="targetGoal" placeholder="ä¾‹ï¼šå£²ä¸Š+30ä¸‡å††ã€æ™‚é–“-10h ãªã©" />
            <div class="help">Step1-2ã§è©¦ç®—ã—ãŸæ•°å­—ã‚’ç›®æ¨™ã¨ã—ã¦è¨­å®šã—ã¾ã™ã€‚</div>
          </div>
          <div>
            <label>ç¢ºèªã™ã‚‹æŒ‡æ¨™ï¼ˆæœˆæ¬¡ã§è¦‹ã‚‹ã‚‚ã®ï¼‰</label>
            <input id="checkKpi" placeholder="ä¾‹ï¼šå¹³å‡å˜ä¾¡ã€ç²—åˆ©ç‡ã€ä»¶æ•°ã€æœˆæ¬¡ç¢ºå®šæ—¥ ãªã©" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>æœ€åˆã®ä¸€æ­©ï¼ˆæ˜æ—¥ã‚„ã‚‹ã“ã¨ï¼‰</label>
            <input id="firstAction" placeholder="ä¾‹ï¼šã€‡ã€‡ã•ã‚“ã«é›»è©±ã™ã‚‹ã€è³‡æ–™ã‚’å–ã‚Šå¯„ã›ã‚‹" />
            <div class="help">ã€Œ24æ™‚é–“ä»¥å†…ã«ã§ãã‚‹å…·ä½“çš„ãªè¡Œå‹•ã€ã‚’æ›¸ãã¾ã™ã€‚</div>
          </div>
          <div>
            <label>ãã®ãŸã‚ã«ã‚„ã‚ã‚‹ã“ã¨ï¼ˆåŠ£å¾Œé †ä½ï¼‰</label>
            <input id="stopDoing" placeholder="ä¾‹ï¼šå®šä¾‹ä¼šè­°ã€ç§»å‹•æ™‚é–“ã®ã‚¹ãƒãƒ›ã€ä¸è¦ãªå ±å‘Šæ›¸" />
            <div class="help">æ–°ã—ã„æ™‚é–“ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã€Œæ¨ã¦ã‚‹ã‚‚ã®ã€ã‚’æ±ºã‚ã¾ã™ã€‚</div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>æ¬¡å›ç¢ºèªæ—¥ / å ±å‘Šç›¸æ‰‹</label>
          <input id="nextCheck" placeholder="ä¾‹ï¼šæ¬¡å›å·¡å›ç›£æŸ»æ—¥ã€å¹¹éƒ¨MTGãªã©" />
          <div class="help">ã€Œã„ã¤ã€ã€Œèª°ã¨ã€æŒ¯ã‚Šè¿”ã‚‹ã‹ã‚’æ±ºã‚ã‚‹ã¨ã€å®Ÿè¡ŒåŠ›ãŒé«˜ã¾ã‚Šã¾ã™ã€‚</div>
        </div>

        <div style="margin-top:10px;">
          <label>è‡ªç”±è¨˜å…¥ï¼ˆãƒ¡ãƒ¢ï¼‰</label>
          <textarea id="freeMemo" placeholder="ä¾‹ï¼šå®Ÿæ–½æ‰‹é †ã€æ‹…å½“ã€æœŸé™ã€æƒ³å®šãƒªã‚¹ã‚¯ã¨å¯¾ç­–ãªã©"></textarea>
        </div>
      </section>

      <section class="card card-actions" aria-label="æ“ä½œ">
        <div class="action-row">
          <button id="btnCopy" class="btn" type="button">è¦ç‚¹ã‚’ã‚³ãƒ”ãƒ¼</button>
          <button id="btnPrint" class="btn" type="button">å°åˆ· / PDFä¿å­˜</button>
          <button id="btnReset" class="btn" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </section>

      <footer class="mk-mini">
        Â© <span id="cpy-year">2025</span>
        <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">ç¨ç†å£«æ³•äººæ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€</a> ï½œ 
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ï½œ 
        <a href="/tool-portal/terms.html" target="_blank" rel="noopener">åˆ©ç”¨æ¡ä»¶</a> ï½œ 
        <span id="build-rev">r14</span>ï¼ˆ<span id="last-updated-date"></span>ï¼‰
      </footer>

    </div>

    <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="ãƒ„ãƒ¼ãƒ«è¡¨ç¤º">
      <div class="modal" role="document" aria-label="ãƒ„ãƒ¼ãƒ«æœ¬ä½“">
        <div class="modalTop">
          <div class="modalTitle" id="modalTitle">ãƒ„ãƒ¼ãƒ«ã‚’è¡¨ç¤º <span>ï¼ˆåŒä¸€ç”»é¢ï¼‰</span></div>
          <div class="btns">
            <button class="btn" id="btnOpenNewTab2">åˆ¥ã‚¿ãƒ–ã§é–‹ã</button>
            <button class="btn primary" id="btnClose">é–‰ã˜ã‚‹</button>
          </div>
        </div>
        <div class="modalFrame">
          <iframe id="toolFrame" title="tool"></iframe>
        </div>
        <div class="modalHint">
          ã‚‚ã—è¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€Œåˆ¥ã‚¿ãƒ–ã§é–‹ãã€ã‚’ã”åˆ©ç”¨ãã ã•ã„ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å´/ãƒ„ãƒ¼ãƒ«å´ã®åˆ¶é™ã§åŸ‹ã‚è¾¼ã¿è¡¨ç¤ºãŒã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
    const TOOL_URLS = {
      price:  "https://takatrp.github.io/price-up-down-LP/",
      volume: "https://takatrp.github.io/hendou_PL_LP/",
      auto:   "https://takatrp.github.io/jidouka-kouka-LP/"
    };
    const TIME_UNIT_COST_URL = "https://takatrp.github.io/time-unit-cost/";

    const VOLUME_LABEL_SETS = {
      generic: {
        key:"generic",
        label:"æ±ç”¨ï¼ˆãŠã™ã™ã‚ï¼‰",
        txName:"å–å¼•",
        unitPriceLabel:"å–å¼•å˜ä¾¡ï¼ˆ1ä»¶ã‚ãŸã‚Šå£²ä¸Šï¼‰",
        unitShort:"ä»¶",
        entryLabel:"å…¥å£æ•°ï¼ˆå•ã„åˆã‚ã›/æ¥åº—/è¦‹ç© ç­‰ï¼‰",
        entryShort:"å…¥å£",
        convLabel:"æˆç´„ç‡ï¼ˆå…¥å£â†’å–å¼•ï¼‰",
        daysLabel:"ç¨¼åƒæ—¥æ•°ï¼ˆæœˆï¼‰",
        unitHelp:"ã€Œ1ä»¶ã‚ãŸã‚Šã®å£²ä¸Šã€ã§OKã§ã™ï¼ˆå®¢å˜ä¾¡/å—æ³¨å˜ä¾¡/å¥‘ç´„å˜ä¾¡/å‡ºè·å˜ä¾¡ãªã©ï¼‰ã€‚",
        entryHelp:"å…¥å£ã¯ã€å–å¼•ãŒç”Ÿã¾ã‚Œã‚‹å‰æ®µã®æ•°ã§ã™ï¼ˆå•ã„åˆã‚ã›ã€è¦‹ç©ã€å•†è«‡ã€æ¥åº—ãªã©ï¼‰ã€‚",
        convHelp:"å…¥å£ã®ã†ã¡ã€å–å¼•ã«ã¤ãªãŒã‚‹å‰²åˆï¼ˆæ¦‚ç®—ã§OKï¼‰ã€‚"
      },
      visit: {
        key:"visit",
        label:"æ¥åº—/å®¢æ•°å‹",
        txName:"è³¼å…¥",
        unitPriceLabel:"å®¢å˜ä¾¡ï¼ˆå††/äººï¼‰",
        unitShort:"äºº",
        entryLabel:"æ¥åº—æ•°ï¼ˆå…¥å£ï¼‰",
        entryShort:"æ¥åº—",
        convLabel:"è³¼å…¥ç‡ï¼ˆæ¥åº—â†’è³¼å…¥ï¼‰",
        daysLabel:"å–¶æ¥­æ—¥æ•°ï¼ˆæœˆï¼‰",
        unitHelp:"ã€Œ1äººã‚ãŸã‚Šã®å£²ä¸Šï¼ˆå®¢å˜ä¾¡ï¼‰ã€ã®ç›®å®‰ã§OKã§ã™ã€‚",
        entryHelp:"æ¥åº—æ•°ã‚’å…¥å£ã¨ã—ã¦æ‰±ã„ã¾ã™ï¼ˆå¿…è¦ãªã‚‰äºˆç´„/å•ã„åˆã‚ã›æ•°ã§ã‚‚OKï¼‰ã€‚",
        convHelp:"æ¥åº—ã®ã†ã¡è³¼å…¥ã«è‡³ã‚‹å‰²åˆï¼ˆæ¦‚ç®—ã§OKï¼‰ã€‚"
      },
      order: {
        key:"order",
        label:"å—æ³¨/æ¡ˆä»¶æ•°å‹",
        txName:"å—æ³¨",
        unitPriceLabel:"å—æ³¨å˜ä¾¡ï¼ˆå††/ä»¶ï¼‰",
        unitShort:"ä»¶",
        entryLabel:"å•†è«‡/è¦‹ç©æ•°ï¼ˆå…¥å£ï¼‰",
        entryShort:"å•†è«‡",
        convLabel:"å—æ³¨ç‡ï¼ˆå•†è«‡â†’å—æ³¨ï¼‰",
        daysLabel:"ç¨¼åƒæ—¥æ•°ï¼ˆæœˆï¼‰",
        unitHelp:"ã€Œ1ä»¶ã‚ãŸã‚Šå£²ä¸Šï¼ˆå—æ³¨å˜ä¾¡ï¼‰ã€ã®ç›®å®‰ã§OKã§ã™ã€‚",
        entryHelp:"å•†è«‡ãƒ»è¦‹ç©ãªã©ã€å—æ³¨å‰æ®µã®æ•°ã‚’å…¥å£ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚",
        convHelp:"å•†è«‡ï¼ˆå…¥å£ï¼‰ã®ã†ã¡ã€å—æ³¨ã«è‡³ã‚‹å‰²åˆï¼ˆæ¦‚ç®—ã§OKï¼‰ã€‚"
      },
      contract: {
        key:"contract",
        label:"å¥‘ç´„å‹",
        txName:"å¥‘ç´„",
        unitPriceLabel:"å¥‘ç´„å˜ä¾¡ï¼ˆå††/ä»¶ï¼‰",
        unitShort:"ä»¶",
        entryLabel:"ææ¡ˆ/ç›¸è«‡æ•°ï¼ˆå…¥å£ï¼‰",
        entryShort:"ææ¡ˆ",
        convLabel:"å¥‘ç´„ç‡ï¼ˆææ¡ˆâ†’å¥‘ç´„ï¼‰",
        daysLabel:"ç¨¼åƒæ—¥æ•°ï¼ˆæœˆï¼‰",
        unitHelp:"ã€Œ1å¥‘ç´„ã‚ãŸã‚Šã®å£²ä¸Šï¼ˆå˜ä¾¡ï¼‰ã€ã®ç›®å®‰ã§OKã§ã™ã€‚",
        entryHelp:"ææ¡ˆãƒ»ç›¸è«‡ãªã©ã€å¥‘ç´„å‰æ®µã®æ•°ã‚’å…¥å£ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚",
        convHelp:"å…¥å£ã®ã†ã¡å¥‘ç´„ã«è‡³ã‚‹å‰²åˆï¼ˆæ¦‚ç®—ã§OKï¼‰ã€‚"
      },
      shipment: {
        key:"shipment",
        label:"å‡ºè·/æ•°é‡å‹",
        txName:"å‡ºè·",
        unitPriceLabel:"å‡ºè·å˜ä¾¡ï¼ˆå††/å€‹ï¼‰",
        unitShort:"å€‹",
        entryLabel:"å¼•åˆã„æ•°ï¼ˆå…¥å£ï¼‰",
        entryShort:"å¼•åˆ",
        convLabel:"æˆç´„ç‡ï¼ˆå¼•åˆâ†’å‡ºè·ï¼‰",
        daysLabel:"ç¨¼åƒæ—¥æ•°ï¼ˆæœˆï¼‰",
        unitHelp:"ã€Œ1å€‹ã‚ãŸã‚Šã®å£²ä¸Šï¼ˆå˜ä¾¡ï¼‰ã€ã®ç›®å®‰ã§OKã§ã™ã€‚",
        entryHelp:"å¼•åˆã„ãªã©ã€å‡ºè·ã«è‡³ã‚‹å‰æ®µã®æ•°ã‚’å…¥å£ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚",
        convHelp:"å…¥å£ã®ã†ã¡ã€æˆç´„ã—ã¦å‡ºè·ã«è‡³ã‚‹å‰²åˆï¼ˆæ¦‚ç®—ã§OKï¼‰ã€‚"
      }
    };

    const RECOVERY_PRESETS = [3, 6, 12, 24];

    const KEY = "mk_action_tool_v4";
    const $ = (id)=>document.getElementById(id);

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã—ãŸå˜ä¾¡ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
    let importedUnitPrice = null;

    (function(){
      const yEl = document.getElementById("cpy-year");
      const dEl = document.getElementById("last-updated-date");
      const now = new Date();
      if (yEl) yEl.textContent = String(now.getFullYear());
      if (dEl) {
        const lm = new Date(document.lastModified);
        const pad = n => String(n).padStart(2,'0');
        dEl.textContent = `${lm.getFullYear()}-${pad(lm.getMonth()+1)}-${pad(lm.getDate())}`;
      }
    })();

    function normalizeDecimalText(s){
      return String(s ?? "")
        .trim()
        .replace(/[,ï¼Œ\s]/g,'')
        .replace(/[ãƒ»]/g,'.');
    }
    function num(v){
      const s = normalizeDecimalText(v);
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function yen(n){
      if(!Number.isFinite(n)) return "â€”";
      const r = Math.round(n);
      return "Â¥" + r.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function pct1(n){
      if(!Number.isFinite(n)) return "â€”";
      return (Math.round(n*10)/10).toString() + "%";
    }
    function ceil1(n){
      if(!Number.isFinite(n)) return "â€”";
      return (Math.ceil(n*10)/10).toString();
    }

    function showErr(id, msg){
      const el = $(id);
      if(!el) return;
      if(msg){
        el.textContent = msg;
        el.classList.add("show");
      }else{
        el.textContent = "";
        el.classList.remove("show");
      }
    }

    function formatInt(val){
      if(!val) return "";
      const s = String(val).replace(/[^\d]/g, "");
      return s.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function formatIntInput(el){
      if(!el) return; 
      const raw = String(el.value ?? "");
      const caret = (el.selectionStart ?? raw.length);
      const digitsBefore = raw.slice(0, caret).replace(/[^\d]/g, "").length;
      const digits = raw.replace(/[^\d]/g, "");
      if(digits === ""){
        el.value = "";
        return;
      }
      const formatted = digits.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      el.value = formatted;

      try{
        let newCaret = 0;
        let count = 0;
        while(newCaret < formatted.length && count < digitsBefore){
          if(/\d/.test(formatted[newCaret])) count++;
          newCaret++;
        }
        el.setSelectionRange(newCaret, newCaret);
      }catch(e){}
    }

    function formatDecimalInput(el){
      if(!el) return; 
      const raw = String(el.value ?? "");
      const caret = (el.selectionStart ?? raw.length);
      let normalized = raw.replace(/[,ï¼Œ\s]/g,'').replace(/[ãƒ»]/g,'.');
      normalized = normalized.replace(/[^\d.]/g, "");
      const parts = normalized.split(".");
      if(parts.length > 2){
        normalized = parts[0] + "." + parts.slice(1).join("");
      }
      el.value = normalized;
      try{
        const newPos = Math.min(caret, el.value.length);
        el.setSelectionRange(newPos, newPos);
      }catch(e){}
    }

    function bindLiveFormatting(root=document){
      root.querySelectorAll('input[data-format="int"]').forEach(el=>{
        if(el.dataset.boundInt === "1") return;
        el.dataset.boundInt = "1";
        el.addEventListener("input", ()=>formatIntInput(el));
        el.addEventListener("blur",  ()=>formatIntInput(el));
      });
      root.querySelectorAll('input[data-format="decimal"]').forEach(el=>{
        if(el.dataset.boundDec === "1") return;
        el.dataset.boundDec = "1";
        el.addEventListener("input", ()=>formatDecimalInput(el));
        el.addEventListener("blur",  ()=>formatDecimalInput(el));
      });
    }

    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : {};
      }catch(e){ return {}; }
    }
    function save(state){
      try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){}
    }

    let selectedRoute = "";
    let detailBuiltFor = "";
    let volumeLabelKey = "generic";
    let spendMode = "monthly";

    function volLabels(){
      return VOLUME_LABEL_SETS[volumeLabelKey] || VOLUME_LABEL_SETS.generic;
    }

    function setPressed(el, pressed){
      if(!el) return;
      el.setAttribute("aria-pressed", pressed ? "true" : "false");
    }

    function setSpendMode(mode){
      spendMode = mode;

      const ids = ["modeMonthly","modeYearly","modeOnce"];
      ids.forEach(id=>{
        const b = $(id);
        b.classList.remove("active");
        setPressed(b, false);
      });

      if(mode==="monthly"){ $("modeMonthly").classList.add("active"); setPressed($("modeMonthly"), true); }
      if(mode==="yearly"){  $("modeYearly").classList.add("active");  setPressed($("modeYearly"), true); }
      if(mode==="once"){    $("modeOnce").classList.add("active");    setPressed($("modeOnce"), true); }

      $("boxSpendMonthly").style.display = (mode==="monthly") ? "" : "none";
      $("boxSpendYearly").style.display  = (mode==="yearly")  ? "" : "none";
      $("boxSpendOnce").style.display    = (mode==="once")    ? "" : "none";

      if(mode==="once"){
        const raw = String($("recoveryMonths").value ?? "").trim();
        if(raw === ""){
          $("recoveryMonths").value = "12";
          formatIntInput($("recoveryMonths"));
        }
        syncRecoveryChipsFromInput();
      }

      render();
      persist();
    }

    function parseCmr(){
      const raw = String($("cmr").value ?? "").trim();
      if(raw === "") return { valid:false, cmrPct:NaN, cmr:NaN, raw };
      const cmrPct = num(raw);
      const valid = Number.isFinite(cmrPct) && cmrPct > 0 && cmrPct <= 100;
      return { valid, cmrPct, cmr: valid ? cmrPct/100 : NaN, raw };
    }

    function parseRecoveryMonths(){
      const raw = String($("recoveryMonths").value ?? "").trim();
      if(raw === "") return { valid:false, months:NaN, raw, reason:"æœªå…¥åŠ›" };
      const m = num(raw);
      const isInt = Number.isFinite(m) && Math.floor(m) === m;
      if(!isInt) return { valid:false, months:NaN, raw, reason:"æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„" };
      if(m < 1 || m > 120) return { valid:false, months:NaN, raw, reason:"1ã€œ120ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„" };
      return { valid:true, months:m, raw, reason:"" };
    }

    function compute(){
      const cmrInfo = parseCmr();

      const spendM = num($("spendMonthly").value);
      const spendY = num($("spendYearly").value);
      const spendO = num($("spendOnce").value);

      const annualSales = num($("annualSales").value);
      const monthlySalesAuto = (annualSales>0) ? (annualSales/12) : 0;

      let spendPerMonth = NaN;
      let recoveryInfo = { valid:true, months:NaN, raw:"", reason:"" };

      if(spendMode==="monthly"){
        spendPerMonth = (spendM>0) ? spendM : NaN;
      }else if(spendMode==="yearly"){
        spendPerMonth = (spendY>0) ? (spendY/12) : NaN;
      }else{
        recoveryInfo = parseRecoveryMonths();
        if(spendO>0 && recoveryInfo.valid){
          spendPerMonth = spendO / recoveryInfo.months;
        }else{
          spendPerMonth = NaN;
        }
      }

      const salesEqTargetM = (cmrInfo.valid && Number.isFinite(spendPerMonth)) ? (spendPerMonth / cmrInfo.cmr) : NaN;

      const salesEqAnnual = (cmrInfo.valid)
        ? (spendMode==="monthly" ? (Number.isFinite(salesEqTargetM)? salesEqTargetM*12 : NaN)
          : spendMode==="yearly" ? (spendY>0 ? (spendY / cmrInfo.cmr) : NaN)
          : NaN)
        : NaN;

      const salesEqTotal = (cmrInfo.valid && spendMode==="once" && spendO>0) ? (spendO / cmrInfo.cmr) : NaN;

      const shareY = (annualSales>0)
        ? (spendMode==="once"
            ? (Number.isFinite(salesEqTotal) ? (salesEqTotal/annualSales*100) : NaN)
            : (Number.isFinite(salesEqAnnual) ? (salesEqAnnual/annualSales*100) : NaN))
        : NaN;

      const needPricePct = (monthlySalesAuto>0 && Number.isFinite(salesEqTargetM))
        ? (salesEqTargetM/monthlySalesAuto*100)
        : NaN;

      return {
        cmrInfo,
        spendM, spendY, spendO,
        recoveryInfo,
        spendPerMonth,
        annualSales, monthlySalesAuto,
        salesEqTargetM, salesEqAnnual, salesEqTotal,
        shareY, needPricePct
      };
    }

    function buildRecoveryChips(){
      const grid = $("recoveryChipGrid");
      if(!grid) return;
      grid.innerHTML = "";
      RECOVERY_PRESETS.forEach(m=>{
        const b = document.createElement("button");
        b.type = "button";
        b.className = "avgBtn";
        b.id = "rec_" + m;
        b.textContent = `${m}ãƒ¶æœˆ`;
        setPressed(b, false);
        b.addEventListener("click", ()=>{
          $("recoveryMonths").value = String(m);
          formatIntInput($("recoveryMonths"));
          syncRecoveryChipsFromInput();
          render();
          persist();
        });
        grid.appendChild(b);
      });
      syncRecoveryChipsFromInput();
    }

    function syncRecoveryChipsFromInput(){
      const raw = String($("recoveryMonths").value ?? "").trim().replace(/[,ï¼Œ\s]/g,'');
      const v = raw ? Number(raw) : NaN;
      RECOVERY_PRESETS.forEach(m=>{
        const b = document.getElementById("rec_" + m);
        if(!b) return;
        const active = (Number.isFinite(v) && v === m);
        b.classList.toggle("active", active);
        setPressed(b, active);
      });
    }

    function buildVolumeLabelChips(container){
      const grid = document.createElement("div");
      grid.className = "avgGrid";
      Object.keys(VOLUME_LABEL_SETS).forEach(k=>{
        const item = VOLUME_LABEL_SETS[k];
        const b = document.createElement("button");
        b.type="button";
        b.className="avgBtn";
        b.dataset.vkey = item.key;
        b.textContent = item.label;
        b.classList.toggle("active", item.key===volumeLabelKey);
        setPressed(b, item.key===volumeLabelKey);

        b.addEventListener("click", ()=>{
          const keep = {
            unitPrice: $("volumeUnitPrice") ? $("volumeUnitPrice").value : "",
            convRate: $("volumeConvRate") ? $("volumeConvRate").value : "",
            days: $("volumeDays") ? $("volumeDays").value : ""
          };
          volumeLabelKey = item.key;
          detailBuiltFor = "";
          buildRouteDetailUI();
          if($("volumeUnitPrice")) $("volumeUnitPrice").value = keep.unitPrice;
          if($("volumeConvRate")) $("volumeConvRate").value = keep.convRate;
          if($("volumeDays")) $("volumeDays").value = keep.days;

          bindLiveFormatting(document);
          document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
          document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);

          updateRouteDetailKPIs();
          persist();
        });
        grid.appendChild(b);
      });
      container.appendChild(grid);
    }

    function validateStep1Errors(c){
      if(c.cmrInfo.raw !== "" && !c.cmrInfo.valid){
        showErr("cmrErr", "é™ç•Œåˆ©ç›Šç‡ã¯ 0ã€œ100 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      }else{
        showErr("cmrErr", "");
      }

      showErr("spendMonthlyErr", "");
      showErr("spendYearlyErr", "");
      showErr("spendOnceErr", "");
      if(spendMode==="monthly"){
        const raw = String($("spendMonthly").value ?? "").trim();
        if(raw !== "" && c.spendM <= 0) showErr("spendMonthlyErr", "æ”¯å‡ºé¡ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      }
      if(spendMode==="yearly"){
        const raw = String($("spendYearly").value ?? "").trim();
        if(raw !== "" && c.spendY <= 0) showErr("spendYearlyErr", "æ”¯å‡ºé¡ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      }
      if(spendMode==="once"){
        const raw = String($("spendOnce").value ?? "").trim();
        if(raw !== "" && c.spendO <= 0) showErr("spendOnceErr", "æ”¯å‡ºé¡ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

        if(c.recoveryInfo.raw !== "" && !c.recoveryInfo.valid){
          showErr("recoveryErr", c.recoveryInfo.reason || "å›åæœŸé–“ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }else{
          showErr("recoveryErr", "");
        }
      }else{
        showErr("recoveryErr", "");
      }
    }

    function buildRouteDetailUI(){
      if(!selectedRoute) return;
      if(detailBuiltFor === selectedRoute) return;

      const inputA = $("detailInputA");
      const inputB = $("detailInputB");
      const kpi = $("detailKpi");

      inputA.innerHTML = "";
      inputB.innerHTML = "";
      kpi.innerHTML = "";
      $("detailHint").textContent = "";

      if(selectedRoute === "price"){
        $("detailTitle").textContent = "å˜ä¾¡ã‚’ä¸Šã’ã‚‹ï¼ˆæ·±æ˜ã‚Šï¼‰";
        $("detailSub").textContent   = "å¹´å•†ã‹ã‚‰æœˆå•†ï¼ˆå¹´å•†Ã·12ï¼‰ã‚’è‡ªå‹•è¨ˆç®—ã—ã€æœˆã‚ãŸã‚Šå›åç›®æ¨™ã«å¯¾ã™ã‚‹å¿…è¦ãªä¸Šä¹—ã›ç‡ã®ç›®å®‰ã‚’ç¢ºèªã—ã¾ã™ã€‚";

        inputA.innerHTML = `<label>å‰æ</label><div class="help">â€»å¹´å•†ã‚’å…¥åŠ›ã—ã¦ã„ã‚‹å ´åˆã€æœˆå•†ã¯è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ï¼ˆå¹´å•†Ã·12ï¼‰ã€‚</div>`;
        inputB.innerHTML = `<label>ãƒã‚¤ãƒ³ãƒˆ</label><div class="help">å€¤ä»˜ã‘ãƒ»æä¾›ä¾¡å€¤ãƒ»å®¢å±¤ã®è¦‹ç›´ã—ã§ã€åŒã˜ç¨¼åƒã§ã‚‚åˆ©ç›Šã‚’ä½œã‚Šã‚„ã™ã„æ–¹å‘ã§ã™ã€‚</div>`;

        kpi.innerHTML = `
          <div class="k2">
            <div class="t">æœˆã‚ãŸã‚Šå›åç›®æ¨™ï¼ˆå£²ä¸Šæ›ç®—ï¼‰</div>
            <div class="v" id="kpiSalesEqM">â€”</div>
          </div>
          <div class="k2">
            <div class="t">å¿…è¦ãªä¸Šä¹—ã›ç‡ï¼ˆ%ï¼‰â€»å¹´å•†å…¥åŠ›æ™‚</div>
            <div class="v" id="kpiNeedPricePct">â€”</div>
          </div>
        `;

        $("detailHint").textContent = "æ¬¡ã«ã€ã©ã®å•†å“/å®¢å±¤/å¥‘ç´„ãŒå¯¾è±¡ã‹ã€ã€ã„ã¤ã‹ã‚‰å®Ÿæ–½ã™ã‚‹ã‹ã€ã‚’æ±ºã‚ã‚‹ã¨ã€å®Ÿè¡Œã«è½ã¡ã¾ã™ã€‚";
      }

      if(selectedRoute === "volume"){
        const L = volLabels();

        $("detailTitle").textContent = "æ•°é‡ã‚’ä¸Šã’ã‚‹ï¼ˆæ·±æ˜ã‚Šï¼‰";
        $("detailSub").textContent   = "ã€Œå–å¼•å˜ä¾¡Ã—å–å¼•æ•°ã€ã§ã€æœˆã‚ãŸã‚Šå›åç›®æ¨™ã«å¿…è¦ãªè¿½åŠ ä»¶æ•°ã¨å…¥å£æ•°ã‚’æƒãˆã¾ã™ã€‚";

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å—ã‘å–ã£ãŸå˜ä¾¡ãŒã‚ã‚Œã°åˆæœŸå€¤ã¨ã—ã¦ä½¿ç”¨
        const initUnitPrice = importedUnitPrice ? formatInt(importedUnitPrice) : "";

        inputA.innerHTML = `
          <label>å…¥åŠ›</label>

          <div class="avgWrap" style="margin-top:6px;">
            <div class="avgTitle">è¨€ã„æ›ãˆï¼ˆä»»æ„ï¼‰</div>
            <div id="volumeLabelChips"></div>
            <div class="help" style="margin-top:8px;">
              â€»ã“ã“ã¯<strong>è¨€è‘‰ã®è¨€ã„æ›ãˆ</strong>ã§ã™ã€‚è¨ˆç®—ã¯åŒã˜ã§ã™ã€‚ã¾ãšã¯ã€Œæ±ç”¨ã€ã§OKã§ã™ã€‚
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="volumeUnitPrice">${L.unitPriceLabel}</label>
            <input id="volumeUnitPrice" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š12,000" data-format="int" value="${initUnitPrice}" />
            <div class="help">${L.unitHelp}</div>
            <div class="err" id="volumeUnitPriceErr" aria-live="polite"></div>
          </div>

          <div style="margin-top:10px;">
            <label for="volumeConvRate">${L.convLabel}ï¼ˆ% / ä»»æ„ï¼‰</label>
            <input id="volumeConvRate" inputmode="decimal" pattern="[0-9.]*" placeholder="ä¾‹ï¼š30" data-format="decimal" />
            <div class="help">${L.convHelp}</div>
            <div class="err" id="volumeConvRateErr" aria-live="polite"></div>
          </div>

          <div style="margin-top:10px;">
            <label for="volumeDays">${L.daysLabel}ï¼ˆä»»æ„ï¼‰</label>
            <input id="volumeDays" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š25" data-format="int" />
            <div class="help">æ—¥å‰²ã‚Šï¼ˆ1æ—¥ã‚ãŸã‚Šå¿…è¦æ•°ï¼‰ã‚’å‡ºã—ãŸã„å ´åˆã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
            <div class="err" id="volumeDaysErr" aria-live="polite"></div>
          </div>
        `;

        inputB.innerHTML = `
          <details class="fold" open>
            <summary>æ•´ç†ã®ã—ã‹ãŸï¼ˆè¦‹æ–¹ï¼‰</summary>
            <div class="inside">
              <div class="help">
                â‘  æœˆã‚ãŸã‚Šå›åç›®æ¨™ï¼ˆå¿…è¦ãªå£²ä¸Šï¼‰ã‚’å‡ºã™ â†’ â‘¡ ${L.unitPriceLabel} ã§å‰²ã£ã¦<strong>å¿…è¦ãªè¿½åŠ ${L.txName}æ•°</strong>ã‚’å‡ºã™<br>
                â‘¢ ã•ã‚‰ã« ${L.convLabel} ã‚’ä½¿ã£ã¦<strong>${L.entryLabel}</strong>ï¼ˆå‰æ®µã®æ•°ï¼‰ã‚’ç›®å®‰ã§å‡ºã—ã¾ã™ã€‚
              </div>

              <div class="note" style="margin-top:10px;">
                æ•°é‡ã‚¢ãƒƒãƒ—ã¯ã€Œå…¥å£ã‚’å¢—ã‚„ã™ã€ã ã‘ã§ãªãã€ã€Œæˆç´„ç‡ã‚’ä¸Šã’ã‚‹ã€ã§ã‚‚å®Ÿç¾ã§ãã¾ã™ã€‚
              </div>
            </div>
          </details>
        `;

        kpi.innerHTML = `
          <div class="k2">
            <div class="t">å¿…è¦ãªè¿½åŠ ${L.txName}æ•°ï¼ˆ${L.unitShort}/æœˆï¼‰</div>
            <div class="v" id="kpiNeedTxM">â€”</div>
          </div>
          <div class="k2">
            <div class="t">å¿…è¦ãªè¿½åŠ ${L.txName}æ•°ï¼ˆ${L.unitShort}/æ—¥ï¼‰â€»æ—¥æ•°å…¥åŠ›æ™‚</div>
            <div class="v" id="kpiNeedTxD">â€”</div>
          </div>
          <div class="k2">
            <div class="t">å¿…è¦ãª${L.entryLabel}ï¼ˆ${L.entryShort}/æœˆï¼‰â€»æˆç´„ç‡å…¥åŠ›æ™‚</div>
            <div class="v" id="kpiNeedEntryM">â€”</div>
          </div>
          <div class="k2">
            <div class="t">å¿…è¦ãª${L.entryLabel}ï¼ˆ${L.entryShort}/æ—¥ï¼‰â€»æˆç´„ç‡+æ—¥æ•°å…¥åŠ›æ™‚</div>
            <div class="v" id="kpiNeedEntryD">â€”</div>
          </div>
        `;

        $("detailHint").textContent =
          "æ¬¡ã«ã€å…¥å£ã‚’å¢—ã‚„ã™ï¼ˆæ–½ç­–ï¼‰ã€ã‹ã€æˆç´„ç‡ã‚’ä¸Šã’ã‚‹ï¼ˆæ”¹å–„ï¼‰ã€ã®ã©ã¡ã‚‰ã‚’ä¸»è»¸ã«ã™ã‚‹ã‹ã‚’æ±ºã‚ã‚‹ã¨ã€å‹•ãã‚„ã™ããªã‚Šã¾ã™ã€‚";

        const mount = $("volumeLabelChips");
        if(mount){
          mount.innerHTML = "";
          buildVolumeLabelChips(mount);
        }

        bindLiveFormatting(document);

        const onVolInput = ()=>{
          updateRouteDetailKPIs();
          persist();
        };
        ["volumeUnitPrice","volumeConvRate","volumeDays"].forEach(id=>{
          if($(id)) $(id).addEventListener("input", onVolInput);
        });
      }

      if(selectedRoute === "auto"){
        $("detailTitle").textContent = "æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ã™ã‚‹ï¼ˆæ·±æ˜ã‚Šï¼‰";
        $("detailSub").textContent   = "æ”¯å‡ºï¼ˆå˜ç™ºã¯æœˆå‰²ã‚Šï¼‰ã‚’â€œå‰Šæ¸›ã§ãã‚‹æ™‚é–“â€ã«ç½®ãæ›ãˆã¦ã€å›åã®ç›®å®‰ã‚’ç¢ºèªã—ã¾ã™ã€‚";

        inputA.innerHTML = `
          <label for="hourCostInput">æ™‚é–“å˜ä¾¡ï¼ˆå†† / æ™‚ï¼‰</label>
          <input id="hourCostInput" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š3,000" data-format="int" />
          <div class="help">ç¤¾å†…ã®å®Ÿæ…‹ã«åˆã‚ã›ãŸç›®å®‰ã§OKã§ã™ï¼ˆæ¦‚ç®—ï¼‰ã€‚</div>
          <div class="err" id="hourCostErr" aria-live="polite"></div>

          <div class="avgWrap" style="margin-top:10px;">
            <div class="avgGrid" aria-label="æ™‚é–“å˜ä¾¡è¨ˆç®—ãƒ„ãƒ¼ãƒ«">
              <button type="button" class="avgBtn" id="btnTimeCostModal">æ™‚é–“å˜ä¾¡ã®è¨ˆç®—ã¯ã“ã¡ã‚‰</button>
              <button type="button" class="avgBtn" id="btnTimeCostNewTab">åˆ¥ã‚¿ãƒ–ã§é–‹ã</button>
            </div>
            <div class="help" style="margin-top:6px;">
              â€»æ™‚é–“å˜ä¾¡ãŒä¸æ˜ãªå ´åˆã«ã”åˆ©ç”¨ãã ã•ã„ã€‚
            </div>
          </div>
        `;

        inputB.innerHTML = `
          <label>ãƒã‚¤ãƒ³ãƒˆ</label>
          <div class="help">â€œç©ºã„ãŸæ™‚é–“â€ã‚’ã€å˜ä¾¡/æ•°é‡ã‚’ä¸Šã’ã‚‹æ´»å‹•ã¸ç§»ã™ã“ã¨ã§åŠ¹æœãŒå¤§ãããªã‚Šã¾ã™ã€‚</div>
        `;

        kpi.innerHTML = `
          <div class="k2">
            <div class="t">æœˆã‚ãŸã‚Šã®æ”¯å‡ºï¼ˆå˜ç™ºã¯æœˆå‰²ã‚Šï¼‰</div>
            <div class="v" id="kpiSpendMonthlyEq">â€”</div>
          </div>
          <div class="k2">
            <div class="t">å›åã«å¿…è¦ãªå‰Šæ¸›æ™‚é–“ï¼ˆh / æœˆï¼‰</div>
            <div class="v" id="kpiNeedHours">â€”</div>
          </div>
        `;

        $("detailHint").textContent = "ã€ã©ã®ä½œæ¥­ã‚’å‰Šã‚‹ã‹ã€ã€é‹ç”¨ãƒ«ãƒ¼ãƒ«ã€ã¾ã§æ±ºã‚ã‚‹ã¨ã€å†ç¾æ€§ãŒå‡ºã¾ã™ã€‚";

        bindLiveFormatting(document);
        if($("hourCostInput")){
          $("hourCostInput").addEventListener("input", ()=>{
            updateRouteDetailKPIs();
            persist();
          });

          $("hourCostInput").addEventListener("input", ()=>{
            const raw = String($("hourCostInput").value ?? "").trim();
            const v = num(raw);
            if(raw !== "" && v <= 0) showErr("hourCostErr", "æ™‚é–“å˜ä¾¡ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            else showErr("hourCostErr", "");
          });
        }

        const b1 = $("btnTimeCostModal");
        const b2 = $("btnTimeCostNewTab");
        if(b1){
          b1.addEventListener("click", ()=>{
            openModal("æ™‚é–“å˜ä¾¡ã®è¨ˆç®—", TIME_UNIT_COST_URL);
          });
        }
        if(b2){
          b2.addEventListener("click", ()=>{
            window.open(TIME_UNIT_COST_URL, "_blank", "noopener,noreferrer");
          });
        }
      }

      detailBuiltFor = selectedRoute;
    }

    function updateRouteDetailKPIs(){
      if(!selectedRoute) return;
      const c = compute();

      if($("kpiSalesEqM")) {
        $("kpiSalesEqM").textContent = Number.isFinite(c.salesEqTargetM) ? yen(c.salesEqTargetM) : "æ”¯å‡ºé¡ã¨é™ç•Œåˆ©ç›Šç‡ã‚’å…¥åŠ›";
        if(!Number.isFinite(c.salesEqTargetM)) $("kpiSalesEqM").classList.add("small");
        else $("kpiSalesEqM").classList.remove("small");
      }

      if(selectedRoute === "price"){
        if($("kpiNeedPricePct")){
          if(c.annualSales>0 && Number.isFinite(c.needPricePct)){
            $("kpiNeedPricePct").textContent = pct1(c.needPricePct);
            $("kpiNeedPricePct").classList.remove("small");
          }else{
            $("kpiNeedPricePct").textContent = "å¹´å•†ã‚’å…¥åŠ›ã™ã‚‹ã¨è¡¨ç¤º";
            $("kpiNeedPricePct").classList.add("small");
          }
        }
      }

      if(selectedRoute === "volume"){
        const L = volLabels();
        const unitRaw = $("volumeUnitPrice") ? String($("volumeUnitPrice").value ?? "").trim() : "";
        const unitPrice = $("volumeUnitPrice") ? num($("volumeUnitPrice").value) : 0;

        const convRaw = $("volumeConvRate") ? String($("volumeConvRate").value ?? "").trim() : "";
        const convRate = $("volumeConvRate") ? num($("volumeConvRate").value) : 0;

        const daysRaw = $("volumeDays") ? String($("volumeDays").value ?? "").trim() : "";
        const days = $("volumeDays") ? num($("volumeDays").value) : 0;

        if($("volumeUnitPriceErr")){
          if(unitRaw !== "" && unitPrice <= 0) showErr("volumeUnitPriceErr", "å˜ä¾¡ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          else showErr("volumeUnitPriceErr", "");
        }
        if($("volumeConvRateErr")){
          if(convRaw !== "" && !(convRate>0 && convRate<=100)) showErr("volumeConvRateErr", "æˆç´„ç‡ã¯ 0ã€œ100 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          else showErr("volumeConvRateErr", "");
        }
        if($("volumeDaysErr")){
          if(daysRaw !== "" && days <= 0) showErr("volumeDaysErr", "æ—¥æ•°ã¯ 0 ã‚ˆã‚Šå¤§ãã„æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          else showErr("volumeDaysErr", "");
        }

        const canBase = (unitPrice>0 && Number.isFinite(c.salesEqTargetM));
        const needTxM = canBase ? (c.salesEqTargetM / unitPrice) : NaN;
        const needTxD = (days>0 && Number.isFinite(needTxM)) ? (needTxM / days) : NaN;

        const canEntry = (convRate>0 && convRate<=100 && Number.isFinite(needTxM));
        const needEntryM = canEntry ? (needTxM / (convRate/100)) : NaN;
        const needEntryD = (days>0 && Number.isFinite(needEntryM)) ? (needEntryM / days) : NaN;

        function setVal(id, txt, small){
          const el = $(id);
          if(!el) return;
          el.textContent = txt;
          el.classList.toggle("small", !!small);
        }

        if(!canBase){
          setVal("kpiNeedTxM", "å˜ä¾¡ã¨å›åç›®æ¨™ã‚’å…¥åŠ›", true);
          setVal("kpiNeedTxD", "æ—¥æ•°ã‚’å…¥ã‚Œã‚‹ã¨è¡¨ç¤º", true);
          setVal("kpiNeedEntryM", "æˆç´„ç‡ã‚’å…¥ã‚Œã‚‹ã¨è¡¨ç¤º", true);
          setVal("kpiNeedEntryD", "æˆç´„ç‡+æ—¥æ•°ã§è¡¨ç¤º", true);
        }else{
          setVal("kpiNeedTxM", (ceil1(needTxM) + " " + L.unitShort + "/æœˆ"), false);
          setVal("kpiNeedTxD", Number.isFinite(needTxD) ? (ceil1(needTxD) + " " + L.unitShort + "/æ—¥") : "æ—¥æ•°ã‚’å…¥ã‚Œã‚‹ã¨è¡¨ç¤º", !Number.isFinite(needTxD));
          setVal("kpiNeedEntryM", Number.isFinite(needEntryM) ? (ceil1(needEntryM) + " " + L.entryShort + "/æœˆ") : "æˆç´„ç‡ã‚’å…¥ã‚Œã‚‹ã¨è¡¨ç¤º", !Number.isFinite(needEntryM));
          setVal("kpiNeedEntryD", Number.isFinite(needEntryD) ? (ceil1(needEntryD) + " " + L.entryShort + "/æ—¥") : "æˆç´„ç‡+æ—¥æ•°ã§è¡¨ç¤º", !Number.isFinite(needEntryD));
        }
      }

      if(selectedRoute === "auto"){
        const hourRaw = $("hourCostInput") ? String($("hourCostInput").value ?? "").trim() : "";
        const hour = $("hourCostInput") ? num($("hourCostInput").value) : 0;
        const needHours = (hour>0 && Number.isFinite(c.spendPerMonth)) ? (c.spendPerMonth/hour) : NaN;

        if($("kpiSpendMonthlyEq")){
          $("kpiSpendMonthlyEq").textContent = Number.isFinite(c.spendPerMonth) ? yen(c.spendPerMonth) : "æ”¯å‡ºé¡ï¼ˆå˜ç™ºã¯å›åæœŸé–“ï¼‰ã‚’å…¥åŠ›";
          $("kpiSpendMonthlyEq").classList.toggle("small", !Number.isFinite(c.spendPerMonth));
        }

        if($("kpiNeedHours")){
          if(Number.isFinite(needHours)){
            $("kpiNeedHours").textContent = (ceil1(needHours)+" h/æœˆ");
            $("kpiNeedHours").classList.remove("small");
          }else{
            $("kpiNeedHours").textContent = (hourRaw ? "æ”¯å‡ºé¡ã‚’å…¥åŠ›" : "æ™‚é–“å˜ä¾¡ã‚’å…¥åŠ›");
            $("kpiNeedHours").classList.add("small");
          }
        }
      }
    }

    function setRoute(route){
      selectedRoute = route || "";

      if(!selectedRoute){
        $("routeChooser").style.display = "grid";
        $("routeDetail").style.display = "none";
        detailBuiltFor = "";
        persist();
        return;
      }

      $("routeChooser").style.display = "none";
      $("routeDetail").style.display = "block";

      if(route){
        setTimeout(() => {
          const box = $("routeDetail");
          if(!box) return;
          const y = box.getBoundingClientRect().top + window.scrollY - 70;
          window.scrollTo({ top: y, behavior: "smooth" });
        }, 50);
      }

      buildRouteDetailUI();
      updateRouteDetailKPIs();
      persist();
    }

    function render(){
      const c = compute();
      validateStep1Errors(c);

      $("monthlySalesAuto").value = (c.annualSales>0) ? yen(c.monthlySalesAuto) : "";

      if(spendMode==="once"){
        $("spendMonthlyEqAuto").value = Number.isFinite(c.spendPerMonth) ? yen(c.spendPerMonth) : "â€”";
        syncRecoveryChipsFromInput();
      }else{
        $("spendMonthlyEqAuto").value = "";
      }

      if(spendMode==="monthly" || spendMode==="yearly"){
        $("kpiT1").textContent = "å£²ä¸Šæ›ç®—é¡ï¼ˆå†† / æœˆï¼‰";
        $("kpiT2").textContent = "å£²ä¸Šæ›ç®—é¡ï¼ˆå†† / å¹´ï¼‰";

        if(Number.isFinite(c.salesEqTargetM)){
          $("salesEqM").textContent = yen(c.salesEqTargetM);
          $("salesEqM").classList.remove("small");
        }else{
          $("salesEqM").textContent = "æ”¯å‡ºé¡ã¨é™ç•Œåˆ©ç›Šç‡ã‚’å…¥åŠ›";
          $("salesEqM").classList.add("small");
        }

        if(Number.isFinite(c.salesEqAnnual)){
          $("salesEqY").textContent = yen(c.salesEqAnnual);
          $("salesEqY").classList.remove("small");
        }else{
          $("salesEqY").textContent = "æ”¯å‡ºé¡ã¨é™ç•Œåˆ©ç›Šç‡ã‚’å…¥åŠ›";
          $("salesEqY").classList.add("small");
        }
      }

      if(spendMode==="once"){
        $("kpiT1").textContent = "å£²ä¸Šæ›ç®—é¡ï¼ˆç·é¡ï¼‰";
        $("kpiT2").textContent = "å›åç›®æ¨™ï¼ˆå†† / æœˆï¼‰";

        if(Number.isFinite(c.salesEqTotal)){
          $("salesEqM").textContent = yen(c.salesEqTotal);
          $("salesEqM").classList.remove("small");
        }else{
          $("salesEqM").textContent = "æ”¯å‡ºé¡ã¨é™ç•Œåˆ©ç›Šç‡ã‚’å…¥åŠ›";
          $("salesEqM").classList.add("small");
        }

        if(Number.isFinite(c.salesEqTargetM)){
          $("salesEqY").textContent = yen(c.salesEqTargetM);
          $("salesEqY").classList.remove("small");
        }else{
          const rmRaw = String($("recoveryMonths").value ?? "").trim();
          $("salesEqY").textContent = (rmRaw === "") ? "å›åæœŸé–“ã‚’å…¥åŠ›" : "æ”¯å‡ºé¡ã¨é™ç•Œåˆ©ç›Šç‡ã‚’å…¥åŠ›";
          $("salesEqY").classList.add("small");
        }
      }

      if(Number.isFinite(c.shareY)){
        $("shareY").textContent = pct1(c.shareY);
        $("shareY").classList.remove("small");
      }else{
        if(c.annualSales>0){
          $("shareY").textContent = "å…¥åŠ›å€¤ã‚’ç¢ºèª";
        }else{
          $("shareY").textContent = "å¹´å•†ã‚’å…¥åŠ›ã™ã‚‹ã¨è¡¨ç¤º";
        }
        $("shareY").classList.add("small");
      }

      $("selectedRouteLabel").value = 
        selectedRoute==="price" ? "å˜ä¾¡ã‚’ä¸Šã’ã‚‹" :
        selectedRoute==="volume" ? "æ•°é‡ã‚’ä¸Šã’ã‚‹" :
        selectedRoute==="auto" ? "æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ï¼ˆæ™‚é–“å‰µå‡ºï¼‰" :
        "ï¼ˆæœªé¸æŠï¼‰";

      if(selectedRoute){
        buildRouteDetailUI();
        updateRouteDetailKPIs();
      }

      persist();
    }

    // â–¼ è¿½åŠ ï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å€¤ã‚’å—ã‘å–ã‚‹å‡¦ç†
    function checkUrlParams(){
      const params = new URLSearchParams(window.location.search);
      const p_spend = params.get('spend');     // æ”¯å‡ºé¡
      const p_cmr = params.get('cmr');         // é™ç•Œåˆ©ç›Šç‡
      const p_sales = params.get('sales');     // å¹´å•†
      const p_mode = params.get('mode');       // é »åº¦ (monthly, yearly, once)
      const p_unit = params.get('unit_price'); // å¹³å‡å˜ä¾¡ (convert-to-salesç”¨)

      let changed = false;

      // ãƒ¢ãƒ¼ãƒ‰æŒ‡å®šãŒã‚ã‚Œã°åˆ‡ã‚Šæ›¿ãˆ
      if(p_mode && ["monthly","yearly","once"].includes(p_mode)){
        setSpendMode(p_mode);
        changed = true;
      }

      // æ”¯å‡ºé¡
      if(p_spend){
        const v = normalizeDecimalText(p_spend); // ã¾ãšæ•°å€¤ã‚’æ­£è¦åŒ–
        // â˜…é‡è¦: formatIntã‚’é€šã—ã¦ã‹ã‚‰ã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨ã§ã€æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ã«ã™ã‚‹
        const fmtV = formatInt(v);
        
        if(spendMode === "monthly") $("spendMonthly").value = fmtV;
        if(spendMode === "yearly")  $("spendYearly").value = fmtV;
        if(spendMode === "once")    $("spendOnce").value = fmtV;
        changed = true;
      }

      // é™ç•Œåˆ©ç›Šç‡
      if(p_cmr){
        $("cmr").value = normalizeDecimalText(p_cmr);
        changed = true;
      }

      // å¹´å•†
      if(p_sales){
        const v = normalizeDecimalText(p_sales);
        $("annualSales").value = formatInt(v); // â˜…ã“ã“ã‚‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        changed = true;
      }

      // å¹³å‡å˜ä¾¡ (Step 2ã§ä½¿ã†ãŸã‚å¤‰æ•°ã«ä¿æŒ)
      if(p_unit){
        importedUnitPrice = normalizeDecimalText(p_unit);
      }

      if(changed){
        // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ•´å½¢ã¨å†è¨ˆç®—ã‚’å®Ÿè¡Œ
        bindLiveFormatting(document);
        document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
        document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);
        
        // Step1ã‚’é–‹ã„ãŸçŠ¶æ…‹ã§è¦‹ã›ã‚‹ãŸã‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®èª¿æ•´ï¼ˆä»»æ„ï¼‰
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        render();
        persist(); // ä¿å­˜ã—ã¦ã€ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚æ¶ˆãˆãªã„ã‚ˆã†ã«ã™ã‚‹
        
        // URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¶ˆã™ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ™‚ã®èª¤å‹•ä½œé˜²æ­¢ï¼šä»»æ„ï¼‰
        const url = new URL(window.location);
        url.search = "";
        window.history.replaceState({}, '', url);
      }
    }

    // â˜…é‡è¦: HTMLã®onclickå±æ€§ã‚’å»ƒæ­¢ã—ã€JSã§ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š (ä¿®æ­£r13)
    document.querySelectorAll('.bigCard').forEach(card => {
      card.addEventListener('click', (e) => {
        // ãƒœã‚¿ãƒ³è‡ªä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã«ä»»ã›ã‚‹ï¼‰
        if(e.target.tagName === 'BUTTON') return;
        
        // ã‚«ãƒ¼ãƒ‰ã® data-target å±æ€§ã‚’å–å¾—ã—ã¦ãƒ«ãƒ¼ãƒˆè¨­å®š
        const target = card.getAttribute('data-target');
        if(target){
          setRoute(target);
          render();
        }
      });
    });

    bindLiveFormatting(document);
    buildRecoveryChips();

    $("modeMonthly").addEventListener("click", ()=>setSpendMode("monthly"));
    $("modeYearly").addEventListener("click",  ()=>setSpendMode("yearly"));
    $("modeOnce").addEventListener("click",    ()=>setSpendMode("once"));

    setSpendMode("monthly");

    const st = load();
    restore(st);

    bindLiveFormatting(document);
    document.querySelectorAll('input[data-format="int"]').forEach(formatIntInput);
    document.querySelectorAll('input[data-format="decimal"]').forEach(formatDecimalInput);

    // Watch all inputs for Step 3 persistence
    [
      "spendMonthly","spendYearly","spendOnce","recoveryMonths","cmr","annualSales",
      "targetScope","checkKpi","targetGoal","firstAction","stopDoing","nextCheck","freeMemo"
    ].forEach(id=>{
      if($(id)){
        $(id).addEventListener("input", ()=>{
          if(id==="recoveryMonths") syncRecoveryChipsFromInput();
          render();
        });
      }
    });

    document.querySelectorAll("[data-pick]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const r = btn.getAttribute("data-pick");
        setRoute(r);
        render();
      });
    });
    $("btnBack").addEventListener("click", ()=>{ setRoute(""); render(); });

    $("btnOpenTool").addEventListener("click", ()=>{
      const url = getToolUrl();
      if(!url){ alert("ãƒ„ãƒ¼ãƒ«URLãŒæœªè¨­å®šã§ã™ã€‚"); return; }
      openModal(getToolTitle(), url);
    });
    $("btnOpenToolNewTab").addEventListener("click", ()=>{
      const url = getToolUrl();
      if(!url){ alert("ãƒ„ãƒ¼ãƒ«URLãŒæœªè¨­å®šã§ã™ã€‚"); return; }
      window.open(url, "_blank", "noopener,noreferrer");
    });
    $("btnClose").addEventListener("click", closeModal);
    $("modalBack").addEventListener("click", (e)=>{ if(e.target === $("modalBack")) closeModal(); });
    $("btnOpenNewTab2").addEventListener("click", ()=>{ if(currentUrl) window.open(currentUrl, "_blank", "noopener,noreferrer"); });

    $("btnPrint").addEventListener("click", ()=>window.print());

    $("btnCopy").addEventListener("click", async ()=>{
      const c = compute();
      const routeLabel = 
        selectedRoute==="price" ? "å˜ä¾¡ã‚’ä¸Šã’ã‚‹" :
        selectedRoute==="volume" ? "æ•°é‡ã‚’ä¸Šã’ã‚‹" :
        selectedRoute==="auto" ? "æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ã™ã‚‹" :
        "ï¼ˆæœªé¸æŠï¼‰";

      let spendLine = "";
      if(spendMode==="monthly"){
        spendLine = `ãƒ»æ”¯å‡ºï¼ˆæœˆï¼‰ï¼š${yen(c.spendM)}`;
      }else if(spendMode==="yearly"){
        spendLine = `ãƒ»æ”¯å‡ºï¼ˆå¹´ï¼‰ï¼š${yen(c.spendY)}`;
      }else{
        const rm = String($("recoveryMonths").value ?? "").trim();
        const rmDisp = rm ? rm : "â€”";
        spendLine = `ãƒ»æ”¯å‡ºï¼ˆå˜ç™ºï¼‰ï¼š${yen(c.spendO)}ï¼å›åæœŸé–“ï¼š${rmDisp}ãƒ¶æœˆï¼ˆæœˆå‰²ã‚Š ${Number.isFinite(c.spendPerMonth)?yen(c.spendPerMonth):"â€”"}ï¼‰`;
      }

      const cmrDisp = $("cmr").value ? ($("cmr").value + "%") : "â€”";

      let eqLine = "";
      if(spendMode==="once"){
        eqLine = `ãƒ»å£²ä¸Šæ›ç®—ï¼ˆç·é¡ï¼‰ï¼š${Number.isFinite(c.salesEqTotal)?yen(c.salesEqTotal):"â€”"}ï¼å›åç›®æ¨™ï¼ˆæœˆï¼‰ï¼š${Number.isFinite(c.salesEqTargetM)?yen(c.salesEqTargetM):"â€”"}`;
      }else{
        eqLine = `ãƒ»å£²ä¸Šæ›ç®—ï¼ˆæœˆï¼‰ï¼š${Number.isFinite(c.salesEqTargetM)?yen(c.salesEqTargetM):"â€”"}ï¼ï¼ˆå¹´ï¼‰ï¼š${Number.isFinite(c.salesEqAnnual)?yen(c.salesEqAnnual):"â€”"}`;
      }

      let routeDetail = "";
      if(selectedRoute==="price"){
        routeDetail = `ãƒ»å¿…è¦ãªä¸Šä¹—ã›ç‡ï¼ˆ%ï¼‰â€»å¹´å•†å…¥åŠ›æ™‚ï¼š${Number.isFinite(c.needPricePct)?pct1(c.needPricePct):"â€”"}`;
      }
      if(selectedRoute==="volume"){
        const L = volLabels();
        const unitPrice = $("volumeUnitPrice") ? num($("volumeUnitPrice").value) : 0;
        const convRate = $("volumeConvRate") ? num($("volumeConvRate").value) : 0;
        const needTxM = (unitPrice>0 && Number.isFinite(c.salesEqTargetM)) ? (c.salesEqTargetM / unitPrice) : NaN;
        const needEntryM = (convRate>0 && convRate<=100 && Number.isFinite(needTxM)) ? (needTxM / (convRate/100)) : NaN;

        routeDetail = 
`ãƒ»${L.unitPriceLabel}ï¼š${unitPrice?yen(unitPrice):"â€”"}
ãƒ»${L.convLabel}ï¼š${$("volumeConvRate") && $("volumeConvRate").value ? ($("volumeConvRate").value+"%") : "â€”"}
ãƒ»å¿…è¦ãªè¿½åŠ ${L.txName}æ•°ï¼š${Number.isFinite(needTxM)?(ceil1(needTxM)+" "+L.unitShort+"/æœˆ"):"â€”"}
ãƒ»å¿…è¦ãª${L.entryLabel}ï¼š${Number.isFinite(needEntryM)?(ceil1(needEntryM)+" "+L.entryShort+"/æœˆ"):"â€”"}`;
      }
      if(selectedRoute==="auto"){
        const hour = $("hourCostInput") ? num($("hourCostInput").value) : 0;
        const needHours = (hour>0 && Number.isFinite(c.spendPerMonth)) ? (c.spendPerMonth/hour) : NaN;
        routeDetail = `ãƒ»æ™‚é–“å˜ä¾¡ï¼š${hour?yen(hour):"â€”"}ï¼å›åã«å¿…è¦ãªå‰Šæ¸›æ™‚é–“ï¼š${Number.isFinite(needHours)?(ceil1(needHours)+" h/æœˆ"):"â€”"}`;
      }

      const text = 
`ã€æ‰“ã¡æ‰‹æ¤œè¨ï¼ˆæ¦‚ç®—ï¼‰ã€‘
â– 1. å£²ä¸Šæ›ç®—
${spendLine}
ãƒ»é™ç•Œåˆ©ç›Šç‡ï¼š${cmrDisp}
${eqLine}
ãƒ»å¹´å•†æ¯”ï¼š${Number.isFinite(c.shareY)?pct1(c.shareY):"â€”"}
ãƒ»æœˆå•†ï¼ˆå¹´å•†Ã·12ï¼‰ï¼š${c.annualSales>0 ? yen(c.monthlySalesAuto) : "â€”"}

â– 2. æ‰“ã¡æ‰‹
ãƒ»é¸æŠï¼š${routeLabel}
${routeDetail ? routeDetail : ""}

â– 3. æ¬¡ã®ä¸€æ‰‹
ãƒ»å¯¾è±¡ï¼š${$("targetScope").value || "â€”"}
ãƒ»ç›®æ¨™æˆæœï¼š${$("targetGoal").value || "â€”"}
ãƒ»ç¢ºèªæŒ‡æ¨™ï¼š${$("checkKpi").value || "â€”"}
ãƒ»æœ€åˆã®ä¸€æ­©ï¼š${$("firstAction").value || "â€”"}
ãƒ»ã‚„ã‚ã‚‹ã“ã¨ï¼š${$("stopDoing").value || "â€”"}
ãƒ»æ¬¡å›ç¢ºèªï¼š${$("nextCheck").value || "â€”"}
ãƒ»ãƒ¡ãƒ¢ï¼š${$("freeMemo").value || "â€”"}`;

      try{
        await navigator.clipboard.writeText(text);
        const b = $("btnCopy"); const old = b.textContent;
        b.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
        setTimeout(()=>b.textContent=old, 900);
      }catch(e){
        alert("ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¿…è¦ãªã‚‰ç”»é¢ã®æ•°å€¤ã‚’ãã®ã¾ã¾ã”åˆ©ç”¨ãã ã•ã„ã€‚");
      }
    });

    $("btnReset").addEventListener("click", doReset);
    $("btnResetTop").addEventListener("click", doReset);

    // èµ·å‹•æ™‚ã«URLãƒã‚§ãƒƒã‚¯
    checkUrlParams();

    render();
  </script>
</body>
</html>
